---
title: "Malware Scoring"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(plyr)

library(data.table)
library(stringi)
library(stringr)
library(ggplot2)
library(gridExtra)
library(zip)
library(corrplot)
library(forcats)
#library(pdp)
library(e1071)
library(jsonlite)
library(lubridate)

library(gbm)
library(randomForestSRC)
library(xgboost)
library(lightgbm)

#library(rjson)
#library(caret)

#working_folder = 'C:/Dev/Kaggle/'
working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')


source(file.path(working_folder, '/Utils/common.R'))
```

## Loan Data

```{r load_data}

# read the files -----------
df_train = fread(file.path(working_folder,'malware_scoring/data/train.csv'), check.names=T, nrows = 100000)#, nrows = 10000)
df_test  = fread(file.path(working_folder,'malware_scoring/data/test.csv'),  check.names=T)

#shuffle and save
#fwrite(df_train[sample(nrow(df_train)),], file.path(working_folder,'malware_scoring/data/train_shuffled.csv'))

df_train[,is_train:=TRUE ] #8921483
df_test[, is_train:=FALSE] #7853253
df_test[, HasDetections := 0]

df = rbind(df_train, df_test)

rm(list = c('df_train', 'df_test')) 


# process the data-----------
id_columns =c('MachineIdentifier', 'AVProductStatesIdentifier','AvSigVersion')

train_index = df$is_train

df[, AVProductsEnabled_pct := AVProductsEnabled/AVProductsInstalled]
df[, Census_PrimaryDiskTotalCapacity_log:= log(Census_PrimaryDiskTotalCapacity + 1)]
df[is.na(AVProductsEnabled_pct), AVProductsEnabled_pct := NA]

identifier_columns =  names(df)[grepl('Identifier', names(df))] %!in_set% id_columns
df[, (identifier_columns):=lapply(.SD, factor), .SDcols = identifier_columns]

char_columns = names(which(lapply(df, is.character) ==TRUE)) %!in_set% id_columns
df[, (char_columns):=lapply(.SD, as.factor), .SDcols = char_columns]


gc(reset=TRUE)
```

## View Data

```{r view_data}
table(df[,.(is_train, ProductName)]) #win8defender, mse
table(df[,.(is_train, HasDetections)])
table(df[,.(is_train, AVProductsInstalled)])
table(df[,.(is_train, AVProductsEnabled)])
table(df[,.(is_train, AVProductStatesIdentifier)])
table(df[,.(is_train, Census_ProcessorManufacturerIdentifier)])
table(df[,.(is_train, Census_IsVirtualDevice)])
table(df[,.(is_train, Census_IsAlwaysOnAlwaysConnectedCapable)])
table(df[,.(is_train, Wdft_IsGamer)])
table(df[,.(is_train, Census_IsFlightsDisabled)]) #very few levels
#Census_TotalPhysicalRAM

actual = df$HasDetections[train_index]
model  = df$HasDetections[train_index]

num_columns = names(which(lapply(df, is.numeric) ==TRUE)) %!in_set% id_columns

plots = llply(num_columns, function(var_name) {
   p = plot_profile(model, actual, df[[var_name]][train_index], error_band = 'binom') + 
     ggtitle(var_name) +  theme(title =element_text(size=6))
   return(p)
})
marrangeGrob(plots, nrow = 6, ncol = 7, top = NULL)

```

## GBM Model
Census_IsFlightsDisabled - very few levels
```{r gbm_model}
tindex = df$is_train

obj_var = 'HasDetections'
actual = df[[obj_var]]

all_vars = c('AVProductsInstalled', 'AVProductsEnabled_pct', 'SMode', 'Census_IsVirtualDevice', 'Census_IsAlwaysOnAlwaysConnectedCapable', 
             'Wdft_IsGamer')
all_vars = names(df) %!in_set% c(id_columns, 'is_train',obj_var,
                                 'CityIdentifier','Census_OEMNameIdentifier', 'Census_OEMModelIdentifier', 'Census_ProcessorModelIdentifier','Census_FirmwareVersionIdentifier',
                                 'DefaultBrowsersIdentifier')

set.seed(1012356)

formula.gbm = formula(stri_join( obj_var, ' ~ ', stri_join(unique(all_vars), collapse = ' + ')))

model_vars = all.vars(formula.gbm) %!in_set% c(obj_var)
var.monotone = rep(0, length(model_vars))

#num_vars  = model_vars %in_set% names(which(sapply(df, is.numeric)))
#corr_matrix = cor(df[, ..num_vars ], use="complete.obs")
#corrplot(corr_matrix, method="number", number.cex = 0.5)
#corrplot(corr_matrix, method="circle", order="hclust")

mon_inc_vars = c()
mon_dec_vars = c()

var.monotone[model_vars %in% mon_inc_vars]  =  1
var.monotone[model_vars %in% mon_dec_vars]  = -1

max_it = 500

model.gbm  = gbm(formula.gbm,
                 distribution = "bernoulli",
                 n.trees = max_it,
                 cv.folds = 0,
                 shrinkage = 0.01,
                 interaction.depth=7,
                 train.fraction = 0.5,
                 bag.fraction = 0.9,# 0.5 for small samples, 0.7 for large
                 n.cores = 2,
                 var.monotone = var.monotone,
                 data = df[tindex , all.vars(formula.gbm), with = F],
                 verbose = TRUE)

#saveRDS(model.pd, file.path(working_folder,'malware_scoring/model_gbm.v1.rds'))
#model.pd = readRDS(file.path(working_folder,'malware_scoring/model_gbm.v1.rds'))

plot_gbmiterations(model.gbm)

best_it.gbm = gbm.perf(model.gbm, plot.it = F)

pred.gbm  = predict(model.gbm, n.trees = best_it.gbm, newdata = df, type = 'response')
plot_binmodel_roc(actual[tindex], pred.gbm[tindex])
plot_binmodel_percentiles(actual[tindex], pred.gbm[tindex], 100)
gbm.roc.area(actual[tindex], pred.gbm[tindex]) #0.7221436

#influence
var_inf = summary(model.gbm, n.trees = best_it.gbm, plotit = F)
var_inf = subset(var_inf, rel.inf>0.01)
#fwrite(var_inf, file = file.path(working_folder, "gstore/variables.csv"), row.names = FALSE)
plot_gbminfluence(var_inf)
print(var_inf)

imp_vars = as.character(var_inf$var[var_inf$rel.inf>0.1])
#df_agg[1:100,..imp_vars]

plots = plot_gbmpartial(model.gbm, best_it.gbm, imp_vars, output_type = 'response')
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)

plots = llply(all.vars(formula.gbm), function(var_name) {
  p = plot_profile(pred.gbm[tindex], actual[tindex],df[[var_name]][tindex], error_band = 'binom') +
    ggtitle(var_name) +  theme(title =element_text(size=6))
  return( p )
})
marrangeGrob(plots, nrow = 5, ncol = 7, top = NULL)

#all vars
plots = llply(names(df) %!in_set% c(id_columns, all.vars(formula.pd)), function(var_name) {
  #print(var_name)
  p = plot_profile(pred.gbm[tindex], actual[tindex],df[[var_name]][tindex], error_band = 'binom') +
    ggtitle(var_name) +  theme(title =element_text(size=6))
  return( p )
})
marrangeGrob(plots, nrow = 6, ncol = 6, top = NULL)

plot_profile(pred.gbm[tindex], actual[tindex],df$SmartScreen[tindex], error_band = 'binom')
plot_profile(pred.gbm[tindex], actual[tindex],fct_reorder(df$CountryIdentifier[tindex], actual[tindex], sum), error_band = 'binom')
plot_profile(pred.gbm[tindex], actual[tindex],df$CityIdentifier[tindex], error_band = 'binom')
plot_profile(pred.gbm[tindex], actual[tindex],df$CountryIdentifier[tindex], error_band = 'binom')
plot_profile(pred.gbm[tindex], actual[tindex],df$OrganizationIdentifier[tindex], error_band = 'binom')

#plot_profile(pred.pd[tindex], actual.pd[tindex],fct_reorder(df$geo_country[tindex],actual.pd[tindex], sum), error_band = 'binom')
```


## Light GBM Model

```{r gbm_model}
library(Matrix)
#library(MLmetrics)

all_vars = names(df) %!in_set% c(id_columns, 'is_train',obj_var,
                                 'CityIdentifier','Census_OEMNameIdentifier', 'Census_OEMModelIdentifier', 'Census_ProcessorModelIdentifier','Census_FirmwareVersionIdentifier',
                                 'DefaultBrowsersIdentifier')

train_sparse = Matrix(as.matrix(df[is_train == TRUE , all_vars, with=F]), sparse=TRUE)

cat_vars = (names(which(lapply(df, is.factor) ==TRUE)) %!in_set% id_columns) %in_set% all_vars


lgb.train = lgb.Dataset(data=train_sparse, label=df[is_train == TRUE, ][[obj_var]], 
                        colnames = all_vars,
                        categorical_feature = cat_vars)


#params https://sites.google.com/view/lauraepp/parameters
lgb.grid = list(objective = "binary",
                metric = "auc",
                min_sum_hessian_in_leaf = 1,
                feature_fraction = 0.8,
                bagging_fraction = 0.8,
                is_unbalance = TRUE)

lgb.auc = function(preds, dtrain){
  actual = getinfo(dtrain, "label")
  score  = gbm.roc.area(actual, preds)
  return(list(name = "auc", value = score, higher_better = TRUE))
}

#cross validation
lgb.model.cv = lgb.cv(params = lgb.grid, data = lgb.train, 
                      learning_rate = 0.02, 
                      num_leaves = 25,
                      num_threads = 2 , 
                      nrounds = 7000, 
                      early_stopping_rounds = 50,
                      eval_freq = 20, eval = lgb.auc, nfold = 5, stratified = TRUE)

best.iter = lgb.model.cv$best_iter
#best.iter = 603

lgb.model = lgb.train(params = lgb.grid, data = lgb.train, learning_rate = 0.02,
                      num_leaves = 25, num_threads = 2 , nrounds = best.iter,
                      eval_freq = 20, eval = lgb.auc)

var_imp   = lgb.importance(lgb.model, percentage = TRUE)
lgb.plot.importance(var_imp, top_n = 10, measure = "Gain")
#var_contr = lgb.interprete(lgb.model, lgb.train, 1:5)

pred.lgb_in = predict(lgb.model, train_sparse)
plot_binmodel_roc(actual[tindex], pred.lgb_in)
plot_binmodel_percentiles(actual[tindex], pred.lgb_in, 100)
gbm.roc.area(actual[tindex], pred.gbm[tindex])

#pred.lgb = predict(lgb.model, Matrix(as.matrix(df[is_train == FALSE , all_vars, with=F]), sparse=FALSE))

```

## Save Results

100k 0.7194157 - 
```{r save_results}

submit = df[is_train==FALSE, .(MachineIdentifier, HasDetections=pred.gbm) ]

file = file.path(working_folder, "malware_scoring/solution.csv")
  
fwrite(submit, file = file, row.names = FALSE)

zip(paste(file, '.zip', sep = ''), file)
  
print(file)

```
