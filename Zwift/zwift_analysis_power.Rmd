---
title: "Zwift Analysis"
output: html_document
date: "2023-08-11"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dev = "png", dev.args = list(type = "cairo-png"))

library(jsonlite)
library(stringi)
library(lubridate)
library(data.table)
library(ggplot2)
library(zoo)
library(plyr)
library(plotly)
library(gam)
library(knitr)
library(FITfileR)
library(forcats)
library(plotly)
library(gridExtra)

working_folder = 'D:/Github/KaggleSandbox'

source(file.path(working_folder, 'Utils/common.R'))
```

## Convert to CSV
https://github.com/grimbough/FITfileR
```{r convert_to_csv}
fit_folder = file.path(working_folder, 'Zwift/new_power/')

zwift_fit_files = list.files(fit_folder, pattern = '*.fit$', full.names = TRUE)
zwift_fit_files_converted = list.files(fit_folder, pattern = '*.fit.csv$', full.names = TRUE)
zwift_fit_files_converted = stri_replace_all(zwift_fit_files_converted, '', regex = '.csv$')
zwift_fit_files_new = zwift_fit_files %!in_set% zwift_fit_files_converted

print(zwift_fit_files_new)

foreach(name = zwift_fit_files_new, .combine=rbind ) %do% {
  df_temp <- data.frame(records(readFitFile(name)))
  fwrite(df_temp, stri_join(name, ".csv"))
}
```


## Read file

https://www.fitfileviewer.com/
https://johnedevans.wordpress.com/2018/05/31/the-physics-of-zwift-cycling/

```{r load_data, fig.width = 12, fig.height = 6}
fit_folder = file.path(working_folder, 'Zwift/new_power/')

zwift_files = list.files(fit_folder, pattern = glob2rx('*fit.csv'), full.names = TRUE)

df = foreach(name = zwift_files, .combine=rbind ) %do% {
  df_temp = fread(name, drop = c('position_lat', 'position_long'))
  df_temp[, file := basename(name)]
  return(df_temp)
}

df[order(timestamp), t:=seq(.N)-1, by = .(file)]
df[, date :=as.Date(stri_sub(file, 1, to=10 ))]

df[heart_rate==0, heart_rate:=NA ]
df[order(timestamp), heart_rate:=nafill(heart_rate, type="locf", fill=NA, nan=NA), by = .(file)]
df[order(timestamp),power_5m_sd := frollapply(power, 5*60, sd, na.rm=TRUE), by = .(date)]
df[order(timestamp),heart_rate_5m_sd := frollapply(heart_rate, 5*60, sd, na.rm=TRUE), by = .(date)]

df[order(timestamp),power_5s_avg := frollmean(power, 5, na.rm=TRUE), by = .(date)]
df[order(timestamp),power_1m_avg := frollmean(power, 1*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),power_3m_avg := frollmean(power, 3*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),power_5m_avg := frollmean(power, 5*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),power_10m_avg := frollmean(power, 10*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),power_20m_avg := frollmean(power, 20*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),power_30m_avg := frollmean(power, 30*60, na.rm=TRUE), by = .(date)]
df[order(timestamp), power_70s_ewma := ewma(power, exp(-log(2)/ 70)), by =.(date)]  

df[order(timestamp),cadence_20m_avg := frollmean(cadence, 20*60, na.rm=TRUE), by = .(date)]


df[order(timestamp),hr_1m_avg  := frollmean(heart_rate, 1*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),hr_3m_avg  := frollmean(heart_rate, 3*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),hr_5m_avg  := frollmean(heart_rate, 5*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),hr_10m_avg := frollmean(heart_rate, 10*60, na.rm=TRUE), by = .(date)]
df[order(timestamp),hr_20m_avg := frollmean(heart_rate, 20*60, na.rm=TRUE), by = .(date)]

#df[order(timestamp),hr_eq := 1.064e+02 + 2.224e-01 * power_70s_ewma , by = .(date)]
df[order(timestamp),hr_eq := 154.2635 -  0.4732869 * pmax(0,       211.8767 - power_70s_ewma) + 0.07484887 * pmax(0, power_70s_ewma -       211.8767) , by = .(date)]
   
   kable(df[,.(.N), .(file)])
 
df_agg = df[,.(time=.N/60, kcal = 4.023349 * sum(power, na.rm= TRUE)/4200, 
      power_avg = mean(power, na.rm= TRUE),
      power_max = max(power, na.rm= TRUE), 
      stop_time = sum(power<1), 
      power_max_1  = quantile(power_1m_avg,probs = 0.95, na.rm=TRUE),
      power_max_5 = quantile(power_5m_avg,probs = 0.95, na.rm=TRUE),
      power_max_10 = quantile(power_10m_avg,probs = 0.95, na.rm=TRUE),
      power_max_20 = quantile(power_20m_avg,probs = 0.95, na.rm=TRUE),
      power_max_30 = quantile(power_30m_avg,probs = 0.95, na.rm=TRUE),
      fatigue = mean((heart_rate  - hr_eq) * (t/60 > 30), na.rm=TRUE),   
      hr_avg = mean(heart_rate, na.rm= TRUE),
      power_hr_ratio =  mean(power, na.rm= TRUE)/mean(heart_rate, na.rm= TRUE),
      power_hr_ratio_10m =  mean(power_10m_avg, na.rm= TRUE)/mean(hr_10m_avg,na.rm= TRUE),
      hr_max = max(heart_rate), 
      cadence = mean(cadence),
      dist_m = max(distance)/1609.34, 
      ascend_ft = 3.281 * sum(pmax(0, altitude - shift(altitude)), na.rm = TRUE)), by = .(date)]

kable(df_agg)

df_agg = df_agg[hr_avg > 90]

if(FALSE){
  
  #library(earth)
  #mars.model = earth(heart_rate ~ power_70s_ewma, df[t>60*5], degree = 1, nfold = 10, trace = 3, thresh = 0.01)
  #summary(mars.model, style='pmax')
  #plotmo(mars.model)
  
     ggplot(df[t>60*5], aes(power_70s_ewma, heart_rate )) + geom_point(alpha = 0.1) + geom_line(aes(power_70s_ewma, hr_eq), color = 'red')+ facet_wrap(~date)
  
ggplot(df) + geom_line(aes(t/60, power_20m_avg, color = 'power')) + geom_line(aes(t/60, 1.4*hr_3m_avg, color = 'hr')) + facet_wrap(~file)
  
  ggplot(df) + geom_line(aes(t/60, power_3m_avg, color = 'power_3m_avg')) + geom_line(aes(t/60, power_70s_ewma, color = 'power_70s_ewma')) + facet_wrap(~file)

  ggplot(df) + geom_line(aes(t/60, power, group = file, color = file))+ facet_wrap(~file)
ggplot(df) + geom_line(aes(t/60, power_5m_avg, group = file, color = file))+ facet_wrap(~file)
ggplot(df) + geom_line(aes(t/60, power_10m_avg, group = file, color = file))
ggplot(df) + stat_ecdf(aes(power, group = file, color = file))
ggplot(df) + geom_density(aes(power, group = file, color = file))
ggplot(df) + geom_density(aes(power_5m_avg, group = file, color = file), adjust = 0.3)
ggplot(df) + geom_histogram(aes(power_10m_avg, group = file, fill = file), binwidth = 0.5, alpha = 0.7, position="identity")
ggplot(df[heart_rate>100]) + geom_histogram(aes(heart_rate, group = file, fill = file), binwidth = 1, alpha = 0.7, position="identity")

ggplot(df) + geom_histogram(aes(hr_5m_avg, group = file, fill = file), binwidth = 0.5, alpha = 0.7, position="identity")

ggplot(df) + geom_density(aes(power_20m_avg, group = file, color = file), adjust = 0.3)

ggplot(df, aes(cadence, power, group = file, color = file)) + geom_smooth(span = 0.2)
ggplot(df, aes(cadence, power, group = file, color = file)) + geom_point()

ggplot(df, aes(hr_5m_avg, power_20m_avg, group = date)) + geom_point(alpha = 0.5) + facet_wrap(~date)
ggplot(df, aes(heart_rate, power_5m_avg, group = date)) + geom_point(alpha = 0.5) + facet_wrap(~date)

cor(df)
#plot correlation
num_var = names(which(sapply(df, is.numeric )))
con_corr = cor(df[,num_var, with = FALSE], use="pairwise.complete.obs")
library(corrplot)
corrplot(con_corr, method="ellipse")
corrplot(con_corr, method="number")
corrplot.mixed(con_corr, lower="number", upper="ellipse")

ggplot(df) + geom_line(aes(t/60, heart_rate)) + facet_wrap(~file)
ggplot(df) + geom_line(aes(t/60, power_5m_avg)) + facet_wrap(~file)
ggplot(df) + geom_line(aes(t/60, power)) +  geom_line(aes(t/60, power_20m_avg), color = 'red') +  geom_line(aes(t/60, power_1m_avg), color = 'blue') + facet_wrap(~file)

ggplot(df) + geom_point(aes(power, heart_rate)) + facet_wrap(~file)

ggplot(df) + geom_violin(aes(date, power, group = date)) + geom_point(data = df_agg, aes(date, power_avg ))

ggplotly(ggplot(df[date == max(date)]) + geom_line(aes(t/60, power)))

cc(df[date == max(date),.(t, heart_rate, power, power_5s_avg)])
}

last_12_days = head(sort(unique(df$date), TRUE), 12)

dfs = df[date %in% last_12_days]

ggplot(dfs, aes(t/60, factor(date), fill = power)) + geom_tile() + scale_fill_custom('mixed', discrete = FALSE)
ggplot(dfs, aes(t/60, factor(date), fill = heart_rate)) + geom_tile() + scale_fill_custom('mixed', discrete = FALSE)
ggplot(dfs, aes(t/60, factor(date), fill = cadence)) + geom_tile() + scale_fill_custom('mixed', discrete = FALSE)

ggplot(dfs) + geom_line(aes(t/60, power_5m_sd))  + facet_wrap(~file)
ggplot(dfs) + geom_line(aes(t/60, heart_rate, color = 'heart_rate')) + geom_line(aes(t/60, hr_eq, color = 'hr_eq')) + facet_wrap(~file) + scale_color_manual(values = c('black', 'red'))
ggplot(dfs) + geom_line(aes(t/60, heart_rate_5m_sd))  + facet_wrap(~file)


ggplot(dfs) + geom_density(aes(hr_1m_avg), adjust = 0.3) + facet_wrap(~date)
ggplot(dfs) + geom_density(aes(power_10m_avg), adjust = 0.3) + facet_wrap(~date)
ggplot(dfs) + geom_density(aes(power_20m_avg), adjust = 0.3) + facet_wrap(~date)
ggplot(dfs) + geom_line(aes(t/60, power_20m_avg)) + facet_wrap(~file)
ggplot(dfs) + geom_line(aes(t/60, cadence_20m_avg)) + facet_wrap(~file)
ggplot(dfs) + geom_point(aes(cadence_20m_avg, power_20m_avg)) + facet_wrap(~file)
ggplot(dfs) + geom_point(aes(cadence, power), alpha = 0.5) + facet_wrap(~file)

ggplot(dfs) + geom_density(aes(power), adjust = 0.3) + facet_wrap(~date)+ geom_vline(xintercept = c(200, 300, 400), linetype = 'dashed', color = 'grey')
ggplot(dfs) + geom_density(aes(heart_rate), adjust = 0.3) + facet_wrap(~date) + geom_vline(xintercept = c(120, 140, 160), linetype = 'dashed', color = 'grey')

ggplot(dfs) + geom_density(aes(power_10m_avg/hr_10m_avg), adjust = 0.3) + facet_wrap(~date)
ggplot(dfs) + geom_line(aes(t/60, power_10m_avg/heart_rate)) + facet_wrap(~file)

ggplot(dfs) + geom_violin(aes(date, heart_rate, group = date), adjust = 0.5)
ggplot(dfs) + geom_violin(aes(date, power, group = date), adjust = 0.5)
ggplot(dfs) + geom_violin(aes(date, cadence, group = date), adjust = 0.5)

ggplot(df_agg) + geom_point(aes(date, power_hr_ratio)) +
  geom_line(aes(date, power_hr_ratio, color = 'power_hr_ratio' )) + 
  geom_line(aes(date, power_hr_ratio_10m, color = 'power_hr_ratio_10m' )) 

ggplot(df_agg) + geom_point(aes(date, power_avg)) +
  geom_line(aes(date, power_avg, color = 'power_avg' )) + 
  geom_line(aes(date, power_max_1, color = 'power_max_1' )) + 
  geom_line(aes(date, power_max_5, color = 'power_max_5' )) +
  geom_line(aes(date, power_max_10, color = 'power_max_10' )) + 
  geom_line(aes(date, power_max_20, color = 'power_max_20' )) +
  geom_line(aes(date, power_max_30, color = 'power_max_30' )) 

ggplot(df_agg, aes(date, hr_avg )) + geom_point() + geom_line()
ggplot(df_agg, aes(date, hr_max )) + geom_point() + geom_line()
ggplot(df_agg, aes(date, power_avg )) + geom_point() + geom_line()
ggplot(df_agg, aes(date, power_max )) + geom_point() + geom_line()

ggplot(df_agg, aes(date, time )) + geom_point() + geom_line()
ggplot(df_agg, aes(date, cadence )) + geom_point() + geom_line()
ggplot(df_agg, aes(date, fatigue )) + geom_point() + geom_line()

#power curve

df_power_curve = ldply(seq(1, 20*60), function(seconds){
  df_agg_temp = df[order(timestamp),.(power_max  = max(frollmean(power, seconds, na.rm=TRUE), na.rm=TRUE)),by = .(date)]
  #df_agg_temp = df[order(timestamp),.(power_max  = quantile(frollmean(power, seconds, na.rm=TRUE),prob = 0.999, na.rm=TRUE)),by = .(date)]
  df_agg_temp[, interval := seconds]
  return(df_agg_temp)
})
setDT(df_power_curve)
df_power_curve[, last_date := date == max(date)]
df_power_curve_agg =  df_power_curve[, .(power_max = mean(power_max)), by =.(interval, last_date)]

ggplot(df_power_curve[last_date == FALSE]) + geom_line(aes(interval, power_max, group = date ), color = 'black', alpha = 0.3) + 
  geom_line(data = df_power_curve[last_date == TRUE], aes(interval, power_max, group = date ), color = 'red', alpha = 1.0) +  
  geom_line(data = df_power_curve_agg[last_date == FALSE], aes(interval, power_max ), color = 'black' ) +   scale_x_log10()

```


## Power vs Heart rate LASSO

```{r power_heart_rate_lasso, echo=FALSE, eval = FALSE}

dfs = df[t > 300 &  heart_rate > 90]

library(glmnet)
library(plyr)

get_all_coefs<-function(glmnet_obj){
  res = ldply(glmnet_obj$lambda, function(lambda){
    temp = data.matrix(coef(glmnet_obj,s=lambda))
    data.frame(var_name = rownames(temp), coef = as.numeric(temp), lambda)
  })
  return(res)
}

for(i in seq(360)) {
  vname = sprintf('power_rm_%03d', i)
  #dfs[order(date), c(vname) := rollmeanr(power, k = i, fill = NA), by =.(file)]
  dfs[order(date), c(vname) := ewma(power, exp(-log(2)/ i)), by =.(file)]  
}

#dfs[order(date), power_ew_150 := ewma(power,exp(-log(2)/ 150)), by =.(file)]
#ggplot(dfs) + geom_line(aes(t, power_ew_150), color = 'blue') + geom_line(aes(t, power_rm_150), color = 'red') + geom_line(aes(t, power), color = 'black', alpha = 0.3) + facet_wrap(~date)

model_rm_vars = names(dfs)[ grep('power_rm_', names(dfs)) ]


x=data.matrix(dfs[, c('heart_rate', model_rm_vars), with = FALSE])
index = complete.cases(x)
y = x[index, 1]
x = x[index,-1]

cor_matrix =  cor(dfs[, c('heart_rate', model_rm_vars), with = FALSE], use="pairwise.complete.obs")
data.table(cor_matrix[,1])[V1<1][V1 == max(V1)]


cvob3=cv.glmnet(x, y, family="gaussian", nfolds = 10, relax = FALSE)
plot(cvob3)

coef_path = data.table(get_all_coefs(cvob3))
coef_path[order(var_name), weight := seq(0, .N-1),  by =.(lambda)]
coef_path[order(var_name,  decreasing = TRUE), adj_coef := cumsum(coef / weight),  by =.(lambda)]
coef_path[, dof:=sum(coef!=0), by =.(lambda)]
coef_path[var_name != '(Intercept)', .( sum(coef),  sum(adj_coef)), by =.(lambda)] #sum of the coefs  -0.013400167
coef_path[var_name != '(Intercept)' & lambda == cvob3$lambda.1se & coef != 0]
coef_path[var_name != '(Intercept)' & dof == 4 & coef != 0]

imp_vars = sort(as.character(unique( coef_path[lambda >= 1*cvob3$lambda.1se & abs(coef) >0, var_name] )))

ggplot(coef_path[var_name != '(Intercept)'], aes(weight, log(lambda), fill = atan(1e4*coef) )) + geom_tile() +  
  theme(axis.text.x  = element_text(angle=0, size = 7)) + 
  geom_hline(yintercept = log(c(cvob3$lambda.1se, cvob3$lambda.min)), linetype = 'dashed') + 
  scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0)

hr.model = lm('heart_rate ~ power_rm_072', dfs)

summary(hr.model) #0.2696

dfs[, heart_rate_pred := predict(hr.model,.SD)]
ggplot(dfs) + geom_line(aes(t/60, heart_rate_pred), color = 'red') + geom_line(aes(t/60, heart_rate)) + facet_wrap(~file)
#ggplot(df) + geom_line(aes(t/60, power_avg_15s))+  geom_line(aes(t/60, 2*heart_rate),  color = 'red') + facet_wrap(~file)

plot_profile(dfs$heart_rate_pred, dfs$heart_rate, dfs$t, 30)
plot_profile(dfs$heart_rate_pred, dfs$heart_rate, dfs$date, 30)


```

