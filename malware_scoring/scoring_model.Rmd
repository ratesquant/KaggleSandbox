---
title: "Malware Scoring"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(plyr)

library(data.table)
library(stringi)
library(stringr)
library(ggplot2)
library(gridExtra)
library(zip)
library(corrplot)
library(forcats)
#library(pdp)
library(e1071)
library(jsonlite)
library(lubridate)

library(gbm)
library(randomForestSRC)
library(xgboost)
library(lightgbm)

#library(rjson)
#library(caret)

#working_folder = 'C:/Dev/Kaggle/'
working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')


source(file.path(working_folder, '/Utils/common.R'))
```

## Loan Data

```{r load_data}

df_filename = file.path(working_folder,'malware_scoring/data/all.rds')

if(file.exists(df_filename)) {
  print(sprintf('reading: %s', df_filename))
  df = readRDS(df_filename)
}else {
  
  df_train = fread(file.path(working_folder,'malware_scoring/data/train.csv'), check.names=T)#, nrows = 10000)
  df_test  = fread(file.path(working_folder,'malware_scoring/data/test.csv'),  check.names=T)#, nrows = 10000)
  
  df_train[,is_train:=TRUE ] #8921483
  df_test[, is_train:=FALSE] #7853253
  df_test[, HasDetections := 0]
  
  df = rbind(df_train, df_test)
  
  rm(list = c('df_train', 'df_test')) 
  
  saveRDS(df, df_filename)
}
train_index = df$is_train

id_columns =c('MachineIdentifier', '')

gc(reset=TRUE)
```

## View Data

```{r view_data}
table(df[,.(is_train, ProductName)]) #win8defender, mse
table(df[,.(is_train, HasDetections)])
table(df[,.(is_train, OsVer)])

actual = df$HasDetections[train_index]
model  = df$HasDetections[train_index]

plots = llply(names(df), function(var_name) {
  if(is.character(df[[var_name]]) &  length(unique(df[[var_name]]))>100 )
    return (ggplot())
   p = plot_profile(model, actual, df[[var_name]][train_index], error_band = 'binom') + 
     ggtitle(var_name) +  theme(title =element_text(size=6))
   return(p)
})
marrangeGrob(plots, nrow = 6, ncol = 7, top = NULL)

```

## GBM Model
```{r gbm_model}
tindex = df$is_train

obj_var = 'HasDetections'
actual = df[[obj_var]]

all_vars = names(df) %!in_set% c(exclude_vars)

set.seed(1012356)

formula.pd = formula(stri_join( obj_var, ' ~ ', stri_join(unique(all_vars), collapse = ' + ')))

model_vars = all.vars(formula.pd) %!in_set% c(obj_var)
var.monotone = rep(0, length(model_vars))

#num_vars  = model_vars %in_set% names(which(sapply(df, is.numeric)))
#corr_matrix = cor(df[, ..num_vars ], use="complete.obs")
#corrplot(corr_matrix, method="number", number.cex = 0.5)
#corrplot(corr_matrix, method="circle", order="hclust")

mon_inc_vars = c()
mon_dec_vars = c()

var.monotone[model_vars %in% mon_inc_vars]  =  1
var.monotone[model_vars %in% mon_dec_vars]  = -1

cv_folds = 0
max_it = 10

model.pd  = gbm(formula.pd,
                 distribution = "bernoulli",
                 n.trees = max_it,
                 cv.folds = cv_folds,
                 shrinkage = 0.01,
                 interaction.depth=6,
                 train.fraction = 0.5,
                 bag.fraction = 0.9,# 0.5 for small samples, 0.7 for large
                 n.cores = 2,
                 var.monotone = var.monotone,
                 data = df[tindex , all.vars(formula.pd), with = F],
                 verbose = TRUE)

#saveRDS(model.pd, file.path(working_folder,'malware_scoring/model_pd.v2.rds'))
#model.pd = readRDS(file.path(working_folder,'malware_scoring/model_pd.rds'))

plot_gbmiterations(model.pd) #0.03795, AUC

best_it.pd = gbm.perf(model.pd, plot.it = F) #ifelse(cv_folds==0, max_it, gbm.perf(model.pd, plot.it = F))

pred.pd  = predict(model.pd, n.trees = best_it.pd, newdata = df, type = 'response')
plot_binmodel_roc(actual.pd[tindex], pred.pd[tindex])
plot_binmodel_cdf(actual.pd[tindex], pred.pd[tindex])
plot_binmodel_percentiles(actual.pd[tindex], pred.pd[tindex], 100)
gbm.roc.area(actual.pd[tindex], pred.pd[tindex]) #0.9910346

#summary(glm('actual.pd ~ model ', data = data.frame(actual.pd = actual.pd[tindex], model = pred.gbm[tindex]), family = binomial(link = "logit"))) 

#influence
var_inf = summary(model.pd, n.trees = best_it.pd, plotit = F)
var_inf = subset(var_inf, rel.inf>0.1)
#fwrite(var_inf, file = file.path(working_folder, "gstore/variables.csv"), row.names = FALSE)
plot_gbminfluence(var_inf)
print(var_inf)

imp_vars = as.character(var_inf$var[var_inf$rel.inf>0.1])
#df_agg[1:100,..imp_vars]

plots = plot_gbmpartial(model.pd, best_it.pd, imp_vars, output_type = 'response')
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)

plots = llply(all.vars(formula.pd), function(var_name) {
  p = plot_profile(pred.pd[tindex], actual.pd[tindex],df[[var_name]][tindex], error_band = 'binom') +
    ggtitle(var_name) +  theme(title =element_text(size=6))
  return( p )
})
marrangeGrob(plots, nrow = 5, ncol = 7, top = NULL)

#all vars
plots = llply(names(df_agg) %!in_set% c('fullVisitorId', all.vars(formula.pd)), function(var_name) {
  #print(var_name)
  p = plot_profile(pred.pd[tindex], actual.pd[tindex],df_agg[[var_name]][tindex], error_band = 'binom') +
    ggtitle(var_name) +  theme(title =element_text(size=6))
  return( p )
})
marrangeGrob(plots, nrow = 6, ncol = 6, top = NULL)

plot_profile(pred.pd[tindex], actual.pd[tindex],df$totals_bounces[tindex], error_band = 'binom')
plot_profile(pred.pd[tindex], actual.pd[tindex],df$date_m8_pct[tindex], error_band = 'binom')
plot_profile(pred.pd[tindex], actual.pd[tindex],df$date_m4_pct_pos[tindex], error_band = 'binom')
plot_profile(pred.pd[tindex], actual.pd[tindex],df$date_m5_pct_pos[tindex], error_band = 'binom')

plot_profile(pred.pd[tindex], actual.pd[tindex],fct_reorder(df$geo_country[tindex],actual.pd[tindex], sum), error_band = 'binom')
```


## Save Results


```{r save_results}

submit = df[is_train==FALSE, .(MachineIdentifier, HasDetections) ]

file = file.path(working_folder, "malware_scoring/solution.csv")
  
fwrite(submit, file = file, row.names = FALSE)

zip(paste(file, '.zip', sep = ''), file)
  
print(file)

#fullVisitorId,PredictedLogRevenue

```
