---
title: 'Kaggle Playground: Jan 2020'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(stringi)
library(gbm)
library(ggplot2)
library(gridExtra)
#library(dplyr)
library(plyr)
library(corrplot)
library(xgboost)
#library(zip)
library(caret)

working_folder = 'D:/Github/KaggleSandbox'
#working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')

source(file.path(working_folder, 'Utils/common.R'))

rmsqr <-function(actual, model) {
  sqrt( mean( (actual - model) * (actual - model) ) )
}

```

## Load Data

```{r load_data}


load_existing = TRUE

if (load_existing) {
  df <- fread(file.path(working_folder,'Playground/Jan2021/data/df.csv'), check.names = TRUE)
  
} else{
  train <- fread(file.path(working_folder,'Playground/Jan2021/data/train.csv'), check.names = TRUE)
  test  <- fread(file.path(working_folder,'Playground/Jan2021/data/test.csv'),  check.names = TRUE) # 1459   80
  test[, target:=NA]
  df = rbind(train, test)
  
  gc(reset=TRUE)
}
  

test_index = is.na(df$target)
train_index = !test_index

obj_var = 'target'
all_vars = names(df) %!in_set% c('id', obj_var) #14 variables
all_vars = all_vars[grep('cont', all_vars)]

plot_profiles <-function(model, data)
{
    plots = llply(all_vars, function(var_name) {
    p = plot_profile(model,  data[['target']], data[[var_name]], bucket_count = 50, error_band = 'norm') +
      ggtitle(var_name) +  theme(title =element_text(size=6))
    return( ggplotGrob(p) )
  })
  marrangeGrob(plots, nrow = 4, ncol = 4, top = NULL)
}

```


##RBF
on 1%  
gaussprRadial 441.64 sec (0.730695)
rbf - too slow
rvmRadial - too slow
```{r RBF, eval = FALSE}

set.seed(132140937)

formula.rbf    = formula(stri_join( 'target', ' ~ ', stri_join(unique(all_vars), collapse = ' + ')))

#control = trainControl(method = "repeatedcv", number = 10,repeats = 3)
control = trainControl("cv", number = 5)

t_index_v = which(train_index)
t_index_v1 = sample(t_index_v, 0.01*length(t_index_v))

dfs = df[t_index_v1, all.vars(formula.rbf), with = FALSE]
system.time(model.rbf <- train(formula.rbf, data = dfs, 
                               method = "krlsRadial", #kknn
                               trControl = control,
                               #tuneGrid = data.frame(size = c(1, 10, 20, 100, 1000)), #use instead of tuneLength
                               tuneLength = 10,
                               metric = "RMSE"))
model.rbf
plot(model.rbf)

pred.rbf = predict(model.rbf, df, type = 'raw')

rmsqr(df$target[train_index], pred.rbf[train_index] )

plot_profiles(pred.rbf[train_index], df[train_index,])

```

##KRLS
krlsRadial - takes too much memory
1% -  443.23  sec, 0.7234949
```{r KRLS, eval = FALSE}

set.seed(132140937)

formula.krls    = formula(stri_join( 'target', ' ~ ', stri_join(unique(all_vars), collapse = ' + ')))

control = trainControl("cv", number = 5)

t_index_v = which(train_index)
t_index_v1 = sample(t_index_v, 0.01*length(t_index_v))

dfs = df[t_index_v1, all.vars(formula.krls), with = FALSE]
system.time(model.krls <- train(formula.krls, data = dfs, 
                               method = "gaussprRadial", #kknn
                               trControl = control,
                               tuneGrid = expand.grid(sigma = c(0.001, 0.01) ),
                               print.level = 0,
                               #tuneGrid = data.frame(size = c(1, 10, 20, 100, 1000)), #use instead of tuneLength
                               tuneLength = 10,
                               metric = "RMSE"))
model.krls
plot(model.krls)

pred.krls = predict(model.krls, df)

rmsqr(df$target[train_index], pred.krls[train_index] )

plot_profiles(pred.krls[train_index], df[train_index,])

```

##SVM

```{r SVM, eval = FALSE}

set.seed(132140937)

formula.svm    = formula(stri_join( 'target', ' ~ ', stri_join(unique(all_vars), collapse = ' + ')))

control = trainControl("cv", number = 5)

t_index_v = which(train_index)
t_index_v1 = sample(t_index_v, 0.01*length(t_index_v))

dfs = df[t_index_v1, all.vars(formula.svm), with = FALSE]
system.time(model.svm <- train(formula.svm, data = dfs, 
                               method = "svmRadial",
                               trControl = control,
                               tuneGrid = expand.grid(C = c(2, 3, 4), sigma = seq(1, 6)),
                               print.level = 0,
                               tuneLength = 10,
                               metric = "RMSE"))
model.svm
plot(model.svm)

pred.svm = predict(model.svm, df)

rmsqr(df$target[train_index], pred.svm[train_index] )

plot_profiles(pred.svm[train_index], df[train_index,])

```
