---
title: "GStore Predictor"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(gbm)
library(data.table)
library(plyr)
library(stringi)
library(ggplot2)
library(gridExtra)
library(zip)
library(xgboost)
library(corrplot)
library(forcats)
library(pdp)
library(e1071)
library(jsonlite)
#library(rjson)
library(tidyjson)
#library(caret)

#working_folder = 'C:/Dev/Kaggle/'
working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')


source(file.path(working_folder, '/Utils/common.R'))
```

## Loan Data

```{r load_data}

df_train = fread(file.path(working_folder,'/gstore/data/train.csv'), check.names=T, nrows = 100)
df_test  = fread(file.path(working_folder,'/gstore/data/test.csv'),  check.names=T, nrows = 100)

df_train[,is_train:=T ]
df_test[, is_train:=F ]

df = rbind(df_train, df_test)
train_index = df$is_train

#unparse jsons: 
# device: browser, operatingSystem, isMobile, deviceCategory
# geoNetwork: continent, subContinent, country, region, metro, networkDomain
# totals, 
# trafficSource

# TODO: try to think of a better way to do this
parse_json <- function(json_str, fields){
  values = fromJSON(stri_replace_all_fixed(json_str, '\"\"','\"') )[fields]
  return(values)
}
#parse_geo_v <- Vectorize(parse_geo, SIMPLIFY = TRUE)

geo_fields = c('continent', 'subContinent', 'country', 'region')
device_fields = c('browser', 'operatingSystem', 'isMobile', 'deviceCategory')

df[, (stri_join('geo_', geo_fields)):=parse_json(geoNetwork, geo_fields),  by = seq_len(nrow(df))]
df[, (stri_join('device_', device_fields)):=parse_json(device, device_fields),  by = seq_len(nrow(df))]

#a = df[, .(geoNetwork, geo_continent)]
#a = df[, .(device, device_isMobile)]


lapply(df$geoNetwork_json[1:10], parse_geo)

df[, (stri_join('geo_', geo_fields)):=parse_geo_v(stri_replace_all_fixed(geoNetwork, '\"\"','\"'))]

df[, device_browser := fromJSON(geoNetwork_json)$browser,  by = seq_len(nrow(df))]
df[, device_os := fromJSON(device_json)$operatingSystem,  by = seq_len(nrow(df))]
df[, device_ismobile := fromJSON(device_json)$isMobile,  by = seq_len(nrow(df))]
df[, device_category := fromJSON(device_json)$deviceCategory,  by = seq_len(nrow(df))]

  
table(df_train$channelGrouping)

df_test[, target:=NA]


```

