---
title: "GBM Fraud Model"
output: html_document
---

```{r setup, include=FALSE}
rm(list = ls())

knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(plyr)

library(data.table)
library(stringi)
library(ggplot2)
library(gridExtra)
library(zip)
library(corrplot)
library(forcats)
#library(pdp)
library(e1071)
library(lubridate)

library(gbm)
#library(randomForestSRC)
#library(xgboost)
#library(lightgbm)

#working_folder = 'C:/Dev/Kaggle/'
working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')
source(file.path(working_folder, '/Utils/common.R'))
```


## Load Data

```{r load_data}

 data_folder = file.path(working_folder,'ieee_fraud/data/')

 df_test_id = fread(file.path(data_folder,'test_identity.csv'), check.names=T)#, nrows = 10000)
 df_test_tr  = fread(file.path(data_folder,'test_transaction.csv'),  check.names=T)#, nrows = 10000)

 df_train_id = fread(file.path(data_folder,'train_identity.csv'), check.names=T)#, nrows = 10000)
 df_train_tr  = fread(file.path(data_folder,'train_transaction.csv'),  check.names=T)#, nrows = 10000)

 df_test  = merge(df_test_tr,  df_test_id,  by = 'TransactionID', all.x = TRUE)
 df_train = merge(df_train_tr, df_train_id, by = 'TransactionID', all.x = TRUE)
 
 df_test[,  is_train:=FALSE  ]
 df_train[, is_train:=TRUE ]
 df_test[, isFraud:=NA ]
 df = rbind(df_train, df_test)
 
 df = df[sample.int(nrow(df), nrow(df)),] #shuffle
 t_index = df$is_train
  
 rm(list = ls()[grepl('df_t.*', ls())])
 gc(reset = TRUE)
 
 tables()
  
```

## View Data

```{r data, echo=FALSE}

table(df[t_index, .(isFraud) ])
table(df[, .(is_train, ProductCD)])

```

## GBM Model

```{r gbm_model}

obj_var = 'isFraud'
actual = df[[obj_var]]

exclude_vars = c('TransactionID', 'TransactionDT', 'is_train', obj_var)

all_vars = names(df) %!in_set% c(exclude_vars)

set.seed(1012356)

formula.gbm = formula(stri_join( obj_var, ' ~ ', stri_join(unique(all_vars), collapse = ' + ')))

model_vars = all.vars(formula.gbm) %!in_set% c(obj_var)

var.monotone = rep(0, length(model_vars))
mon_inc_vars = c()
mon_dec_vars = c()
var.monotone[model_vars %in% mon_inc_vars]  =  1
var.monotone[model_vars %in% mon_dec_vars]  = -1

cv_folds = 0
max_it = 100

model.gbm  = gbm(formula.gbm,
                 distribution = "bernoulli",
                 n.trees = max_it,
                 cv.folds = cv_folds,
                 shrinkage = 0.01,
                 interaction.depth=3,
                 train.fraction = 0.7,
                 bag.fraction = 0.9,# 0.5 for small samples, 0.7 for large
                 n.cores = 4,
                 var.monotone = var.monotone,
                 data = df[t_index , all.vars(formula.gbm), with = F],
                 verbose = TRUE)

#saveRDS(model.gbm, file.path(working_folder,'santander_transaction/model_gbm.rds'))
#model.gbm = readRDS(file.path(working_folder,'santander_transaction/model_gbm.rds'))

plot_gbmiterations(model.gbm) #0.03795, AUC

best_it.gbm = gbm.perf(model.gbm, plot.it = FALSE)

pred.gbm  = predict(model.gbm, n.trees = best_it.gbm, newdata = df, type = 'response')
plot_binmodel_roc(actual[tindex], pred.gbm[tindex])
plot_binmodel_cdf(actual[tindex], pred.gbm[tindex])
plot_binmodel_percentiles(actual[tindex], pred.gbm[tindex], 100)
gbm.roc.area(actual[tindex], pred.gbm[tindex]) #0.7474184

#influence
var_inf = summary(model.gbm, n.trees = best_it.gbm, plotit = F)
var_inf = subset(var_inf, rel.inf>0.1)
#fwrite(var_inf, file = file.path(working_folder, "gstore/variables.csv"), row.names = FALSE)
plot_gbminfluence(var_inf)
print(var_inf)

imp_vars = as.character(var_inf$var[var_inf$rel.inf>0.1])
#df_agg[1:100,..imp_vars]

plots = plot_gbmpartial(model.gbm, best_it.gbm, imp_vars, output_type = 'response')
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)

gplots = lapply(plots, ggplotGrob)
ggsave(filename = file.path(working_folder,"santander_transaction/gbm.pd.d3.pdf"), plot = marrangeGrob(gplots, nrow=4, ncol=5), device = 'pdf', width = 11, height = 8.5, dpi = 240)

plots = llply(as.character(var_inf$var)[1:25], function(var_name) {
  p = plot_profile(pred.gbm[tindex], actual[tindex],df[[var_name]][tindex], error_band = 'binom') +
    ggtitle(var_name) +  theme(title =element_text(size=6))
  return( p )
})
marrangeGrob(plots, nrow = 5, ncol = 7, top = NULL)

gplots = lapply(plots, ggplotGrob)
ggsave(filename = file.path(working_folder,"santander_transaction/gbm.profiles.d3.pdf"), plot = marrangeGrob(gplots, nrow=4, ncol=5), device = 'pdf', width = 11, height = 8.5, dpi = 240)

```