---
title: "Porto Seguro’s Safe Driver Prediction"
author: "Alex"
date: "February 11, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 6, dpi = 240)

library(gbm)
library(data.table)
library(stringi)
library(ggplot2)
library(gridExtra)
library(zip)

working_folder = 'C:/Dev/Kaggle/'

source(file.path(working_folder, '/Utils/common.R'))


```

## Data

```{r data}

load_data <- function(working_folder){
  
  data_file = file.path(working_folder,'SafeDriverPrediction/data/all_data.rds')

  if(file.exists(data_file)){
    df = readRDS(data_file)
  }else {
    df_train = fread(file.path(working_folder,'SafeDriverPrediction/data/train.csv') )
    df_test  = fread(file.path(working_folder,'SafeDriverPrediction/data/test.csv') )
    
    df_test[, target:=NA]
    
    df = rbind(df_test, df_train)
    
    #repalce -1 with NA
    for (c_name in names(df)) {
      set(df,which(df[[c_name]]==-1),c_name,NA)
    }
    
    #convert to factors
    cat_vars = names(df)[grepl('_cat',names(df))]
    df[, (cat_vars):=lapply(.SD, as.factor), .SDcols = cat_vars]
  
    
    saveRDS(df, data_file)
  }
   return (df)
}

df = load_data(working_folder)

head(df)

test_index = is.na(df$target)
train_index = !is.na(df$target)

results = list()
```

## Data View

```{r data_view}
obj_var = 'target'
#var source: ind, reg, car, calc
#var types: bin, cat

c_names = names(df)
cat_vars = c_names[grepl('_cat',c_names)]

df_train = df[train_index,]

sapply(df, levels)

#plot cat var counts
plots = llply(cat_vars, function(var_name) {
 p = ggplot(df_train, aes_string(var_name)) + geom_bar()  +
    ggtitle(var_name)
 return( p )
})
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)

ggplot(df_train, aes(ps_car_11_cat)) + geom_bar()# a lot of levels

```

## GBM Model: All vars

```{r gbm_model1}

actual = as.numeric(df$target)

all_vars = names(df) %!in_set% c('id', 'target')
exclude_vars = c('ps_car_11_cat')

set.seed(101)

formula.gbm = formula(stri_join( 'target ~ ', stri_join(all_vars %!in_set% exclude_vars,collapse = ' + ')))

model_vars = all.vars(formula.gbm) %!in_set% c('target')
var.monotone = rep(0, length(model_vars))
var.monotone[model_vars %in% c('')]  = -1
var.monotone[model_vars %in% c('')]  =  1

model.gbm  = gbm(formula.gbm,
                 distribution = "bernoulli",
                 n.trees = 5000,
                 cv.folds = 0,
                 shrinkage = 0.01,
                 interaction.depth=3,
                 train.fraction = 0.7,
                 bag.fraction = 0.7,
                 n.cores = 2,
                 var.monotone = var.monotone,
                 data = df[train_index,all.vars(formula.gbm), with = F],
                 verbose = TRUE)

plot_gbmiterations(model.gbm)
best_it.gbm = gbm.perf(model.gbm, plot.it = F)

pred.gbm = predict(model.gbm, n.trees = best_it.gbm, newdata = df, type = 'response')

var_inf = summary(model.gbm, n.trees = best_it.gbm, plotit = F)
plot_gbminfluence(var_inf)
#plot_binmodel_predictions(actual[train_index], pred.gbm[train_index])

plot_binmodel_roc(actual[train_index], pred.gbm[train_index])

plots = plot_gbmpartial(model.gbm, best_it.gbm, as.character(var_inf$var[var_inf$rel.inf>1.0]), output_type = 'response')
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)

plots = llply(all_vars, function(var_name) {
  p = plot_profile(pred.gbm[train_index], actual[train_index],df[[var_name]][train_index], error_band = 'binom') +
    ggtitle(var_name)
  return( p )
})
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)
#roc.default(response = test$Class, predictor = gbm.test, plot = TRUE,     col = "red")

#save solution
results$gbm1 = pred.gbm

```

## GBM Model: Subset of vars

```{r gbm_model2}

```


## Output File

```{r output}

for (model_name in names(results) ){
  submit <- data.table(id = df$id[test_index], 
                       target = results[[model_name]][test_index])
  
  submit = submit[order(submit$id),]
  
  file = file.path(working_folder, sprintf("SafeDriverPrediction/my_solution_%s.csv", model_name))
  
  fwrite(submit, file = file, row.names = FALSE)
  
  #utils::zip(paste(file, '.zip', sep = ''), file, flags = "-r9X")
  zip(paste(file, '.zip', sep = ''), file)
  
  print(file)
}
```

