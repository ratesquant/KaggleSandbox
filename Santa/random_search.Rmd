---
title: "Random Search"
author: "Alex"
date: "December 26, 2018"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(data.table)
library(plyr)
library(stringi)
library(stringr)
library(ggplot2)
library(gridExtra)
library(zip)
library(sfsmisc) #for prime

library(GA)
library(TSP)

library(foreach)
library(microbenchmark)

#working_folder = 'C:/Dev/Kaggle/'
working_folder = 'F:/Github/KaggleSandbox'
#working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')


source(file.path(working_folder, '/Utils/common.R'))
```

## Load

```{r data}
 df_all = fread(file.path(working_folder,'Santa/data/cities.csv'), check.names=T)

 setorder(df_all, CityId)

 prime_ids = primes(max(df_all$CityId))

 df_all[,not_prime:=as.numeric(!(CityId %in% prime_ids))]
 
 #fwrite(df_all, file.path(working_folder,'Santa/data/cities.100.csv'))
 
 #df = df_all[1:1001,] #for debugging
 df = df_all
```

## Utils

```{r utils, echo=FALSE}
extra_dist = as.numeric(seq(nrow(df)) %% 10 == 0)

eval_path<-function(nodes, path){
  
  if(path[1] == 0)
    path_ids = c(path, 0) + 1
  else
    path_ids = c(0, path, 0) + 1
  
  x_c = nodes$X[path_ids]
  y_c = nodes$Y[path_ids]
  p_c = nodes$not_prime[path_ids[-length(path_ids)]] #exclude last
  
  dx = diff(x_c)
  dy = diff(y_c)
  
  dist = sum( sqrt(dx * dx + dy * dy) * (1.0 + 0.1 * extra_dist * p_c ) )
  
  return( dist )
}
```

```{r utils, echo=FALSE}

starting_tour = fread(file.path(working_folder, "Santa/data/cpp.solution.tour.txt"), header = FALSE)$V1

starting_dist = eval_path(df, starting_tour)

mutate_tour <- function(tour)
{
  m_tour <- tour
  n <- length(tour)
  m <- sort(1+sample.int(n-2, size = 2))
  i = m[1]
  j = m[2]
  m_tour[i:j] <- rev(tour[i:j])
  return(m_tour)
}
```


```{r utils, echo=FALSE}

maxit = 10000

#r_tour = starting_tour

curr_len =  eval_path(df, starting_tour)
best_len =  curr_len
r_tour_best = starting_tour
for(i in seq(maxit)){
  scale = 0.01
  
  #scale = 0.005*exp(-5.0*i/maxit)
  
  r_tour_next = mutate_tour(r_tour)
  #r_tour_next = random_tour(r_tour_next)
  #r_tour_next = random_tour_2(r_tour_next)
  #r_tour_next = random_tour_2(r_tour)
  #r_tour_next = random_tour_3(r_tour)
  
  df_t = data.frame(X = df$X + scale*rnorm(nrow(df)), 
                    Y = df$Y + scale*rnorm(nrow(df)), 
                    not_prime = df$not_prime )
  
  r_tour_next_len_t = eval_path(df_t, r_tour_next)
  r_tour_next_len   = eval_path(df,   r_tour_next)
  
  if(r_tour_next_len_t<curr_len){
    print(sprintf('%d: %f -> %f (%f)', i, curr_len, r_tour_next_len, scale))
    curr_len = r_tour_next_len
    r_tour = r_tour_next
  }
  
  if(r_tour_next_len<best_len){
    print(sprintf('%d: %f -> %f (%f)', i, r_tour_next_len, best_len, scale))
    best_len = r_tour_next_len
    r_tour_best = r_tour
  }
}
r_tour = r_tour_best

print( best_len - starting_dist )
```

## Estimate variance
```{r estimate_variance, echo=FALSE}

curr_len =  eval_path(df, starting_tour)

res = ldply(seq(256), function(i){
  scale = 0.01
  
  df_t = data.frame(X = df$X + scale*rnorm(nrow(df)), 
                    Y = df$Y + scale*rnorm(nrow(df)), 
                    not_prime = df$not_prime )
  
  data.frame(i, scale , dist = eval_path(df_t, starting_tour))
  })
 
ggplot(res, aes(dist)) + geom_density(adjust = 0.2) + geom_vline(xintercept = curr_len) 
  
```
