---
title: "FNMA Loan Level Data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())

knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(plyr)
library(foreach)
library(data.table)
library(stringi)
library(ggplot2)
library(gridExtra)
library(zip)
library(forcats)
library(lubridate)
library(R.utils)
library(zoo)
library(splines)
library(car)

working_folder = 'D:/Github/KaggleSandbox'
#working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')
source(file.path(working_folder, '/Utils/common.R'))

#test_df = data.table(i = seq(0, 360))
#test_df[, pay := pmt(6.0, 360-i)]
#test_df[, n_sb := next_sched_balance(6.0, 360-i)]
#test_df[, sb := sched_balance(i, 6.0, 360)]
```

## Functions
```{r unit_functions}

smm2cpr <- function(smm){
  100.0*(1.0 - (1.0 - smm)^12)
}

cpr2smm<- function(cpr){
  (1.0 - (1.0 - cpr/100)^(1/12))
}

pmt  <- function(wac, wam){
  r = wac / 1200.0
  return ( r / (1.0 - (1.0 + r)^(-wam) ))
}
next_sched_balance <-function(wac, wam){
  return ( 1 + wac / 1200.0 - pmt(wac, wam))
}

sched_balance <-function(age, wac, term){
  r = wac / 1200.0
  return (  (1 - (1+r)^(pmax(0, age)-term)) / (1.0 - (1.0 + r)^(-term) ))
}

uwac_model <- function(rate, logistic = FALSE){
  uwac = rate
  
  if(logistic){
    for(i in 2:length(uwac)){
      dr = rate[i-1] - uwac[i-1]
      uwac[i] = uwac[i-1]  -0.06 + (0.01+0.06) * logistic((dr+0.7)/0.2)
    }
  }else{
    for(i in 2:length(uwac)){
      dr = rate[i-1] - uwac[i-1]
      uwac[i] = uwac[i-1] + dr * ifelse(dr > 0, 0.02, 0.04)
    }
  }
  return(uwac)
}

plot_model_coefs <- function(params){
  df_names = data.table(name = names(params))
  df_names[, suffix := tstrsplit(name, '_', keep = 3)]
  df_names[, c("name1", "name2") := tstrsplit(name, '_', keep = 1:2)]
  df_names[, prefix := stri_join(name1, name2, sep = '_')]
  
  ei = seq(-200, 200, by = 10)
  
  plots = llply(unique(df_names$prefix), function(x){
    
    p = ggplot() + geom_blank() + ggtitle(x)
    if(length(grep('scurve', x))>0 || length(grep('boost', x))>0  ){
      a = params[[stri_join(x, '_low')]]
      b = params[[stri_join(x, '_high')]]
      shift = params[[stri_join(x, '_shift')]]
      slope = params[[stri_join(x, '_slope')]]
      p = ggplot(data.table(ei, scurve = scurve(ei, a, b, shift, slope) )) + geom_line(aes(ei, scurve)) + ggtitle(x)
    }else{
      xi = params[[stri_join(x, '_x')]]
      yi = params[[stri_join(x, '_y')]]
      p = ggplot(data.table(xi,yi), aes(xi, yi)) + geom_line() + geom_point() + ggtitle(x)
    }
    return (p)
  })
  
  return (plots)
}

to_date<-function(date_string){
  as.Date(stri_join(ifelse(stri_length(date_string) == 5, '010','01'), date_string), format = '%d%m%Y')
}
to_date2<-function(date_string){
 ns = stri_length(date_string)
 make_date(as.numeric(stri_sub(date_string, ns-3)), as.numeric(stri_sub(date_string, to = ns-4)), 1)
}
```

## Load FNMA loan data
load 1% of loans
```{r load_data}
data_folder = 'W:/loan_level/fnma/raw'
#data_folder = 'D:/loan_level/'

#to_date(c('52003','122003'))
#to_date2(c('52003','122003'))
#library(microbenchmark)
#microbenchmark(to_date(c('52003','122003')), to_date2(c('52003','122003')))



### Define the Loan Performance table headers
lppub_column_names <- c("POOL_ID", "LOAN_ID", "ACT_PERIOD", "CHANNEL", "SELLER", "SERVICER",
                        "MASTER_SERVICER", "ORIG_RATE", "CURR_RATE", "ORIG_UPB", "ISSUANCE_UPB",
                        "CURRENT_UPB", "ORIG_TERM", "ORIG_DATE", "FIRST_PAY", "LOAN_AGE",
                        "REM_MONTHS", "ADJ_REM_MONTHS", "MATR_DT", "OLTV", "OCLTV",
                        "NUM_BO", "DTI", "CSCORE_B", "CSCORE_C", "FIRST_FLAG", "PURPOSE",
                        "PROP", "NO_UNITS", "OCC_STAT", "STATE", "MSA", "ZIP", "MI_PCT",
                        "PRODUCT", "PPMT_FLG", "IO", "FIRST_PAY_IO", "MNTHS_TO_AMTZ_IO",
                        "DLQ_STATUS", "PMT_HISTORY", "MOD_FLAG", "MI_CANCEL_FLAG", "Zero_Bal_Code",
                        "ZB_DTE", "LAST_UPB", "RPRCH_DTE", "CURR_SCHD_PRNCPL", "TOT_SCHD_PRNCPL",
                        "UNSCHD_PRNCPL_CURR", "LAST_PAID_INSTALLMENT_DATE", "FORECLOSURE_DATE",
                        "DISPOSITION_DATE", "FORECLOSURE_COSTS", "PROPERTY_PRESERVATION_AND_REPAIR_COSTS",
                        "ASSET_RECOVERY_COSTS", "MISCELLANEOUS_HOLDING_EXPENSES_AND_CREDITS",
                        "ASSOCIATED_TAXES_FOR_HOLDING_PROPERTY", "NET_SALES_PROCEEDS",
                        "CREDIT_ENHANCEMENT_PROCEEDS", "REPURCHASES_MAKE_WHOLE_PROCEEDS",
                        "OTHER_FORECLOSURE_PROCEEDS", "NON_INTEREST_BEARING_UPB", "PRINCIPAL_FORGIVENESS_AMOUNT",
                        "ORIGINAL_LIST_START_DATE", "ORIGINAL_LIST_PRICE", "CURRENT_LIST_START_DATE",
                        "CURRENT_LIST_PRICE", "ISSUE_SCOREB", "ISSUE_SCOREC", "CURR_SCOREB",
                        "CURR_SCOREC", "MI_TYPE", "SERV_IND", "CURRENT_PERIOD_MODIFICATION_LOSS_AMOUNT",
                        "CUMULATIVE_MODIFICATION_LOSS_AMOUNT", "CURRENT_PERIOD_CREDIT_EVENT_NET_GAIN_OR_LOSS",
                        "CUMULATIVE_CREDIT_EVENT_NET_GAIN_OR_LOSS", "HOMEREADY_PROGRAM_INDICATOR",
                        "FORECLOSURE_PRINCIPAL_WRITE_OFF_AMOUNT", "RELOCATION_MORTGAGE_INDICATOR",
                        "ZERO_BALANCE_CODE_CHANGE_DATE", "LOAN_HOLDBACK_INDICATOR", "LOAN_HOLDBACK_EFFECTIVE_DATE",
                        "DELINQUENT_ACCRUED_INTEREST", "PROPERTY_INSPECTION_WAIVER_INDICATOR",
                        "HIGH_BALANCE_LOAN_INDICATOR", "ARM_5_YR_INDICATOR", "ARM_PRODUCT_TYPE",
                        "MONTHS_UNTIL_FIRST_PAYMENT_RESET", "MONTHS_BETWEEN_SUBSEQUENT_PAYMENT_RESET",
                        "INTEREST_RATE_CHANGE_DATE", "PAYMENT_CHANGE_DATE", "ARM_INDEX",
                        "ARM_CAP_STRUCTURE", "INITIAL_INTEREST_RATE_CAP", "PERIODIC_INTEREST_RATE_CAP",
                        "LIFETIME_INTEREST_RATE_CAP", "MARGIN", "BALLOON_INDICATOR",
                        "PLAN_NUMBER", "FORBEARANCE_INDICATOR", "HIGH_LOAN_TO_VALUE_HLTV_REFINANCE_OPTION_INDICATOR",
                        "DEAL_NAME", "RE_PROCS_FLAG", "ADR_TYPE", "ADR_COUNT", "ADR_UPB")
lppub_column_classes <- c("character", "character", "character", "character", "character", "character",
                          "character", "numeric", "numeric", "numeric", "numeric",
                          "numeric", "numeric", "character", "character", "numeric", "numeric",
                          "numeric", "character", "numeric", "numeric", "character", "numeric",
                          "numeric", "numeric", "character", "character", "character",
                          "numeric", "character", "character", "character", "character",
                          "numeric", "character", "character", "character", "character",
                          "numeric", "character", "character", "character", "character",
                          "character", "character", "numeric", "character", "numeric",
                          "numeric", "numeric", "character", "character", "character",
                          "numeric", "numeric", "numeric", "numeric", "numeric", "numeric",
                          "numeric", "numeric", "numeric", "numeric", "numeric", "character",
                          "numeric", "character", "numeric", "numeric", "numeric", "numeric",
                          "numeric", "numeric", "character", "numeric", "numeric", "numeric",
                          "numeric", "character", "numeric", "character", "numeric", "character",
                          "numeric", "numeric", "character", "character", "numeric", "numeric",
                          "numeric", "numeric", "numeric", "numeric", "numeric", "numeric",
                          "numeric", "numeric", "numeric", "numeric", "numeric", "character",
                          "character", "character", "character", "character",
						  "character", "numeric", "numeric")

files = list.files(file.path(data_folder,'/1pct'),glob2rx('*.1pct'), full.names = TRUE )

#'SELLER',	'SERVICER',	'MASTER_SERVICER','MI_CANCEL_FLAG', 'FIRST_PAY', 'REM_MONTHS', 'ORIG_RATE'
select_columns = c(
  'LOAN_ID',	'ACT_PERIOD',	'CHANNEL',	'CURR_RATE',	'ORIG_UPB',	'CURRENT_UPB',	'ORIG_TERM',	'ORIG_DATE',	'LOAN_AGE',	'ADJ_REM_MONTHS',	'OLTV',	'OCLTV',	'NUM_BO',	'DTI',	'CSCORE_B',	'CSCORE_C',	'FIRST_FLAG',	'PURPOSE',	'PROP',	'NO_UNITS',	'OCC_STAT',	'STATE',	'MI_PCT',	'PRODUCT',	'PPMT_FLG',	'IO', 'DLQ_STATUS', 'MOD_FLAG',	'Zero_Bal_Code')

### Load new origination
df = foreach(file_name = files, .combine = rbind) %do% {
  print(file_name)
  #temp = fread(file_name, sep = "|", col.names = lppub_column_names, colClasses = lppub_column_classes, nrows = 10)
  keep_columns = match(select_columns, lppub_column_names)
  temp = fread(file_name, sep = "|", 
               col.names = lppub_column_names[keep_columns], 
               colClasses = lppub_column_classes, 
               select = keep_columns)
  temp = temp[PRODUCT == 'FRM' & MOD_FLAG != 'Y' & IO == 'N' & PPMT_FLG == 'N' & ORIG_TERM == 360]
  temp[, c('PRODUCT', 'MOD_FLAG', 'IO','ORIG_TERM', 'PPMT_FLG'):=NULL]
  
  #all_loans = unique(temp$LOAN_ID)
  #select_loans = sample(all_loans, floor(load_pct*length(all_loans)) )
  #temp = temp[LOAN_ID %in% select_loans]
  
  #gc()
  return(temp)
}

df[, date:= to_date(ACT_PERIOD)]
df[, date_year:= year(date)]
df[, ACT_PERIOD:=NULL]

df[, orig_date:= to_date(ORIG_DATE)]
df[, orig_year:= year(orig_date)]
df[, orig_year_c:= as.character(orig_year)]
df[, ORIG_DATE:=NULL]

df = df[orig_year>=2010]

setkeyv(df, c('LOAN_ID', 'date'))

#Compute prev UPB and delq
df[, upb := 1e-3*CURRENT_UPB]

#replace UPB with scheduled balance for the first 12 months if it is zero
df[CURRENT_UPB == 0 & Zero_Bal_Code == '' & LOAN_AGE <=24, upb :=  1e-3*ORIG_UPB * sched_balance(LOAN_AGE, CURR_RATE, 360) ]
#df[LOAN_ID == '000098915594',.(date, CURRENT_UPB, LOAN_AGE)]

#define PO flag
df[order(date), Zero_Bal_Code_next := shift(Zero_Bal_Code, -1),  by =.(LOAN_ID)] 
df[, po_ind := as.numeric(Zero_Bal_Code_next == '01') *  as.numeric(DLQ_STATUS == '00')] #next month loan will PO, only prepayment from current are considered 

#df[order(date), LOAN_AGE  := na.locf(LOAN_AGE, na.rm = FALSE),  by =.(LOAN_ID)]
df[order(date), CURR_RATE := na.locf(CURR_RATE, na.rm = FALSE), by =.(LOAN_ID)] # the rate should be fixed

df[order(date), sbal := pmax(0, upb * (1 + CURR_RATE/1200) - 1e-3*pmt(CURR_RATE, 360) * ORIG_UPB), by =.(LOAN_ID)] #next month sched balance, assume fixed payment 
df[is.na(sbal), sbal := upb ] #just in case 
df[order(date), delq_24 := frollsum(as.numeric(DLQ_STATUS!='00'), 24), by =.(LOAN_ID) ] 

#df[order(date), unsched_princ := shift(sbal) - upb, by=.(LOAN_ID) ]
#df[order(date), smm := unsched_princ/shift(sbal), by=.(LOAN_ID) ]
#temp

#saveRDS(df, 'D:/loan_level/fnma_1pct.rds')
#df <- readRDS('D:/loan_level/fnma_1pct.rds')

#saveRDS(df, 'D:/loan_level/fnma_10pct.rds')
#df <- readRDS('D:/loan_level/fnma_10pct.rds')
	

#df[Zero_Bal_Code_next == '01' & date == '2005-01-01', LOAN_ID]
#cc(df[LOAN_ID == '999997761057'])
#df[LOAN_ID == '999961864686', .(date, CURR_RATE, LOAN_AGE,ORIG_UPB, upb, CURRENT_UPB, sbal, po_ind, Zero_Bal_Code, DLQ_STATUS, delq_24)]
df = df[!is.na(po_ind)] #remove last date 
```

## Load FNMA loan data
load 1% of loans
```{r load_data}
df <- readRDS('D:/loan_level/fnma_1pct.rds')
```
## show data

```{r show_data}

df_agg = df[,.(.N), by =.(date, Zero_Bal_Code_next)]
ggplot(df_agg, aes(date, N)) + geom_point() + facet_wrap(~Zero_Bal_Code_next, scales = 'free')

df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE), 
               po = mean(po_ind,na.rm = TRUE), 
               smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date)]

ggplot(df_agg, aes(date, N)) + geom_point()
ggplot(df_agg, aes(date, upb)) + geom_point()
ggplot(df_agg, aes(date, upb/N)) + geom_point() + geom_line()
ggplot(df_agg, aes(date, smm2cpr(po) )) + geom_point() + geom_line() + geom_line(aes(date, smm2cpr(smm) ), color = 'red')
ggplot(df_agg, aes(date,  smm2cpr(smm)  )) + geom_point() + geom_line()

df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE)), by=.(date, orig_year)]
ggplot(df_agg, aes(date, upb, group = orig_year)) + geom_line()

df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE), smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date, orig_year)]
ggplot(df_agg, aes(date, smm, group = orig_year)) + geom_line()

df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE), smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date, PROP)]
ggplot(df_agg, aes(date, smm2cpr(smm), group = PROP)) + geom_line() + facet_wrap(~PROP)
ggplot(df_agg, aes(date, upb/N, group = PROP, color = PROP)) + geom_line()

```

## Objective Function

```{r obj_function}

df_obj = data.table(smm = seq(cpr2smm(1), cpr2smm(50), by = 0.0001 ))
df_obj[, lsqr_10 := (smm - cpr2smm(10))^2]
df_obj[, lsqr_20 := (smm - cpr2smm(20))^2]
df_obj[, lsqr_30 := (smm - cpr2smm(30))^2]

df_obj[, loglik_10 := -(cpr2smm(10)  * log(smm) + (1-cpr2smm(10)) * log(1-smm)) ]
df_obj[, loglik_20 := -(cpr2smm(20)  * log(smm) + (1-cpr2smm(20)) * log(1-smm)) ]
df_obj[, loglik_30 := -(cpr2smm(30)  * log(smm) + (1-cpr2smm(30)) * log(1-smm)) ]

ggplot(melt(df_obj, id.vars = 'smm')) + geom_line(aes(smm2cpr( smm ), value, group = variable, color = variable  )) + facet_wrap(~variable, scales = 'free')

ggplot(melt(df_obj, id.vars = 'smm')) + geom_line(aes( smm, value, group = variable, color = variable  )) + facet_wrap(~variable, scales = 'free')

```

## Sampling

```{r sampling}

#sample loans

df_agg = df[,.(.N, sbal = sum(upb, na.rm = TRUE), 
               po = mean(po_ind,na.rm = TRUE), 
               smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date)]

df_boot = ldply(seq(100), function(i){
  df_temp = df[sample.int(nrow(df), 0.1*nrow(df)),.(.N, sbal = sum(sbal, na.rm = TRUE), 
               po = mean(po_ind,na.rm = TRUE), 
               smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date)]
  df_temp[, boot := i]
})
setDT(df_boot)

ggplot(df_boot, aes(date,  smm2cpr(smm), group = boot  )) + geom_line(color = 'blue', alpha = 0.1) + 
  geom_line(data = df_agg, aes(date,  smm2cpr(smm)), inherit.aes = FALSE, size = 1 )


ggplot(df_boot[,.(smm = weighted.mean(smm, sbal, na.rm = TRUE)), by =.(date)], aes(date,  smm2cpr(smm))) + geom_line(color = 'blue', size = 1) + 
  geom_line(data = df_agg, aes(date,  smm2cpr(smm)), inherit.aes = FALSE, size = 1 )

#Single Date --------------------
my_date = '2020-07-01'

dfs = df[date == my_date]
   
dfs[,.(.N, sbal = sum(upb, na.rm = TRUE), 
               po = smm2cpr(mean(po_ind,na.rm = TRUE)), 
               smm = smm2cpr(weighted.mean(po_ind, sbal, na.rm = TRUE)) ), by=.(date)]

df_boot_res = ldply(seq(1000, 91310, by = 1000), function(boot_size){
  df_boot = ldply(seq(100), function(i){
    df_temp = dfs[sample.int(nrow(dfs), boot_size, replace = TRUE),.(.N, sbal = sum(sbal, na.rm = TRUE),  po = mean(po_ind,na.rm = TRUE), smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date)]
    df_temp[, boot := i]
  })
  df_boot$boot_size=boot_size
  return(df_boot)
})
setDT(df_boot_res)

ggplot(df_boot_res, aes(boot_size,  smm)) + geom_point()

ggplot(df_boot_res[, .(.N, cpr_sigma = smm2cpr(sd(smm)) ), by =.(boot_size)], aes(log10(boot_size), cpr_sigma)) + geom_line() + geom_point()

ggplot(df_boot_res[, .(.N, cpr_sigma =  smm2cpr(sd(smm)) ), by =.(boot_size)], aes(log10(boot_size), log10(cpr_sigma) )) + geom_line() + geom_point()

df_boot_res[, .(.N, smm_var = smm2cpr(sd(smm)) ), by =.(boot_size)]


### Sample by loans
all_loans = unique(df$LOAN_ID)

df_boot = ldply(seq(100), function(i){
  df_temp = df[LOAN_ID %in% sample(all_loans, length(all_loans), replace = TRUE),.(.N, sbal = sum(sbal, na.rm = TRUE), 
               po = mean(po_ind,na.rm = TRUE), 
               smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date)]
  df_temp[, boot := i]
})
setDT(df_boot)

ggplot(df_boot, aes(date,  smm2cpr(smm), group = boot  )) + geom_line(color = 'blue', alpha = 0.1) + 
  geom_line(data = df_agg, aes(date,  smm2cpr(smm)), inherit.aes = FALSE, size = 1 )

df_boot_conf =  df_boot[,.(smm = weighted.mean(smm, sbal, na.rm = TRUE), smm_up = quantile(smm, 1-0.05/2), smm_dn = quantile(smm, 0.05/2)), by =.(date)]

ggplot(df_boot_conf) + geom_ribbon(fill = 'blue', aes(date, ymin = smm2cpr(smm_dn), ymax = smm2cpr(smm_up)), alpha = 0.6) + 
  geom_line(data = df_agg, aes(date,  smm2cpr(smm)), inherit.aes = FALSE, size = 1 )

ggplot(df_boot_conf) + geom_line(aes(date,smm2cpr(smm_up) - smm2cpr(smm_dn)))

#last Date observations
dfs = df[date == max(date)]
dfs[, smm2cpr(mean(po_ind)) ]
dfs[, smm2cpr(weighted.mean(po_ind, sbal, na.rm = TRUE)) ]

df_boot = ldply(seq(1000), function(i){
  df_temp = dfs[sample.int(nrow(dfs), nrow(dfs), replace = TRUE),.(.N, sbal = sum(sbal, na.rm = TRUE), po = mean(po_ind,na.rm = TRUE), smm = weighted.mean(po_ind, sbal, na.rm = TRUE)), by=.(date)]
  df_temp[, boot := i]
})
setDT(df_boot)

ggplot(df_boot, aes(smm2cpr(po))) + geom_histogram() + 
  geom_vline(xintercept = dfs[, smm2cpr(mean(po_ind)) ], linetype = 'dashed', color = 'blue') + 
  geom_vline(xintercept = quantile(smm2cpr(df_boot$po), prob = c(0.05/2, 1-0.05/2 )), linetype = 'dashed', color = 'red')

ggplot(df_boot, aes(smm2cpr(smm))) + geom_histogram() + 
  geom_vline(xintercept = dfs[, smm2cpr(weighted.mean(po_ind, sbal, na.rm = TRUE)) ], linetype = 'dashed', color = 'blue') + 
  geom_vline(xintercept = quantile(smm2cpr(df_boot$smm), prob = c(0.05/2, 1-0.05/2 )), linetype = 'dashed', color = 'red')

smm_avg = dfs[, weighted.mean(po_ind, sbal, na.rm = TRUE) ]
smm_sigma = smm2cpr(sqrt(smm_avg * (1 - smm_avg)/nrow(dfs)))

neff = effective_size(dfs$sbal)
smm2cpr(smm_avg + 2*(sqrt(smm_avg * (1 - smm_avg)/neff)))

#https://statisticaloddsandends.wordpress.com/2021/11/11/what-do-we-mean-by-effective-sample-size/

#effective_size_rho2 <- function(w, rho = 0){
#  sum(w)^2 / (sum(w*w) * (1 - rho) + rho * sum( w %*% t(w)) )
#}

df_rho = data.table(rho = seq(0, 0.01, by = 0.00001))
df_rho[, n_eff := effective_size_rho(dfs$sbal, rho)]
df_rho[, cpr_sigma := smm2cpr((sqrt(smm_avg * (1 - smm_avg)/n_eff)))]
df_rho[, cpr_ub := smm2cpr(smm_avg + 2*(sqrt(smm_avg * (1 - smm_avg)/n_eff)))]
df_rho[, cpr_lb := smm2cpr(smm_avg - 2*(sqrt(smm_avg * (1 - smm_avg)/n_eff)))]

ggplot(df_rho, aes(100*rho, n_eff)) + geom_line()

ggplot(df_rho, aes(100*rho, ymin = cpr_ub, ymax = cpr_lb)) + geom_ribbon(alpha = 0.4)
ggplot(df_rho, aes(100*rho,cpr_sigma)) + geom_line()

m = matrix(rep(0.1, 100), nrow = 10)
diag(m) <- rep(1, 10)
eigen(m)$values
effective_size(eigen(m)$values )
```


##Load MEV

```{r load_mev}
#load mortgage rate
df_mtg = fread("W:/FRED/MORTGAGE30US.csv")
df_mtg[, date:= make_date(year(DATE), month(DATE), 1)]
df_mtg = df_mtg[, .(rate = mean(MORTGAGE30US, na.rm = TRUE)), by =.(date)] #simple average

df_hpi = fread("W:/FRED/CSUSHPINSA.csv")
df_hpi[, date:= make_date(year(DATE), month(DATE), 1)]
df_hpi[, hpi := CSUSHPINSA]
df_hpi[order(date), hpi_1y := shift(hpi, 12)]
df_hpi[order(date), hpi_2y := shift(hpi, 24)]
df_hpi[, hpa    := 100*(hpi/ hpi_1y - 1)]
df_hpi[, hpa_2y := 100*(hpi/ hpi_2y - 1)]

df_uer = fread("W:/FRED/UNRATE.csv")
df_uer[, date:= make_date(year(DATE), month(DATE), 1)]
df_uer[, uer := UNRATE]


df_mev = df_mtg[df_hpi[,.(date, hpi, hpa, hpa_2y)], on=.(date)]
df_mev = df_mev[df_uer[,.(date, uer)], on=.(date)]
df_mev = df_mev[!is.na(rate)]
df_mev[order(date), rate_1m := shift(rate, 1)]
df_mev[order(date), rate_3m48:=frollmean(rate, 3) - frollmean(rate, 48)]
df_mev[order(date), rate_1m48:=rate               - frollmean(rate, 48)]
df_mev[order(date), rate_3m60:=frollmean(rate, 3) - frollmean(rate, 60)]
df_mev[order(date), rate_1m60:=rate               - frollmean(rate, 60)]
df_mev[order(date), uer_1m60 :=uer                - frollmean(uer,  60)]
df_mev[order(date), uer_1m36 :=uer                - frollmean(uer,  36)]
df_mev[order(date), uer_3m36 := frollmean(uer,  3) - frollmean(uer,  36)]
df_mev[order(date), uer_1y :=uer - shift(uer, 12)]
df_mev[order(date), hpi_1m60 :=hpi                - frollmean(hpi,  60)]
df_mev[order(date), hpi_1m36 :=hpi                - frollmean(hpi,  36)]

setkey(df_mev,'date')

df_busday = data.table(date = min(df$date) + seq(0, max(df$date) - min(df$date)))
df_busday[, date_month := make_date(year(date), month(date), 1)]
df_busday[, date_week := wday(date)]
df_busday = df_busday[date_week %!in% c(1, 7),.(.N), by=date_month][N>15]

# ----------------------------------------
if(FALSE){
  ggplot(df_mev[date>'2000-01-01'], aes(date, rate)) + geom_line()
  ggplot(df_mev[date>'2000-01-01'], aes(date, rate_3m48)) + geom_line()
  ggplot(df_mev[date>'2000-01-01'], aes(date, rate_1m60)) + geom_line()
  ggplot(df_mev[date>'2000-01-01'], aes(date, hpi)) + geom_line()
  ggplot(df_mev[date>'2000-01-01'], aes(date, hpa)) + geom_line()
}

```

##UWAC

```{r uwac_model}
df_agg = df[LOAN_AGE == 1,.(.N, upb = sum(upb, na.rm = TRUE), wac = weighted.mean(CURR_RATE, upb, na.rm = TRUE )), by=.(orig_date)]
ggplot(df_agg, aes(orig_date, wac)) + geom_point() + geom_line() + geom_line(data = df_mev[date>'2009-01-01'], aes(date, rate_1m), color = 'red')

#ccf(df_agg$wac, df_agg$inc, lag.max = 5, plot = FALSE)

df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE), uwac = weighted.mean(CURR_RATE, upb, na.rm = TRUE )), by=.(date)]
df_mev[df_agg, uwac:=i.uwac, on =.(date)]
df_mev[order(date), uwac_delta := shift(uwac, -1) - uwac]

ggplot(df_mev[date>'2010-01-01'], aes(date, uwac)) + geom_point() + geom_line() + geom_line(aes(date, rate), color = 'red')
ggplot(df_mev[date>'2010-01-01'], aes(rate - uwac, uwac_delta)) + geom_point() + geom_smooth(span = 0.9, se = FALSE, method = 'loess')

df_media = df_mev[date>'2010-01-01', .(date, media_ei_lin = rate - uwac_model(rate), media_ei_log = rate - uwac_model(rate, logistic = TRUE), rate_1m48, rate_1m60) ]

df_media = melt(df_media, id.vars = 'date')
ggplot(df_media, aes(date, value, group = variable, color = variable)) +geom_line() + scale_color_custom('mixed')

#lm(uwac_delta ~ I(rate - uwac), df_mev[date>'2010-01-01' & rate - uwac < 0])

df_mev[order(date), media_ei_lin := rate - uwac_model(rate, logistic = FALSE) ]
df_mev[order(date), media_ei_log := rate - uwac_model(rate, logistic = TRUE) ]

ggplot(df_mev) + geom_line(aes(date, media_ei_log)) + geom_line(aes(date, media_ei_lin))

```

## Create variables

```{r create_variables}

df_mev[order(date), media_ei_lin := rate - uwac_model(rate, logistic = FALSE) ]
df_mev[order(date), media_ei_log := rate - uwac_model(rate, logistic = TRUE) ]

df[df_mev, ei_ratio := 100*(CURR_RATE/i.rate-1), on =.(date)]
df[df_mev, ei       := 100*(CURR_RATE - i.rate   ), on =.(date)]
df[df_mev, ei_1m    := 100*(CURR_RATE - i.rate_1m), on =.(date)]
df[df_mev, hpi       := i.hpi, on =.(date)]
df[df_mev, hpa       := i.hpa, on =.(date)]
df[df_mev, hpa_2y    := i.hpa_2y, on =.(date)]
df[df_mev, hpi_orig  := i.hpi, on =.(orig_date = date)]
df[df_mev, sato   :=  100*(CURR_RATE - i.rate), on =.(orig_date = date)]


df[df_mev, media_ei_log   := 100*i.media_ei_log, on =.(date)]
df[df_mev, media_ei_lin   := 100*i.media_ei_lin, on =.(date)]
df[df_mev, rate_1m48  := i.rate_1m48, on =.(date)]
df[df_mev, rate_3m48  := i.rate_3m48, on =.(date)]
df[df_mev, rate_1m60  := i.rate_1m60, on =.(date)]
df[df_mev, rate_3m60  := i.rate_3m60, on =.(date)]

df[df_mev, hpi_1m60  := i.hpi_1m60, on =.(date)]
df[df_mev, hpi_1m36  := i.hpi_1m36, on =.(date)]

df[df_mev, uer       := i.uer,      on =.(date)]
df[df_mev, uer_1m60  := i.uer_1m60, on =.(date)]
df[df_mev, uer_1m36  := i.uer_1m36, on =.(date)]
df[df_mev, uer_3m36  := i.uer_3m36, on =.(date)]
df[df_mev, uer_1y    := i.uer_1y,   on =.(date)]
df[df_busday, busday := i.N,   on =.(date = date_month  )]
df[, date_year_s:= as.character(date_year)]



df[, factor := upb / (1e-3*ORIG_UPB) ]
df[, CLTV   :=  OLTV * factor * hpi_orig / hpi ]
df[, house_value :=  (hpi / hpi_orig) * (0.1*ORIG_UPB /OLTV)]
df[, hpa_life  :=   hpi/hpi_orig - 1 ]
df[, season := month(date)]
df[, season_s := sprintf('%02d', season) ]
df[, geo_ny  := as.numeric(STATE == 'NY')]
df[, geo_pr  := as.numeric(STATE == 'PR')]
df[, co_borrower  := as.numeric(!is.na(CSCORE_C))]
df[, score_diff   := CSCORE_B - CSCORE_C]
df[, no_cscore := is.na(CSCORE_B)]
df[, adj_age := 360-ADJ_REM_MONTHS-LOAN_AGE]

#cum incentive
df[order(date), cum_ei   := 0.01*cumsum(pmax(0, ei - 10)), by =.(LOAN_ID)]
df[order(date), cum_eim  := cumsum(logistic( (ei - 30)/5 )), by =.(LOAN_ID)]

df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE), po = mean(po_ind, na.rm = TRUE), 
               smm = weighted.mean(po_ind, sbal, na.rm = TRUE ),
               ei = weighted.mean(ei, sbal)), by=.(date)]

#ccf(df_agg$smm, df_agg$ei, lag.max = 5)
ccf(df_agg$smm, df_agg$ei, lag.max = 5, plot = FALSE)

if(FALSE){
  #ggplot(df_agg, aes(smm, inc)) + geom_point()
  ggplot(df_agg, aes(date, N)) + geom_point()
  ggplot(df_agg, aes(date, upb)) + geom_point()
  ggplot(df_agg, aes(date, upb/N)) + geom_point()
  ggplot(df_agg, aes(date, ei)) + geom_point() + geom_line() 
  ggplot(df_agg, aes(date, po)) + geom_point() + geom_line() + geom_line(aes(date, smm), color = 'red')
  ggplot(df_agg, aes(date, ei/2)) + geom_point() + geom_line() + geom_line(aes(date, smm2cpr(smm)), color = 'red')
  
  df_agg = df[,.(.N, upb = sum(upb, na.rm = TRUE), po = mean(po_ind), 
                 smm = weighted.mean(po_ind, sbal, na.rm = TRUE )), by=.(LOAN_AGE)]
  
  ggplot(df_agg, aes(LOAN_AGE, upb/N)) + geom_point()
  ggplot(df_agg[N>100], aes(LOAN_AGE, po)) + geom_point() + geom_line() + geom_line(aes(LOAN_AGE, smm), color = 'red')
  
  plot_profile(df$po_ind, df$po_ind, df$date)
  plot_profile(df$po_ind, df$po_ind, df$ei)
  plot_profile(df$po_ind, df$po_ind, df$cum_ei)
  plot_profile(df$po_ind, df$po_ind, df$cum_eim)
}
```


## ML Model

```{r ml_model}
## ----------------------------------------------
library(lightgbm)

set.seed(1321)

t_index_v = sample.int(nrow(df), 2e6)
v_index_v = sample.int(nrow(df), 2e6) %!in_set% t_index_v

obj_var = 'po_ind'
media_vars = c('media_ei_lin', 'media_ei_log', 'rate_1m48', 'rate_1m60', 'rate_3m48', 'rate_3m60')
burnout_vars = c('cum_ei', 'cum_eim', 'factor') #'cum_ei', 'factor'
lgb_vars = c('ei', 'LOAN_AGE', 'season', 'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','PROP', 'DTI', 'CSCORE_B', 'co_borrower','score_diff', 'FIRST_FLAG', 'CLTV', 'OLTV', 'rate_1m48', 'sato', 'cum_eim', 'geo_ny', 'geo_pr', 'NO_UNITS', 'hpa', 'hpa_life', 'busday') %!in_set% c('id') #best performance
#lgb_vars = c('ei', 'LOAN_AGE', 'season', 'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','DTI', 'CSCORE_B',  'CLTV') %!in_set% c('id') #best performance

my_cat_vars =  names(which(sapply(df[,lgb_vars, with = FALSE], function(x) is.factor(x) | is.character(x) )))

### - logistic regression for loss > 0 -----------
dfs = df[t_index_v, c(obj_var,lgb_vars), with = FALSE]

dtrain <- lgb.Dataset(data.matrix(dfs[, lgb_vars , with = FALSE]), label = dfs[[obj_var]], categorical_feature = my_cat_vars)
dtest  <- lgb.Dataset.create.valid(dtrain, data.matrix(df[v_index_v, lgb_vars , with = FALSE]), label = df$po_ind[v_index_v])

params_bin <- list(objective = "binary")

model.lgb = lgb.train(params = params_bin, data = dtrain, learning_rate = 0.01,
                      valids = list(test = dtest),
                      num_threads = 4, nrounds = 3000,
                      eval_freq = 100, boost_from_average = TRUE, verbose = 1, force_row_wise = TRUE)

cv_error = as.numeric(model.lgb$record_evals$test$binary_logloss$eval)
ggplot(data.frame( i = seq(length(cv_error)), cv_error ), aes(i, cv_error)) + geom_line() + geom_vline(xintercept = model.lgb$best_iter, linetype = 'dashed')

lgb_importance = lgb.importance(model.lgb, percentage = TRUE)
ggplot(lgb_importance[Gain > 0.001], aes(fct_reorder(Feature,Gain), Gain)) + geom_bar(stat = 'identity') + coord_flip()
 
df[, po_pred := predict(model.lgb, data.matrix(df[,lgb_vars, with = F]))]

plot_act_vs_model <-function(df, profile, index = NULL, ...){
  p = NULL
  if(is.null(index)) {
    p = plot_profile(df[['po_pred']], df[['po_ind']], df[[profile]], map_fun = smm2cpr, ...)
  }else{
    p = plot_profile(df[['po_pred']][index], df[['po_ind']][index], df[[profile]][index], map_fun = smm2cpr, ...)
  }
  return( p )
}
plot_act_vs_model(df, 'LOAN_AGE', bucket_count = 50)
plot_act_vs_model(df, 'date', bucket_count = 50)
plot_act_vs_model(df, 'ei', bucket_count = 50)
plot_act_vs_model(df, 'sato', bucket_count = 50)
plot_act_vs_model(df, 'ei_ratio', bucket_count = 50)


#turnover
vname = 'LOAN_AGE'
p1 = plot_act_vs_model(df, vname,  df$ei < 0, bucket_count = 20) + ggtitle('turnover')
p2 = plot_act_vs_model(df, vname,             bucket_count = 20) + ggtitle('prepayment')
grid.arrange(p1, p2)

plot_act_vs_model(df, 'LOAN_AGE', index, bucket_count = 50)

index = df$STATE == 'NY'
plot_act_vs_model(df, 'date')

index = df$PROP == 'PU'
plot_act_vs_model(df, 'date', index)

#all states
plots = llply(unique(df$STATE), function(my_state) { #lgb_vars
  index = df$STATE == my_state
    p =plot_act_vs_model(df, 'date', index, error_band = 'binom') + ggtitle(my_state) +  theme(title =element_text(size=8))
    return( ggplotGrob(p) )
  })
#marrangeGrob(plots, nrow = 6, ncol = 7, top = NULL)
ggsave(filename = "D:/loan_level/profiles_by_state.pdf", plot = marrangeGrob(plots, nrow=3, ncol=4), device = 'pdf', width = 14, height = 8.5, dpi = 360)


#all profiles
plots = llply(names(df) %!in_set% c('LOAN_ID', 'CURRENT_UPB', 'Zero_Bal_Code', 'smm', 'Zero_Bal_Code_next'), function(var_name) { #lgb_vars
  print(var_name)
    p = plot_act_vs_model(df, var_name, bucket_count = 20, error_band = 'binom') + ggtitle(var_name) +  theme(title =element_text(size=8))
    return( ggplotGrob(p) )
  })
#marrangeGrob(plots, nrow = 6, ncol = 7, top = NULL)
ggsave(filename = "D:/loan_level/profiles_all.pdf", plot = marrangeGrob(plots, nrow=4, ncol=4), device = 'pdf', width = 14, height = 8.5, dpi = 360)

plots = llply(c('date','cum_eim', 'cum_ei', 'media_ei_log', 'media_ei_lin', 'rate_1m48', 'rate_3m48', 'rate_1m60', 'rate_3m60', 'uer', 'hpa', 'uer_1m60'), function(var_name) { #lgb_vars
  print(var_name)
    p = plot_act_vs_model(df, var_name, bucket_count = 10, error_band = 'binom') +
      ggtitle(var_name) +  theme(title =element_text(size=8))
    return( ggplotGrob(p) )
  })
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)


for(vname in names(df) %!in_set% c('LOAN_ID', 'CURRENT_UPB', 'Zero_Bal_Code', 'smm', 'Zero_Bal_Code_next', 'po_pred', 'date', 'DLQ_STATUS', 'orig_date')) {
  print(vname)
  #vname = 'PURPOSE'
  #vname = 'upb'
  if(is.numeric(df[[vname]])){
    segments = cutq(df[[vname]], probs = seq(0, 1, 0.25))
    buckets = levels(segments)
  }else{
    segments = df[[vname]]
    buckets = df[,.(.N), by =c(vname)][[vname]]
  }
  
  plots_turn = llply(buckets, function(my_level){
     index = segments == my_level & df$ei < 0
     p = plot_act_vs_model(df, 'date', index, error_band = 'binom') + ggtitle(sprintf('%s, turnover (ei < 0)', my_level)) +  theme(title = element_text(size=8))   
    })
  
    plots = llply(buckets, function(my_level){
     index = segments == my_level
     p = plot_act_vs_model(df, 'date', index, error_band = 'binom') + ggtitle(my_level) +  theme(title = element_text(size=8))   
    })
  ggsave(filename = sprintf("D:/loan_level/profiles_%s.pdf", vname), plot = marrangeGrob(c(plots_turn, plots), nrow=2, ncol=2,top = vname), device = 'pdf', width = 14, height = 8.5, dpi = 360)
}

#partial plots --------- 
pdp_index = sample.int(nrow(df), 1000)
data_mat = data.matrix(df[pdp_index,lgb_vars, with = FALSE])

plots = llply(lgb_importance$Feature, function(my_var){
  df_plot = partialPlot(model.lgb, data_mat, xname = my_var, n.pt = 100)
  ggplot(df_plot, aes(x, smm2cpr(y) )) + geom_line() + 
    #geom_rug(data = df[pdp_index, my_var, with = FALSE], aes_string(x=my_var), sides = 'b', alpha = 0.2, size = 0.1, inherit.aes = FALSE) + 
    ggtitle(my_var) + xlab(my_var) + ylab('cpr')
})
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)

ggsave(filename = "D:/loan_level/partial_profiles_baseline.pdf", plot = marrangeGrob(plots, nrow=3, ncol=3,top = NULL), device = 'pdf', width = 14, height = 8.5, dpi = 360)

```

#Parametric Model
```{r parametric_model}

t_index_v = sample.int(nrow(df), 5e6)


plot_act_vs_model2 <-function(df, profile, index = NULL, ...){
  p = NULL
  if(is.null(index)) {
    p = plot_profile(df[['model_smm']], df[['po_ind']], df[[profile]], map_fun = smm2cpr, ...)
  }else{
    p = plot_profile(df[['model_smm']][index], df[['po_ind']][index], df[[profile]][index], map_fun = smm2cpr, ...)
  }
  return( p )
}

skewed_logistic1 <-function(x, alpha = 1){  (1+exp(-x))^(-alpha) }
skewed_logistic2 <-function(x, alpha){  1-exp(-alpha * x) / (1+exp(-x))^alpha }
scurve <- function(x, a, b, shift, slope){   a + (b - a)*logistic((x - shift)/slope) }
scurve_skew <- function(x, a, b, shift, slope, skew = 1){   a + (b - a)*skewed_logistic1((x - shift)/slope, skew) }

smm_model <- function(x, params){
    turn_scurve = scurve(x$ei, params[['turn_scurve_low']], params[['turn_scurve_high']], params[['turn_scurve_shift']], params[['turn_scurve_slope']])
    turn_ramp = approx(params[['turn_ramp_x']], params[['turn_ramp_y']], rule = 2, x$LOAN_AGE)$y
    turn_season = approx(params[['turn_season_x']], params[['turn_season_y']], rule = 2, x$season)$y
    turn_fico = approx(params[['turn_fico_x']], params[['turn_fico_y']], rule = 2, x$CSCORE_B)$y
    turn_fico[is.na(x$CSCORE_B)] = params[['turn_fico_na']]
    turn_cltv = approx(params[['turn_cltv_x']], params[['turn_cltv_y']], rule = 2, x$CLTV)$y
    turn_als = approx(params[['turn_als_x']], params[['turn_als_y']], rule = 2, x$upb)$y
    turn_occ =  params[['turn_occ_y']][ match(x$OCC_STAT, params[['turn_occ_x']])]
    turn_hpal = approx(params[['turn_hpal_x']], params[['turn_hpal_y']], rule = 2, x$hpa_life)$y
    turn_uer = approx(params[['turn_uer_x']], params[['turn_uer_y']], rule = 2, x$uer)$y
    turn_uer1m60 = approx(params[['turn_uer1m60_x']], params[['turn_uer1m60_y']], rule = 2, x$uer_1m60)$y
    turn_geo =  params[['turn_geo_y']][ match(x$STATE,  params[['turn_geo_x']])]
    turn_geo[is.na(turn_geo)] = 1.0
    turn_nounit = approx(params[['turn_nounit_x']], params[['turn_nounit_y']], rule = 2, x$NO_UNITS)$y
    turn_sato = approx(params[['turn_sato_x']], params[['turn_sato_y']], rule = 2, x$sato)$y
    
    turn_purpose =  params[['turn_purpose_y']][ match(x$PURPOSE,  params[['turn_purpose_x']])]
    turn_purpose[is.na(turn_purpose)] =1.0
    
    
    turn_prop =  params[['turn_prop_y']][ match(x$PROP,  params[['turn_prop_x']])]
    turn_prop[is.na(turn_prop)] =1.0
    
    refi_scurve =  scurve(x$ei, params[['refi_scurve_low']], params[['refi_scurve_high']],  params[['refi_scurve_shift']], params[['refi_scurve_slope']])
    refi_boost   = scurve(x$ei, params[['refi_boost_low']],  params[['refi_boost_high']],   params[['refi_boost_shift']],  params[['refi_boost_slope']])
    refi_boost2  = scurve(x$ei, params[['refi_boost2_low']],  params[['refi_boost2_high']],   params[['refi_boost2_shift']],  params[['refi_boost2_slope']])
    
    refi_ramp = approx(params[['refi_ramp_x']], params[['refi_ramp_y']], rule = 2, x$LOAN_AGE)$y
    refi_als = approx(params[['refi_als_x']], params[['refi_als_y']], rule = 2, x$upb)$y
    refi_cltv = approx(params[['refi_cltv_x']], params[['refi_cltv_y']], rule = 2, x$CLTV)$y
    refi_fico = approx(params[['refi_fico_x']], params[['refi_fico_y']], rule = 2, x$CSCORE_B)$y
    refi_fico[is.na(x$CSCORE_B)] =params[['refi_fico_na']]
    
    curt_als = approx(params[['curt_als_x']], params[['curt_als_y']], rule = 2, x$upb)$y
    curt_factor = approx(params[['curt_factor_x']], params[['curt_factor_y']], rule = 2, x$factor)$y
    
    refi_nounit = approx(params[['refi_nounit_x']], params[['refi_nounit_y']], rule = 2, x$NO_UNITS)$y
    refi_burn = approx(params[['refi_burn_x']], params[['refi_burn_y']], rule = 2, x$cum_eim)$y
    refi_hpal = approx(params[['refi_hpal_x']], params[['refi_hpal_y']], rule = 2, x$hpa_life)$y
    refi_hval = approx(params[['refi_hval_x']], params[['refi_hval_y']], rule = 2, x$house_value)$y
    refi_hpa = approx(params[['refi_hpa_x']], params[['refi_hpa_y']], rule = 2, x$hpa)$y
    refi_dti = approx(params[['refi_dti_x']], params[['refi_dti_y']], rule = 2, x$DTI)$y
    refi_dti[is.na(x$DTI)] =params[['refi_dti_na']]
    
    refi_prop =  params[['refi_prop_y']][ match(x$PROP,  params[['refi_prop_x']])]
    refi_prop[is.na(turn_prop)] =1.0
    
    refi_vintage = approx(params[['refi_vintage_x']], params[['refi_vintage_y']], rule = 2, x$orig_year)$y
    
    refi_mi = approx(params[['refi_mi_x']], params[['refi_mi_y']], rule = 2, x$MI_PCT)$y
    refi_mi[is.na(x$MI_PCT)] =params[['refi_mi_na']]
    
    refi_purpose =  params[['refi_purpose_y']][ match(x$PURPOSE,  params[['refi_purpose_x']])]
    refi_purpose[is.na(refi_purpose)] =1.0
    
    refi_sato = approx(params[['refi_sato_x']], params[['refi_sato_y']], rule = 2, x$sato)$y
    
    
    #refi_hpi1m36 = approx(params[['refi_hpi1m36_x']], params[['refi_hpi1m36_y']], rule = 2, x$hpi_1m36)$y
    
    media_scurve = scurve(x$media_ei_lin , params[['media_scurve_low']], params[['media_scurve_high']], params[['media_scurve_shift']], params[['media_scurve_slope']])
    
    refi_occ =  params[['refi_occ_y']][ match(x$OCC_STAT, params[['refi_occ_x']])]
    refi_chn =  params[['refi_chn_y']][ match(x$CHANNEL,  params[['refi_chn_x']])]
    refi_geo =  params[['refi_geo_y']][ match(x$STATE,  params[['refi_geo_x']])]
    refi_geo[is.na(refi_geo)] = 1.0
    
    total_smm = turn_scurve * turn_ramp * turn_season * turn_fico * turn_cltv * turn_als * turn_occ * turn_hpal * turn_geo * turn_purpose * turn_uer * turn_uer1m60 * turn_nounit * turn_prop * turn_sato + 
refi_scurve * refi_ramp * refi_als * refi_fico * refi_cltv * refi_occ * refi_burn * media_scurve * refi_chn * refi_hpal * refi_hpa * refi_dti * refi_boost * refi_geo * refi_mi * refi_boost2 * refi_sato * refi_hval * refi_purpose * refi_nounit * refi_prop * refi_vintage + curt_als * curt_factor
    #total_smm = turn_scurve 
    
    return( pmin(1.0-1e-9, pmax(1e-9, total_smm)) )
}

#library(microbenchmark)
#microbenchmark(approx(params[['turn_season_x']], params[['turn_season_y']], rule = 2, sample.int(12, 100000, replace = TRUE))$y)

objective_function <- function(df_in, index = NULL){
  if(is.null(index)){
    return( df_in[,      100*mean((po_ind * log(model_smm) + (1-po_ind) * log(1-model_smm)), rm.na = TRUE)] )
  }else{
    return( df_in[index, 100*mean((po_ind * log(model_smm) + (1-po_ind) * log(1-model_smm)), rm.na = TRUE)] )  
  }
    #return( df_in[index, mean(sbal * (po_ind * log(model_smm) + (1-po_ind) * log(1-model_smm)),rm.na = TRUE)  ] )
}

turn_objective_function <- function(params_in){
  df[turn_index, model_smm := smm_model(.SD, params_in)]
  objective_function(df, turn_index)
}
refi_objective_function <- function(params_in){
  df[t_index_v, model_smm := smm_model(.SD, params_in)]
  objective_function(df, t_index_v)
}
#Round = 43	turn_low = 0.004791479	turn_high = 0.008352092	turn_scurve_shift = -20.20749	turn_scurve_slope = 20.0000	Value = -15.96594 

## FIT Turnover S-Curve (-8.078541)
params = list('turn_scurve_low' = cpr2smm(5.721711), 'turn_scurve_high' = cpr2smm( 10.5), 'turn_scurve_shift' =  -10.99395, 'turn_scurve_slope' = 34.38446 , 
              'turn_ramp_x' = c(0,    3,    6,   12,   24,  36), 
              'turn_ramp_y' = c(0.1, 0.3, 0.5,  0.71, 0.9, 1.0),
              'turn_fico_x' = c(680,   720, 760,  780, 800), 
              'turn_fico_y' = c(1.25, 1.25, 1.1, 1.0, 0.9),
              'turn_fico_na' = 1.19,
              'turn_cltv_x' = c(5, 10, 25, 80,  90), 
              'turn_cltv_y' = c(2.5,  1.8, 1.0, 1.0, 0.6),
              'turn_als_x' = c(50,  100, 250, 450), 
              'turn_als_y' = c(1.1, 1.1, 1.0, 0.9),
              'turn_hpal_x' = c(-0.05, 0), 
              'turn_hpal_y' = c( 0.5, 1),
              'turn_occ_x' = c('I', 'P', 'S'),
              'turn_occ_y' = c(0.85, 1.0, 1.1),
              'turn_sato_x' = c(-50, -25, 0, 25, 50), 
              'turn_sato_y' = c(0.9,1.0,1.0, 1.0, 1.1),
              'turn_purpose_x' = c('C', 'P', 'R'),
              'turn_purpose_y' = c(1.05, 0.97, 1.04),
              
              'turn_purpose_x' = c('C', 'P', 'R'),
              'turn_purpose_y' = c(1.05, 0.97, 1.04),
              
              'turn_prop_x' = c('CO', 'CP', 'MH', 'PU', 'SF'),
              'turn_prop_y' = c(1.15, 1.15, 0.75, 1.1, 0.95),
              
              'turn_nounit_x' = c(1, 2, 3),
              'turn_nounit_y' = c(1.0,0.7, 0.6),
              
              'turn_uer_x' = c( 5,  6, 7, 8,  9,  10),
              'turn_uer_y' = c(1.0, 0.9, 0.8, 0.8,  0.8,  0.8),
              
              'turn_uer1m60_x' = c( -2, -1.5, -1, 0, 1),
              'turn_uer1m60_y' = c(0.9, 1.0, 1.05, 1.1, 1.25),
              
              'turn_geo_x' = c('NY', 'PR', 'NV', 'AZ', 'NJ', 'PA', 'MD', 'CO', 'IL', 'TX', 'VA'),
              'turn_geo_y' = c(0.65,  0.26, 1.4,  1.4,  0.7,  0.62, 0.67,1.30, 0.89, 1.10, 0.83 ),
              'turn_season_x' = c(1,     2,  3,   4,   5,   6,  7,  8,    9, 10, 11, 12),
              'turn_season_y' = c(0.85,1.12,1.15,1.2,1.25,1.15,1.1,1.05,1.05,1.0,0.9,0.8),
              'refi_scurve_low' = cpr2smm(0), 'refi_scurve_high' = cpr2smm(   17.05326), 'refi_scurve_shift' =  64,	'refi_scurve_slope' = 24.1824, 
              #'refi_boost_low' = 0.9813189, 'refi_boost_high' = 1.185357, 'refi_boost_shift' =   162.9560,	'refi_boost_slope' =  26.07849,
              'refi_boost_low' = 0.95, 'refi_boost_high' =1.25, 'refi_boost_shift' =   150,	'refi_boost_slope' =  35,
              'refi_boost2_low' = 1, 'refi_boost2_high' =  1.55, 'refi_boost2_shift' =   150.6814,	'refi_boost2_slope' =  29.37753,
              #'refi_boost2_low' = 1, 'refi_boost2_high' = 1.058981, 'refi_boost2_shift' =   199.8496,	'refi_boost2_slope' =  5.584044,
              'refi_ramp_x' = c(0,    3,    6,  9,   12), 
              'refi_ramp_y' = c(0.1, 0.4, 0.9, 0.95, 1.0),
              'refi_als_x' = c(50, 70, 100, 200, 300, 400, 450, 500), 
              'refi_als_y' = c(0.1756336, 0.2516466, 0.4510727, 1.0433436, 1.7277068, 2.4163047, 2.8860185, 3.0893330),# c(0.0, 0.1, 0.35, 1.05, 1.8, 2.4, 3.0, 3.2),
              'refi_fico_x' = c(650,  680,  700,   740, 760, 780, 800), 
              'refi_fico_y'  = c(0.36, 0.5621026, 0.6376452,  0.9, 1.1, 1.3, 1.3),
              'refi_fico_na' = 0.6,
              'refi_cltv_x' = c(75,  90), 
              'refi_cltv_y' = c(1.0, 0.6),
              'refi_burn_x' = c(18,  50, 60, 80), 
              'refi_burn_y' = c(1.0, 0.68,0.6, 0.4),
              'refi_hpal_x' = c(-0.1, 0), 
              'refi_hpal_y' = c( 0.5, 1),
              'refi_hpa_x' = c(0,   5, 12, 15), 
              'refi_hpa_y' = c(0.8, 1, 1,  1.2),
              'refi_purpose_x' = c('C', 'P', 'R'),
              'refi_purpose_y' = c(0.92, 1.0, 1.1),
              
              'refi_vintage_x' = c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021), 
              'refi_vintage_y' = c(0.8,   0.75,0.85,  1.0,  1.0,  1.0,  1.0,  1.0,  1.15,  1.12,  1.1,  1.0),
              
              'refi_prop_x' = c('CO', 'CP', 'MH', 'PU', 'SF'),
              'refi_prop_y' = c(0.9103708, 0.7257421, 0.5, 1.0, 1.0),
              
              'refi_hval_x' = c(50,  150,  250,  450), 
              'refi_hval_y' = c(0.1,  0.8, 1.0, 1.05),
              'refi_nounit_x' = c(1, 2, 3),
              'refi_nounit_y' = c(1.0,0.75, 0.7),
              
              'refi_mi_x' = c(15,       25),
              'refi_mi_y' = c(1.053791, 1.126928),
              'refi_mi_na' = 1.0,
              'refi_occ_x' = c('I', 'P', 'S'),
              'refi_occ_y' = c(0.6, 1.0, 0.62),
              'refi_chn_x' = c('B', 'R', 'C'),
              'refi_chn_y' = c(1.19, 0.95, 1.0),
              'refi_geo_x' = c('NY', 'PR',  'AZ', 'NJ', 'PA', 'MD'),
              'refi_geo_y' = c(0.38,  0.18, 1.17, 0.9, 0.92, 0.95),
              'refi_dti_x' = c(30,   42,  50), 
              'refi_dti_y' = c(1.1,  1.0, 0.9),
              'refi_sato_x' = c(-50, 0, 30,   50), 
              'refi_sato_y' = c(1.1, 1.0, 1.0,  0.9),
              'refi_dti_na' = 1.0,
              
              #'media_low' = 0.7222222, 'media_high' = 1.633333, 'media_scurve_shift' = -45, 'media_scurve_slope' = -12,
              'media_scurve_low' = 0.8075042, 'media_scurve_high' = 1.755866, 'media_scurve_shift' =  -51.03237, 'media_scurve_slope' = -13.56413,
              
              'curt_als_x' = c(5, 10, 15, 20, 35), 
              'curt_als_y' = c(cpr2smm(75),cpr2smm(16), cpr2smm(14),cpr2smm(10), 0.0),
              'curt_factor_x' = c(0.1, 0.2, 0.5, 0.75), 
              'curt_factor_y' = c(2.6, 1.0, 0.5, 0.0)
              )  
#plot_act_vs_model2(df, 'factor', my_index, bucket_count = 500)
#plot_act_vs_model2(df, 'upb', my_index & df$upb < 50, bucket_count = 100)
#   'refi_hpa_x' = c(0,   5, 12, 15), 
#params[['refi_burn_y']] =  c(1.0, 0.7, 0.4)

#params[['refi_boost_low']] = 0.95
#params[['refi_boost_high']] = 1.25
#params[['refi_boost_shift']] = 150
#params[['refi_boost_slope']] = 35

#params[['refi_als_x']] = c(50, 70, 100, 200, 300, 400, 450, 500)
#params[['refi_als_y']] = c(0.1756336, 0.2516466, 0.4510727, 1.0433436, 1.7277068, 2.4163047, 2.8860185, 3.0893330)
#params[['curt_als_y']] = c(cpr2smm(75),cpr2smm(16), cpr2smm(14),cpr2smm(10), 0.0) 
#cc(df[,.(.N, sum(sbal), mean(po_ind), mean(model_smm), sum((po_ind * log(model_smm) + (1-po_ind) * log(1-model_smm))) ), by = cutq(upb, seq(0, 1, length.out = 10))])

#params[['refi_vintage_x']] = c(2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021) 
#params[['refi_vintage_y']] = c(0.8,   0.75,0.85,  1.0,  1.0,  1.0,  1.0,  1.0,  1.15,  1.12,  1.1,  1.0)
            

df[, model_smm := smm_model(.SD, params)]
objective_function(df) + 6.725576# -6.728472

plot_act_vs_model2(df, 'PURPOSE', bucket_count = 100)

plot_act_vs_model2(df, 'uer_1m60',  bucket_count = 10)
plot_act_vs_model2(df, 'date', bucket_count = 100)

plot_act_vs_model2(df, 'cum_eim', bucket_count = 20)
plot_act_vs_model2(df, 'cum_ei', bucket_count = 20)

plot_act_vs_model2(df, 'upb', bucket_count = 100)
#plot_act_vs_model2(df, 'upb', df$upb < 100, bucket_count = 100)
plot_act_vs_model2(df, 'LOAN_AGE', df$LOAN_AGE<36, bucket_count = 100) 
plot_act_vs_model2(df, 'date', bucket_count = 20)
plot_act_vs_model2(df, 'cum_eim', bucket_count = 10)

plot_act_vs_model2(df, 'upb', df$upb > 35 & df$CLTV>30 &  df$ei<50, bucket_count = 100)
plot_profile(df$ei, df$ei, df$upb, bucket_count = 100)

plot_act_vs_model2(df, 'upb', bucket_count = 100)
plot_act_vs_model2(df, 'score_diff',  bucket_count = 10)
plot_act_vs_model2(df, 'date', bucket_count = 10)

plot_act_vs_model2(df, 'no_cscore', bucket_count = 50)
plot_act_vs_model2(df, 'uer_1m60', bucket_count = 10)
plot_act_vs_model2(df, 'uer', bucket_count = 10)
plot_act_vs_model2(df, 'CSCORE_B', bucket_count = 50)
plot_act_vs_model2(df, 'sato', bucket_count = 10)
plot_act_vs_model2(df, 'hpa', bucket_count = 10)
plot_act_vs_model2(df, 'score_diff', df$ei < 0, bucket_count = 10)
plot_act_vs_model2(df, 'NO_UNITS', df$ei < 0, bucket_count = 10)
plot_act_vs_model2(df, 'LOAN_AGE', bucket_count = 100)


#plot_act_vs_model2(df, 'CLTV',df$ei < 0, bucket_count = 200)
#plot_act_vs_model2(df, 'upb',df$ei < 0, bucket_count = 200)
plot_act_vs_model2(df, 'orig_year', bucket_count = 20)
plot_act_vs_model2(df, 'DTI',df$ei < 0, bucket_count = 20)
plot_act_vs_model2(df, 'hpa_life', bucket_count = 20)
plot_act_vs_model2(df, 'uer',df$ei < 0, bucket_count = 10)
plot_act_vs_model2(df, 'uer_1m60',df$ei < 0, bucket_count = 10)
plot_act_vs_model2(df, 'uer_3m36',df$ei < 0, bucket_count = 10)
plot_act_vs_model2(df, 'uer',df$ei < 0, bucket_count = 10)

date_index = df$date > '2012-01-01' & df$date < '2014-01-01'
plot_act_vs_model2(df, 'date', date_index, bucket_count = 10)
plot_act_vs_model2(df, 'upb', !date_index, bucket_count = 10)
plot_act_vs_model2(df, 'upb', bucket_count = 10)


#cc(df[ei <0, .(.N, mean(model_smm), mean(po_ind )), by = .(STATE)])

plot_act_vs_model2(df, 'sato', bucket_count = 20)
plot_act_vs_model2(df, 'ei',  bucket_count = 20)

plots = plot_model_coefs(params)
marrangeGrob(plots, nrow = 6, ncol = 7, top = NULL)


#     -6.502647
#params[['refi_boost2_shift']] = 150.6814
#params[['refi_boost2_high']] = 1.55
#params[['turn_scurve_high']] = cpr2smm( 10.5)
#params[['refi_scurve_shift']] =  64
#plot_profile(df$house_value, df$house_value, df$date)

plot_act_vs_model2(df, 'upb', df$ei < 0, bucket_count = 100)
plot_act_vs_model2(df, 'factor', df$ei > 0, bucket_count = 20)
plot_act_vs_model2(df, 'CSCORE_B', df$ei > 0, bucket_count = 20)
plot_act_vs_model2(df, 'ei', df$factor < 0.7, bucket_count = 20)
plot_act_vs_model2(df, 'ei', df$CLTV < 25, bucket_count = 20)

#plot_act_vs_model2(df, 'MI_PCT', bucket_count = 100)
plot_act_vs_model2(df, 'ei', bucket_count = 50)
plot_act_vs_model2(df, 'media_ei_lin', bucket_count = 10)
plot_act_vs_model2(df, 'busday', bucket_count = 10)

plot_act_vs_model2(df, 'upb', bucket_count =  100)
plot_act_vs_model2(df, 'date', bucket_count =  25)
plot_act_vs_model2(df, 'CLTV', bucket_count =  100)
plot_act_vs_model2(df, 'OLTV', bucket_count =  20)

plot_act_vs_model2(df, 'ei', bucket_count = 50)
plot_act_vs_model2(df, 'LOAN_AGE', df$LOAN_AGE<24, bucket_count = 100)
plot_act_vs_model2(df, 'upb', bucket_count = 100)
plot_act_vs_model2(df, 'CSCORE_B', bucket_count = 50)
plot_act_vs_model2(df, 'rate_1m48', bucket_count = 20)
plot_act_vs_model2(df, 'rate_3m48', bucket_count = 20)
plot_act_vs_model2(df, 'rate_1m60', bucket_count = 20)
plot_act_vs_model2(df, 'media_ei_lin', bucket_count = 10)
plot_act_vs_model2(df, 'media_ei_log', bucket_count = 10)
plot_act_vs_model2(df, 'cum_eim', bucket_count = 50)
plot_act_vs_model2(df, 'cum_ei', bucket_count = 50)
plot_act_vs_model2(df, 'ei_ratio', bucket_count = 50)
plot_act_vs_model2(df, 'factor', bucket_count = 100)
plot_act_vs_model2(df, 'OCC_STAT', bucket_count = 100)
plot_act_vs_model2(df, 'CHANNEL', bucket_count = 100)
plot_act_vs_model2(df, 'DTI', bucket_count = 50)
plot_act_vs_model2(df, 'hpa', bucket_count = 10)
plot_act_vs_model2(df, 'hpa_life', bucket_count = 10)
plot_act_vs_model2(df, 'uer_1y', bucket_count = 10)
plot_act_vs_model2(df, 'uer_1m60', bucket_count = 10)
plot_act_vs_model2(df, 'uer', bucket_count = 10)
plot_act_vs_model2(df, 'no_cscore', bucket_count = 10)
plot_act_vs_model2(df, 'STATE', bucket_count = 10)
plot_act_vs_model2(df, 'sato', bucket_count = 20)
plot_act_vs_model2(df, 'hpi_1m60', bucket_count = 50)
plot_act_vs_model2(df, 'hpi_1m36', bucket_count = 10)
plot_act_vs_model2(df, 'orig_year', bucket_count = 100)
plot_act_vs_model2(df, 'CURR_RATE', bucket_count = 100)
plot_act_vs_model2(df, 'house_value', bucket_count = 50)
plot_act_vs_model2(df, 'upb', bucket_count = 50)
plot_act_vs_model2(df, 'ORIG_UPB', bucket_count = 50)
plot_act_vs_model2(df, 'upb', bucket_count = 50)
plot_act_vs_model2(df, 'CLTV', bucket_count = 20)
plot_act_vs_model2(df, 'ei_1m', bucket_count = 50)
plot_act_vs_model2(df, 'NUM_BO', bucket_count = 50)
plot_act_vs_model2(df, 'OLTV', df$ei<0, bucket_count = 10)


#sum(is.na(df$CSCORE_B))
#c('NY', 'PR', 'NV', 'AZ', 'NJ', 'PA', 'MD'),
plots = llply(params[['turn_geo_x']], function(my_geo) plot_act_vs_model2(df, 'date_year_s', df$STATE == 'NY' & df$ei < 0, bucket_count = 100) + ggtitle(my_geo) )
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)

plots = llply(params[['refi_geo_x']], function(my_geo) plot_act_vs_model2(df, 'date_year_s', df$STATE == 'NY', bucket_count = 100) + ggtitle(my_geo) )
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)


plots = llply(c('CA', 'NY', 'FL', 'TX', 'NJ', 'IL', 'NC', 'VI'), function(my_geo) plot_act_vs_model2(df, 'date', df$STATE == my_geo, bucket_count = 100) + ggtitle(my_geo) )
plots = c(plots, list(plot_act_vs_model2(df, 'date', bucket_count = 100) + ggtitle('USA')) )
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)

#S-Curves
plot_profile(df$hpa, df$hpa, df$date, bucket_count = 25)

#cc(df[ei<0, .(.N, mean(po_ind, na.rm = TRUE), mean(model_smm, na.rm = TRUE)), by = .(STATE)])
#cc(df[, .(.N, mean(po_ind, na.rm = TRUE), mean(model_smm, na.rm = TRUE)), by = .(STATE)])

my_index =  df$ei<0
plot_act_vs_model2(df, 'orig_year', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'DTI', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'season_s', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'OCC_STAT', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'CHANNEL', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'hpa_life',my_index, bucket_count = 100)
plot_act_vs_model2(df, 'CSCORE_B',my_index, bucket_count = 50)
plot_act_vs_model2(df, 'CHANNEL',my_index, bucket_count = 100)
plot_act_vs_model2(df, 'uer_1y',my_index, bucket_count = 10)
plot_act_vs_model2(df, 'uer_1m60',my_index, bucket_count = 10)
plot_act_vs_model2(df, 'uer',my_index, bucket_count = 10)
plot_act_vs_model2(df, 'no_cscore',my_index, bucket_count = 10)
plot_act_vs_model2(df, 'DTI',my_index, bucket_count = 100)
plot_act_vs_model2(df, 'STATE',my_index, bucket_count = 100)
plot_act_vs_model2(df, 'MI_PCT',my_index, bucket_count = 100)
plot_act_vs_model2(df, 'CURR_RATE',my_index, bucket_count = 100)

plot_act_vs_model2(df, 'upb', my_index, bucket_count = 50)
plot_act_vs_model2(df, 'ei', my_index, bucket_count = 50)
plot_act_vs_model2(df, 'factor', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'CLTV', my_index, bucket_count = 50)
plot_act_vs_model2(df, 'LOAN_AGE', my_index, bucket_count = 50)
plot_act_vs_model2(df, 'house_value', my_index, bucket_count = 100)
plot_act_vs_model2(df, 'ORIG_UPB', my_index, bucket_count = 50)


plot_profile(df$upb[my_index], df$upb[my_index], df$CLTV[my_index], bucket_count = 25)


my_vars = unique(c('ei', 'LOAN_AGE', 'season_s',  'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','PROP', 'CSCORE_B',  'CLTV', 'OLTV',  'cum_ei','cum_eim', 'media_ei_lin','media_ei_log', 'hpa', 'hpa_life', 'hpi_1m36','hpi_1m60', 'CURR_RATE','MI_PCT',
            'uer', 'uer_1m36', 'uer_1m60', 'uer_3m36',  'factor','DTI','no_cscore', 'sato', 'house_value', 'NO_UNITS', 'no_cscore', 'NUM_BO', 'orig_year', 'ei_ratio', 'vintage', 'ORIG_UPB'))
plots = llply(my_vars, function(my_var){
  plot_act_vs_model2(df, my_var, bucket_count = 10) + ggtitle(my_var)
})
marrangeGrob(plots, nrow = 6, ncol = 6, top = NULL)

#s-curves  
buckets = cutq(df$upb, seq(0, 1, length.out = 10))
plots = llply(levels(buckets), function(my_level){
  plot_act_vs_model2(df, 'ei', buckets == my_level, bucket_count = 25) + ggtitle(my_level)
})
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)

buckets = cutq(df$upb, seq(0, 1, length.out = 10))
plots = llply(levels(buckets), function(my_level){
  plot_act_vs_model2(df, 'LOAN_AGE', buckets == my_level, bucket_count = 25) + ggtitle(my_level)
})
marrangeGrob(plots, nrow = 3, ncol = 3, top = NULL)

buckets = df$CHANNEL
plots = llply(unique(buckets), function(my_level){
  plot_act_vs_model2(df, 'ei', buckets == my_level, bucket_count = 25) + ggtitle(my_level)
})
marrangeGrob(plots, nrow = 1, ncol = 3, top = NULL)

buckets = df$STATE
plots = llply(unique(buckets), function(my_level){  plot_act_vs_model2(df, 'date', buckets == my_level & df$ei <0 , bucket_count = 25) + ggtitle(my_level)})
ggsave(filename = "D:/loan_level/turnover_by_state.pdf", plot = marrangeGrob(plots, nrow=3, ncol=4), device = 'pdf', width = 14, height = 8.5, dpi = 360)

plots = llply(unique(buckets), function(my_level){  plot_act_vs_model2(df, 'date', buckets == my_level, bucket_count = 25) + ggtitle(my_level) })
ggsave(filename = "D:/loan_level/prepay_by_state.pdf", plot = marrangeGrob(plots, nrow=3, ncol=4), device = 'pdf', width = 14, height = 8.5, dpi = 360)


#LTV FICO  
buckets = cutq(df$CLTV, seq(0, 1, length.out = 13))
plots = llply(levels(buckets), function(my_level){
  plot_act_vs_model2(df, 'ei', buckets == my_level, bucket_count = 10) + ggtitle(my_level)
})
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)



turn_index = which(df$ei < 0) %in_set% t_index_v
objective_function(df, turn_index)
plot_act_vs_model2(df, 'ei', turn_index, bucket_count = 10)
plot_act_vs_model2(df, 'LOAN_AGE', turn_index, bucket_count = 25)
plot_act_vs_model2(df, 'date', turn_index, bucket_count = 25)
plot_act_vs_model2(df, 'season_s', turn_index, bucket_count = 25)
plot_act_vs_model2(df, 'CLTV', turn_index, bucket_count = 50)
plot_act_vs_model2(df, 'upb', turn_index, bucket_count = 100)
plot_act_vs_model2(df, 'CSCORE_B',turn_index, bucket_count = 10)


my_vars = c('ei', 'LOAN_AGE', 'season_s',  'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','PROP', 'CSCORE_B',  'CLTV', 'OLTV',  'cum_ei')
plots = llply(my_vars, function(my_var){
  plot_act_vs_model2(df, my_var, bucket_count = 10) + ggtitle(my_var)
})
marrangeGrob(plots, nrow = 3, ncol = 4, top = NULL)


library(rBayesianOptimization)

prepay_obj <- function(...) {
 input_params <- list(...)
  params_ex = params
  for(param_name in names(input_params)) {  params_ex[[param_name]] = input_params[[param_name]]  }
  df[t_index_v, model_smm := smm_model(.SD, params_ex)]
  list(Score = objective_function(df, t_index_v),    Pred = 0)
}

prepay_obj_ex <- function(x, var_names) {
  params_ex = params
  for(param_name in var_names) {  
    np = length(x)
    if(np == 1){
      input_params <- as.list(x)
      names(input_params)<-var_names
      params_ex[[param_name]] = input_params[[param_name]]  
    }else
    {
      for(i in 1:np){
         params_ex[[param_name]][i] = x[i]  
      }
    }
  }
  df[, model_smm := smm_model(.SD, params_ex)]
  return( -objective_function(df) )
}

#-6.492397
#Round = 21	refi_boost_low = 0.8482798	refi_boost_high = 1.0000	refi_boost_shift = 56.92626	refi_boost_slope = 90.89326	Value = -6.489667 
OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list('refi_boost_low' = c(0.5, 1.0),
                                              'refi_boost_high' = c(1.0, 1.5),
                                              'refi_boost_shift' = c(0, 200),
                                              'refi_boost_slope' = c(10, 100)),
                                init_points = 20, n_iter = 10,
                                acq = "ei", #ucb, ei, poi
                                kappa = 2.576, eps = 0.0,
                                verbose = TRUE)

#Iteration: 100 bestvalit: 6.489243 bestmemit:    0.899630    1.002852  100.090985   10.001722
#               bestvalit: 6.489242 bestmemit:    0.897857    1.002633   99.460938   10.000000

#params[['refi_als_y']] = c(0.1825107, 0.2831017, 0.4454677, 1.0367812, 1.7247246, 2.4079676, 2.8369154, 3.0982939)

#-6.731192
var_names = c('refi_prop_y')
my_param = params[[var_names[1]]]
lo_lim = rep(0.5, length(my_param)) 
up_lim = rep(1.5, length(my_param))
res = DEoptim(function(x) prepay_obj_ex(x, var_names), lo_lim, up_lim, control = DEoptim.control(itermax = 1000, trace = TRUE ))
optim(my_param, function(x) prepay_obj_ex(x, var_names), method  = "Nelder-Mead", control = list(trace = TRUE, maxit = 400)) #2.000866
optim(my_param, function(x) prepay_obj_ex(x, var_names), method  = "L-BFGS-B", lower = lo_lim, upper = up_lim, control = list(trace = TRUE, maxit = 100)) #2.000866

#Iteration: 100 bestvalit: 6.487307 bestmemit:    0.149960    0.563774    0.637845    0.953838    0.716011    1.219056    1.293503
#1D optimization variable -------------
turn_obj_1d <- function(x, param_name, param_index = 0) {
  params_mod = params
  
  if(param_index == 0){
    params_mod[[param_name]] = x
  }else{
    params_mod[[param_name]][param_index] = x
  }
  
  df[t_index_v, model_smm := smm_model(.SD, params_mod)]

  objective_function(df, t_index_v)
}
optimize(function(x) turn_obj_1d(x,"refi_mi_y", 2),interval = c(0.9, 1.2), maximum = TRUE) #2.000866

#grid search 
res = ldply(seq(0.9, 1.1, by = 5), function(x) c(x, turn_obj_1d(x, "refi_hpi1m36_y", 1)) )
ggplot(res, aes(V1, V2)) + geom_point() + geom_line()


### GRID search
#'refi_low' = cpr2smm(0), 'refi_high' = cpr2smm(20), 'refi_scurve_shift' =  64.95642243, 'refi_scurve_slope' = 20.74949680,
param_grid = expand.grid(refi_scurve_slope = seq(15, 40, length.out = 10), refi_scurve_shift = seq(50, 80, length.out = 10))
res = ldply(seq(nrow(param_grid)), function(i){
  print(i)
  
  my_params = params
  for (col in names(param_grid)){
    my_params[[col]] = param_grid[[col]][i]
  }
  
  df[, model_smm := smm_model(.SD, my_params)]

   cbind(data.frame(objective = objective_function(df, t_index_v)), param_grid[i,])
  #data.frame(x, deviance = summary(glm.model)$deviance)
})
setDT(res)
res[objective==max(objective)]
ggplot(res, aes_string(names(res)[2], names(res)[3], fill = names(res)[1] )) + geom_tile() +  scale_fill_custom('mixed', discrete = FALSE) + theme_bw() +  
  geom_text(aes(label = sprintf("%.4f",objective )))


#using R optimization --------------
turn_obj_ex <- function(x, param_names, params) {
  params_in = params
  for(i in 1:length(x)){
    params_in[[param_names[i]]] =x[i] 
  }
  return( -turn_objective_function(params_in))
}

refi_obj_ex <- function(x, param_names, params) {
  params_in = params
  for(i in 1:length(x)){
    params_in[[param_names[i]]] =x[i] 
  }
  return( -refi_objective_function(params_in))
}

#param_names = c('refi_scurve_shift', 'refi_scurve_slope', 'refi_low', 'refi_high')
param_names =c('media_scurve_low', 'media_scurve_high', 'media_scurve_shift', 'media_scurve_slope')
init_params = sapply(param_names, function(x) params[[x]])
optim(init_params, function(x)refi_obj_ex(x, param_names, params), method  = "Nelder-Mead", control = list(trace = 6, maxit = 2)) #2.000866

#using dfoptim -------------- "-8.06527"
library(dfoptim)
hjk(init_params,  function(x)refi_obj_ex(x, param_names, params), control = list(maxfeval = 100, info = TRUE))
mads(init_params, function(x)refi_obj_ex(x, param_names, params), control = list(maxfeval = 100, info = TRUE))
```

#PD Profile

```{r pd_profile}

df_pd = ldply(seq(-200, 300, length.out = 100), function(ei_in){ 
  a = df[1,]
  a[, ei:=ei_in]
  return (a) })

setDT(df_pd)

df_pd[, model_smm := smm_model(.SD, params)]

ggplot(df_pd, aes(ei, model_smm )) + geom_line() + geom_point()  #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))

```

#Tuning 

```{r tuning}
prepay_obj <- function(...) {
 input_params <- list(...)
  params_ex = params
  for(param_name in names(input_params)) {  params_ex[[param_name]] = input_params[[param_name]]  }
  df[t_index_v, model_smm := smm_model(.SD, params_ex)]
  list(Score = objective_function(df, t_index_v),    Pred = 0)
}
## Round = 25	refi_high = 0.01822716	refi_scurve_shift = 65.62192	refi_scurve_slope = 25.41931	Value = -15.96843 
OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list('refi_scurve_high' = c(cpr2smm(15), cpr2smm(30)),
                                              'refi_scurve_shift' = c(50, 80),
                                              'refi_scurve_slope' = c(20, 40)),
                                init_points = 10, n_iter = 40, verbose = TRUE)
#Round = 43	turn_low = 0.004791479	turn_high = 0.008352092	turn_scurve_shift = -20.20749	turn_scurve_slope = 20.0000	Value = -15.96594 
#'turn_low' = cpr2smm(6.2), 'turn_high' = cpr2smm( 10.1), 'turn_scurve_shift' = -22.48904, 'turn_scurve_slope' = 18.61279 , #'turn_scurve_slope' = 18.61279, 

OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list('turn_scurve_low' = c(cpr2smm(5), cpr2smm(7)),
                                              'turn_scurve_high' = c(cpr2smm(8), cpr2smm(11)),
                                              'turn_scurve_shift' = c(-20,-10),
                                              'turn_scurve_slope' = c(20, 35)),
                                init_points = 10, n_iter = 40, verbose = TRUE)


#'media_low' = 0.7222222, 'media_high' = 1.633333, 'media_scurve_shift' = -45, 'media_scurve_slope' = -12,
#Round = 35	media_low = 0.7000	media_high = 1.656156	media_scurve_shift = -45.01727	media_scurve_slope = -13.09944	Value = -15.96422
OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list('media_scurve_low'  = c(0.6, 1.0),
                                              'media_scurve_high' = c(1.0, 2.0),
                                              'media_scurve_shift' = c(-60, -10),
                                              'media_scurve_slope' = c(-40, -10)),
                                init_points = 10, n_iter = 40, verbose = TRUE)

# boost optimization ---------------
#Round = 54	refi_boost_low = 0.9763489	refi_boost_high = 1.070678	refi_boost_shift = 150.0000	refi_boost_slope = 31.04256	Value = -15.96382 
#Round = 60	refi_boost_low = 0.9739461	refi_boost_high = 1.186103	refi_boost_shift = 193.3127	refi_boost_slope = 30.51417	Value = -15.96333 
OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list('refi_boost_low'  = c(0.9, 1.0),
                                              'refi_boost_high' = c(1.0, 1.2),
                                              'refi_boost_shift' = c(100, 200),
                                              'refi_boost_slope' = c(25, 60)),
                                init_points = 10, n_iter = 50, verbose = TRUE)


OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list(
                                              'refi_boost2_high'  = c(1.0, 1.5),
                                              'refi_boost2_shift' = c(100, 200),
                                              'refi_boost2_slope' = c(2, 60)),
                                init_points = 10, n_iter = 50, verbose = TRUE)



# SCURVE optimization ---------------
# -15.90388
OPT_Res <- BayesianOptimization(prepay_obj,
                                bounds = list('refi_boost_low'   = c(0.9, 1.0),
                                              'refi_boost_high'  = c(1.0, 1.2),
                                              'refi_boost_shift' = c(100, 200),
                                              'refi_boost_slope' = c(25, 60),
                                              
                                              'media_scurve_low'   = c(0.6, 1.0),
                                              'media_scurve_high'  = c(1.0, 1.7),
                                              'media_scurve_shift' = c(-50, -10),
                                              'media_scurve_slope' = c(-40, -10),
                                              
                                              'turn_scurve_low'   = c(cpr2smm(5), cpr2smm(7)),
                                              'turn_scurve_high'  = c(cpr2smm(8), cpr2smm(11)),
                                              'turn_scurve_shift' = c(-25,-15),
                                              'turn_scurve_slope' = c(15, 30),
                                              
                                              'refi_scurve_high'  = c(cpr2smm(15), cpr2smm(30)),
                                              'refi_scurve_shift' = c(60, 70),
                                              'refi_scurve_slope' = c(20, 30)),
                                init_points = 100, n_iter = 100, verbose = TRUE)


```

#SCurves
```{r scurve_parameters}

df_sc = data.table(ei = seq(-200, 200))

#skew-logistic
ggplot(df_sc) + geom_line(aes(ei, logistic((ei-10)/25))) + 
  geom_line(aes(ei, skewed_logistic1((ei-10)/25, 0.2)), color = 'red') + 
  geom_line(aes(ei, skewed_logistic1((ei-10)/25,  5 )), color = 'blue')


ggplot(df_sc) + geom_line(aes(ei, logistic((ei-10)/25))) + 
  geom_line(aes(ei, skewed_logistic2((ei-10)/25, 0.2)), color = 'red') + 
  geom_line(aes(ei, skewed_logistic2((ei-10)/25,  5 )), color = 'blue')
```

#Burnout optimization
```{r burnout_parameters}
library(gam)

index   = sample.int(nrow(df), 2e6)
index_v = sample.int(nrow(df), 2e6) %!in_set% index

#Simple cum incentive with LGB
# 10bp is the best threshold  -----------------
res = ldply(seq(0, 50, by = 1), function(x){
  
  df[order(date), cum_ei_test  := 0.01*cumsum(pmax(0, ei - x)), by =.(LOAN_ID)]
  my_vars = c(lgb_vars, 'cum_ei_test')
  dtrain.t <- lgb.Dataset(                     data.matrix(df[index,   my_vars,  with = FALSE]), label = df$po_ind[index],    init_score = logit(df$po_pred[index]))
  dtest.t  <- lgb.Dataset.create.valid(dtrain, data.matrix(df[index_v, my_vars,  with = FALSE]), label = df$po_ind[index_v],  init_score = logit(df$po_pred[index_v]))

  model.lgb.test = lgb.train(params = list(objective = "binary"), data = dtrain.t, learning_rate = 0.01,
                        valids = list(test = dtest.t),
                        num_threads = 4, nrounds = 1000,  eval_freq = 50, early_stopping_rounds = 100, force_row_wise=TRUE)
  
  cv_error = as.numeric(model.lgb.test$record_evals$test$binary_logloss$eval)
  #ggplot(data.frame( i = seq(length(cv_error)), cv_error ), aes(i, cv_error)) + geom_line()
  
  #po_pred.test = logistic(predict(model.lgb.test, data.matrix(df[,.(ei, cum_ei_test)]), rawscore=TRUE) +  logit(df$po_pred))
  #plot_profile(po_pred.test, df$po_ind, df$cum_ei_test)
  #plot_profile(df$po_pred, df$po_ind, df$cum_ei_test)
  
  data.frame(x, it = model.lgb.test$best_iter, error = cv_error[model.lgb.test$best_iter], max_error = max(cv_error), min_error = min(cv_error) )
  #data.frame(x, deviance = summary(glm.model)$deviance)
})
setDT(res)
res[error == min(error)]
ggplot(res, aes(x, error)) + geom_line() + geom_point() + geom_vline(xintercept = res[error == min(error), x], linetype = 'dashed')
ggplot(res, aes(x, it)) + geom_line() + geom_point() 

#Burnout S-Curve  -----------------
burn_params = expand.grid(shift = seq(0, 100, by = 1), width = seq(5, 50, by = 1))
res = ldply(seq(nrow(burn_params)), function(i){
  
  df[order(date), cum_eim_test  := cumsum(logistic( (ei - burn_params$shift[i])/burn_params$width[i] )), by =.(LOAN_ID)]
  my_vars = c(lgb_vars, 'cum_eim_test')
  dtrain.t <- lgb.Dataset(                       data.matrix(df[index,   my_vars, with = FALSE]), label = df$po_ind[index],    init_score = logit(df$po_pred[index]))
  dtest.t  <- lgb.Dataset.create.valid(dtrain.t, data.matrix(df[index_v, my_vars, with = FALSE]), label = df$po_ind[index_v],  init_score = logit(df$po_pred[index_v]))

  model.lgb.test = lgb.train(params = list(objective = "binary"), data = dtrain.t, learning_rate = 0.01,
                        valids = list(test = dtest.t),
                        num_threads = 4, nrounds = 1000,  eval_freq = 50, early_stopping_rounds = 100, force_row_wise=TRUE)
  
  cv_error = as.numeric(model.lgb.test$record_evals$test$binary_logloss$eval)
  #ggplot(data.frame( i = seq(length(cv_error)), cv_error ), aes(i, cv_error)) + geom_line()
  
  #po_pred.test = logistic(predict(model.lgb.test, data.matrix(df[,.(ei, cum_ei_test)]), rawscore=TRUE) +  logit(df$po_pred))
  #plot_profile(po_pred.test, df$po_ind, df$cum_ei_test)
  #plot_profile(df$po_pred, df$po_ind, df$cum_ei_test)
  
  data.frame(i, it = model.lgb.test$best_iter, error = cv_error[model.lgb.test$best_iter], max_error = max(cv_error), min_error = min(cv_error), shift = burn_params$shift[i], width = burn_params$width[i] )
})
setDT(res)
res[error == min(error)]
ggplot(res, aes(shift, width, fill = 100*(error/min(error)-1), label = sprintf("%.4f", 100*(error/min(error) - 1) ) )) + geom_tile() +  scale_fill_custom('mixed', discrete = FALSE) + theme_bw()# +  geom_text()
ggplot(res, aes(shift, width, fill = it, label = sprintf("%d", it) )) + geom_tile() + scale_fill_custom('mixed', discrete = FALSE)# + geom_text()




#Simple cum incentive
# 10bp is the best threshold  -----------------
res = ldply(seq(0, 20, by = 2), function(x){
  print(x)
  df[order(date), cum_ei  := 0.01*cumsum(pmax(x, ei)), by =.(LOAN_ID)]
  gam.model = gam(po_ind ~ s(cum_ei) , data = df[index,.(po_ind, cum_ei)], binomial(link = "logit"), offset = logit(df$po_pred[index]), weights =df$sbal[index]/sum(df$sbal[index]) )
  #gam.model = gam(po_ind ~ lo(cum_ei, ei) , data = df[index,.(po_ind, cum_ei, ei)], binomial(link = "logit"), offset = logit(df$po_pred[index]), weights =df$sbal[index]/sum(df$sbal[index]) )
  #plot(gam.model)
  sum.model = summary(gam.model)
  data.frame(x, deviance = sum.model$deviance, null.deviance = sum.model$null.deviance)
  #data.frame(x, deviance = summary(glm.model)$deviance)
})
setDT(res)
res[deviance == min(deviance)]
ggplot(res, aes(x, deviance/null.deviance)) + geom_line() + geom_vline(xintercept = res[deviance == min(deviance), x], linetype = 'dashed')

#Burnout S-Curve
# 10bp is the best threshold  -----------------
burn_params = expand.grid(shift = seq(100, 100, by = 10), width = seq(4, 16, by = 2))
res = ldply(seq(nrow(burn_params)), function(i){
  print(i)
  
  df[order(date), cum_eim  := cumsum(logistic( (ei - burn_params$shift[i])/burn_params$width[i] )), by =.(LOAN_ID)]
   gam.model = gam(po_ind ~ s(cum_eim) , data = df[index,.(po_ind, cum_eim)], binomial(link = "logit"), offset = logit(df$po_pred[index]))
  #gam.model = gam(po_ind ~ s(cum_eim) , data = df[index,.(po_ind, cum_eim)], binomial(link = "logit"), offset = logit(df$po_pred[index]), weights =df$sbal[index]/sum(df$sbal[index]) )

  #plot(gam.model)
  sum.model = summary(gam.model)
  data.frame(deviance = sum.model$deviance, null.deviance = sum.model$null.deviance, shift = burn_params$shift[i], width = burn_params$width[i])
  #data.frame(x, deviance = summary(glm.model)$deviance)
})
setDT(res)
res[deviance == min(deviance)]
ggplot(res[deviance<null.deviance], aes(shift, width, fill = 1-deviance/null.deviance, label = sprintf("%.1f", null.deviance - deviance) )) + 
  geom_tile() + geom_text() +  scale_fill_custom('mixed', discrete = FALSE)

ggplot(df[LOAN_ID == '000097473153'], aes(date, cum_eim)) + geom_line()
ggplot(df[LOAN_ID == '000097473153'], aes(date, ei_1m)) + geom_line()
```


#Simple paramatric model

     par1         par2         par3         par4         par5         par6         par7         par8         par9        par10        par11        par12        par13        par14 
  4.87201650   6.19723842 -12.47976449  33.25313274   0.16833252   0.33770630   0.24760142   0.62744220   0.93352558   0.77902162   0.70219527   1.20314616   1.49708316   1.08563802 
       par15        par16        par17        par18        par19        par20        par21        par22        par23        par24        par25        par26        par27        par28 
  1.46764033   1.39246333   1.15373780   0.58280189   0.99389601   1.03518826   1.00540658   0.80723339   0.84916305  35.13632105  67.12934556  36.19850046   0.06701411   0.38693808 
       par29        par30 
  0.81473242   0.81008732 
  
```{r burnout_parameters}
library(DEoptim)
library(optimx)
library(dfoptim)
library(pso)

t_index_v = sample.int(nrow(df), 1e5)

plot_act_vs_model2 <-function(df, profile, index = NULL, ...){
  p = NULL
  if(is.null(index)) {
    p = plot_profile(df[['model_smm']], df[['po_ind']], df[[profile]], map_fun = smm2cpr, ...)
  }else{
    p = plot_profile(df[['model_smm']][index], df[['po_ind']][index], df[[profile]][index], map_fun = smm2cpr, ...)
  }
  return( p )
}

scurve <- function(x, a, b, shift, slope){   a + (b - a)*logistic((x - shift)/slope) }

smm_model <- function(x, params){
    turn_scurve = scurve(x$ei, params[['turn_scurve_low']], params[['turn_scurve_high']], params[['turn_scurve_shift']], params[['turn_scurve_slope']])
    turn_ramp = approx(params[['turn_ramp_x']], params[['turn_ramp_y']], rule = 2, x$LOAN_AGE)$y
    turn_season = approx(params[['turn_season_x']], params[['turn_season_y']], rule = 2, x$season)$y
    
    refi_scurve =  scurve(x$ei, params[['refi_scurve_low']], params[['refi_scurve_high']],  params[['refi_scurve_shift']], params[['refi_scurve_slope']])
    refi_ramp = approx(params[['refi_ramp_x']], params[['refi_ramp_y']], rule = 2, x$LOAN_AGE)$y
    media_scurve = scurve(x$media_ei_lin , params[['media_scurve_low']], params[['media_scurve_high']], params[['media_scurve_shift']], params[['media_scurve_slope']])
    
    total_smm = turn_scurve * turn_ramp * turn_season  + refi_scurve * refi_ramp * media_scurve
    #total_smm = turn_scurve 
    
    return( pmin(1.0-1e-9, pmax(1e-9, total_smm)) )
}

## FIT Turnover S-Curve (-8.078541)
params = list('turn_scurve_low' = cpr2smm(5.721711), 'turn_scurve_high' = cpr2smm( 10.5), 'turn_scurve_shift' =  -10.99395, 'turn_scurve_slope' = 34.38446 , 
              'turn_ramp_x' = c(0,    3,    6,  12,  24,  36), 
              'turn_ramp_y' = c(0.1, 0.3, 0.5, 0.8, 0.9, 1.0),
              'turn_season_x' = c(1,     2,  3,   4,   5,   6,  7,  8,    9, 10, 11, 12),
              'turn_season_y' = c(0.85,1.12,1.15,1.2,1.2,1.15,1.1,1.05,1.05,1.0,0.9,0.8),
              
              'refi_scurve_low' = cpr2smm(0), 'refi_scurve_high' = cpr2smm(   17.05326), 'refi_scurve_shift' =  64,	'refi_scurve_slope' = 24.1824, 
              'refi_ramp_x' = c(0,    3,    6,  12), 
              'refi_ramp_y' = c(0.1, 0.4, 0.9, 1.0),
              'media_scurve_low' = 0.8075042, 'media_scurve_high' = 1.755866, 'media_scurve_shift' =  -51.03237, 'media_scurve_slope' = -13.56413
              )  

# -15.89001
#params[['refi_boost2_shift']] = 150.6814
#params[['refi_boost2_high']] = 1.55
#params[['turn_scurve_high']] = cpr2smm( 10.5)
#params[['refi_scurve_shift']] =  64

get_smm_params<-function(x){
    my_params = list('turn_scurve_low' = cpr2smm(x[1]), 'turn_scurve_high' = cpr2smm( x[2]), 'turn_scurve_shift' =  x[3], 'turn_scurve_slope' = x[4] , 
              'turn_ramp_x' = c(0,    3,    6,  12,  24,  36), 
              'turn_ramp_y' = x[5:10],
              'turn_season_x' = c(1,     2,  3,   4,   5,   6,  7,  8,    9, 10, 11, 12),
              'turn_season_y' = x[11:22],
              
              'refi_scurve_low' =  cpr2smm(  x[23] ), 'refi_scurve_high' = cpr2smm(   x[24]), 'refi_scurve_shift' =  x[25],	'refi_scurve_slope' = x[26], 
              'refi_ramp_x' = c(0,    3,    6,  12), 
              'refi_ramp_y' = x[27:30],
              'media_scurve_low' = x[31], 'media_scurve_high' = x[32], 'media_scurve_shift' =  x[33], 'media_scurve_slope' = x[34]
              ) 
    return (my_params)
}

objective_function_optim <- function(x){
  my_params = get_smm_params(x)
  df[t_index_v, model_smm := smm_model(.SD, my_params)]
  return( df[t_index_v, -sum( po_ind * log(model_smm) + (1-po_ind) * log(1-model_smm),rm.na = TRUE)  ] )
}

df[, model_smm := smm_model(.SD, params)]
plot_act_vs_model2(df, 'ei', bucket_count = 50)


#DEoptim --------------------------------------
           #turn_scurve     turn_ramp         turn_season     refi_scurve     refi_ramp
lo_lim = c(1,   5, -20, 10,   0, rep(0.1, 5),   rep(0.5, 12),  0,   0,   0, 10,   rep(0.0, 4), 1.0,1.0, -70, -30)
up_lim = c(6,  12,   0, 40,   1, rep(1.0, 5),   rep(1.5, 12),  1,  50, 100, 40,   rep(1.0, 4), 1.8,1.8, -30, -10)
init_params = c(5.721711, 10.5, -10.99395, 34.38446, 0.1, 0.3, 0.5, 0.8, 0.9, 1.0, 0.85,1.12,1.15,1.2,1.2,1.15,1.1,1.05,1.05,1.0,0.9,0.8, 0, 17.05326, 64, 24.1824, 0.1, 0.4, 0.9, 1.0, 1.1,  1.755866, -51.03237, -13.56413)
#res = DEoptim(objective_function_optim, lo_lim, up_lim, control = DEoptim.control(itermax = 10, trace = TRUE,  parallelType=1, parVar = c('get_smm_params', 'cpr2smm', 'df', 't_index_v') ))
#6943.463
  # par1         par2         par3         par4         par5         par6         par7         par8         par9        par10        par11        par12        par13        par14 
  # 4.96602977   5.04735202 -19.79704236  39.13488733   0.20673266   0.10033608   0.64569598   0.60007013   0.99029971   0.84551981   0.63640578   1.34951256   1.08520220   1.31727090 
  #      par15        par16        par17        par18        par19        par20        par21        par22        par23        par24        par25        par26        par27        par28 
  # 1.40219324   0.95774065   1.41190460   1.20647324   0.92434590   1.30611005   1.19228784   0.50338422   0.05020826  23.60089310  43.16731782  32.12933219   0.02915692   0.32908846 
  #      par29        par30        par31        par32        par33        par34 
  # 0.63760826   0.76892106   1.00004218   1.79987754 -40.88195143 -10.00027833 
res = DEoptim(objective_function_optim, lo_lim, up_lim, control = DEoptim.control(itermax = 1000, trace = TRUE ))

objective_function_optim(init_params) #6871.019
objective_function_optim(res$optim$bestmem) #6847.991

plots = plot_model_coefs(get_smm_params(res$par) )
marrangeGrob(plots, nrow = 2, ncol = 3, top = NULL)


df[, model_smm := smm_model(.SD, get_smm_params(init_params))]
df[, model_smm := smm_model(.SD, get_smm_params(up_lim))]
df[, model_smm := smm_model(.SD, get_smm_params(res$optim$bestmem))]
plot_act_vs_model2(df, 'date', bucket_count = 50)
plot_act_vs_model2(df, 'ei', bucket_count = 50)

#optimx --------------------------------------
#optimx(init_params, objective_function_optim, lower=lo_lim, upper=up_lim, method="Nelder-Mead", itnmax=100, control  = list(trace = 1))
optimx(init_params, objective_function_optim, lower=lo_lim, upper=up_lim, method="L-BFGS-B", itnmax=10, control  = list(trace = 1))

#6936.693   -> 6847.352
res = hjkb(init_params, objective_function_optim, lower=lo_lim, upper=up_lim,  control = list(maxfeval = 10000, info = TRUE))
#res = nmkb(par=init_params, fn=objective_function_optim, lower=lo_lim, upper=up_lim,  control = list(maxfeval = 100, info = TRUE))

objective_function_optim(init_params)
objective_function_optim(res$par)
objective_function_optim(res$optim$bestmem)

df[, model_smm := smm_model(.SD, get_smm_params(res$par))]
plot_act_vs_model2(df, 'ei', bucket_count = 50)
plot_act_vs_model2(df, 'date', bucket_count = 50)
plot_act_vs_model2(df, 'date',  df$ei < 0, bucket_count = 50)
plot_act_vs_model2(df, 'season_s', bucket_count = 50)

#### PD profiles
df_pd = ldply(seq(-200, 300, length.out = 100), function(ei_in){ 
  a = df[30,]
  a[, ei:=ei_in]
  return (a) })

setDT(df_pd)

#df_pd[, model_smm := smm_model(.SD, get_smm_params(res$par))]
df_pd[, model_smm := smm_model(.SD, get_smm_params(res$optim$bestmem))]

ggplot(df_pd, aes(ei, smm2cpr(model_smm) )) + geom_line() + geom_point()  #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))

#VS date
df_pd = ldply(seq(-200, 200, by = 50), function(ei_in){ 
  df_pd = ldply(sort(unique(df$date)[1:12]), function(my_date){ 
    a = df[30,]
    a[, season:=month(my_date)]
    a[, date:=my_date]
    a[, ei:=ei_in]
    return (a) })
  return (df_pd)
})
setDT(df_pd)

df_pd[, model_smm := smm_model(.SD, get_smm_params(res$par))]
df_pd[, model_smm := smm_model(.SD, get_smm_params(res$optim$bestmem))]

ggplot(df_pd, aes(date, smm2cpr(model_smm), group = ei, color = factor(ei) )) + geom_line() + geom_point() + scale_color_custom('mixed') #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))

```

#Stacked ML Model

```{r stacked_model}
library(EIX)
library(lightgbm)

#starting model 
parametric_model_smm = smm_model(df, params)
df[, model_smm := parametric_model_smm]
objective_function(df, t_index_v) # -6.514769 (-6.353111- lightGBM)
plot_act_vs_model2(df, 'ei', bucket_count = 100)

index   = sample.int(nrow(df), 2e6)
index_v = sample.int(nrow(df), 2e6) %!in_set% index

my_vars = c('ei', 'LOAN_AGE', 'season', 'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','PROP', 'DTI', 'CSCORE_B', 'co_borrower','score_diff', 'FIRST_FLAG', 'CLTV', 'OLTV', 'rate_1m48', 'sato', 'cum_eim', 'geo_ny', 'geo_pr', 'NO_UNITS', 'hpa', 'hpa_life', 'busday', 'house_value', 'factor', 'uer_1y', 'uer_1m60', 'uer', 'media_ei_lin', 'media_ei_log', 'cum_ei') %!in_set% c('id') #best performance

  dtrain.t <- lgb.Dataset(                       data.matrix(df[index,   my_vars,  with = FALSE]), label = df$po_ind[index],    init_score = logit(parametric_model_smm[index]))
  dtest.t  <- lgb.Dataset.create.valid(dtrain.t, data.matrix(df[index_v, my_vars,  with = FALSE]), label = df$po_ind[index_v],  init_score = logit(parametric_model_smm[index_v]))

  model.lgb.test = lgb.train(params = list(objective = "binary"), data = dtrain.t, learning_rate = 0.01,
                        valids = list(test = dtest.t),
                        num_threads = 4, nrounds = 10000,  eval_freq = 50, early_stopping_rounds = 100, force_row_wise=TRUE)
  
  cv_error = as.numeric(model.lgb.test$record_evals$test$binary_logloss$eval)
  ggplot(data.frame( i = seq(length(cv_error)), cv_error ), aes(i, cv_error)) + geom_line()
        
  po_pred.test_logodds =  predict(model.lgb.test, data.matrix(df[,my_vars, with = FALSE]), rawscore=TRUE)
  po_pred.test = logistic(po_pred.test_logodds +  logit(parametric_model_smm))
  df[, model_smm := po_pred.test]
  #plot_profile(po_pred.test, df$po_ind, df$date)
  #plot_profile(po_pred.test_logodds, df$po_ind, df$date)
  #plot_profile(logistic(po_pred.test_logodds +  logit(parametric_model_smm)),  parametric_model_smm, df$ei, bucket_count = 50)
  #plot_act_vs_model2(df, 'date', bucket_count = 100)

  
  lgb_importance = lgb.importance(model.lgb.test, percentage = TRUE)
  ggplot(lgb_importance[Gain > 0.001], aes(fct_reorder(Feature,Gain), Gain)) + geom_bar(stat = 'identity') + coord_flip()

 
  inter <- interactions(model.lgb.test, dtest.t, option = "interactions")
  #plot(inter)
  ggplot(data.table(inter), aes(Parent, Child, fill = sumGain)) + geom_tile() + scale_fill_custom('mixed', discrete = FALSE) + theme(axis.text.x  = element_text(angle=90))
  ggplot(data.table(inter)[order(-sumGain)][1:20], aes(Parent, sumGain, fill = sumGain, label = Child, group =Child )) + geom_bar(stat = 'identity', position = 'dodge') + scale_fill_custom('mixed', discrete = FALSE) + coord_flip() + 
    geom_text(size = 3, hjust = 'right', vjust = 0, nudge_x = 0.2, nudge_y = 0.5)
  
  imp <- importance(model.lgb.test, dtest.t, option = "both", digits = 4)
  plot(imp)
  
 
  
  #using XGBOOST
  library(xgboost)
  
  dtrain <- xgb.DMatrix(data.matrix(df[index,  my_vars, with = F]), label = df$po_ind[index],   base_margin =  logit(parametric_model_smm[index]) ) #'D2' %in% colnames(dtrain)
  deval  <- xgb.DMatrix(data.matrix(df[index_v,my_vars, with = F]), label = df$po_ind[index_v], base_margin =  logit(parametric_model_smm[index_v]) ) #'D2' %in% colnames(dtrain)

  
my_params <- list(max_depth = 3, 
              eta =  0.01, 
              nthread = 14,
              objective = "binary:logistic" )


model.xgb <- xgb.train(my_params, data = dtrain, 
                       watchlist = list(train = dtrain, eval = deval),
                       nrounds = 10000, 
                       verbose = 1, 
                       print_every_n = 10)

ggplot(model.xgb$evaluation_log, aes(iter, train_logloss )) + geom_line() + geom_line(aes(iter, eval_logloss), color = 'red')

pred.xgb_logodds <- predict(model.xgb, data.matrix(df[,my_vars, with = F]), outputmargin=TRUE ) #logit
pred.xgb_full <- logistic(pred.xgb_logodds +  logit(parametric_model_smm))

df[, model_smm := pred.xgb_full]
objective_function(df, t_index_v) # -6.514769 (-6.353111- lightGBM)
plot_act_vs_model2(df, 'date', bucket_count = 100)


plot_profile(pred.xgb_full,  parametric_model_smm, df$ei, bucket_count = 50)
plot_profile(pred.xgb_full,  df$po_ind, df$ei, bucket_count = 50)
#plot_profile(logistic(po_pred.test_logodds +  logit(parametric_model_smm)),  parametric_model_smm, df$ei, bucket_count = 50)

vip(model.xgb)
importance_matrix <- xgb.importance(model = model.xgb)
#print(importance_matrix)
xgb.ggplot.importance(importance_matrix = importance_matrix)
xgb.ggplot.deepness(model.xgb)
xgb.ggplot.deepness(model.xgb, which = "max.depth")


lolli<-lollipop(model.xgb,deval)
plot(lolli)

pairs<-interactions(model.xgb, deval, option = "pairs")
head(pairs)
plot(pairs)
```

#SCurve FIT

```{r burnout_parameters}
library(DEoptim)
library(optimx)
library(dfoptim)
library(pso)

t_index_v = sample.int(nrow(df), 1e5)

plot_act_vs_model2 <-function(df, profile, index = NULL, ...){
  p = NULL
  if(is.null(index)) {
    p = plot_profile(df[['model_smm']], df[['po_ind']], df[[profile]], map_fun = smm2cpr, ...)
  }else{
    p = plot_profile(df[['model_smm']][index], df[['po_ind']][index], df[[profile]][index], map_fun = smm2cpr, ...)
  }
  return( p )
}

scurve <- function(x, a, b, shift, slope){   a + (b - a)*logistic((x - shift)/slope) }

smm_model <- function(x, params){
    refi_scurve =  scurve(x$ei, params[['refi_scurve_low']], params[['refi_scurve_high']],  params[['refi_scurve_shift']], params[['refi_scurve_slope']])
    refi_ramp = approx(params[['refi_ramp_x']], params[['refi_ramp_y']], rule = 2, x$LOAN_AGE)$y
   
     total_smm = refi_scurve * refi_ramp
    
    return( pmin(1.0-1e-9, pmax(1e-9, total_smm)) )
}

## FIT Turnover S-Curve (-8.078541)
params = list(
              'refi_scurve_low' = cpr2smm(0), 'refi_scurve_high' = cpr2smm(   50), 'refi_scurve_shift' =  64,	'refi_scurve_slope' = 24.1824, 
              'refi_ramp_x' = c(0,    3,    6,  12), 
              'refi_ramp_y' = c(0.1, 0.4, 0.9, 1.0)
              )  
get_smm_params<-function(x){
    my_params = list(
              'refi_scurve_low' =  cpr2smm(  x[1] ), 'refi_scurve_high' = cpr2smm(   x[2]), 'refi_scurve_shift' =  x[2],	'refi_scurve_slope' = x[4], 
              'refi_ramp_x' = c(0,    3,    6,  9,  12), 
              'refi_ramp_y' = x[5:9]
              ) 
    return (my_params)
}

objective_function_optim <- function(x){
  my_params = get_smm_params(x)
  df[t_index_v, model_smm := smm_model(.SD, my_params)]
  return( df[t_index_v, -sum( po_ind * log(model_smm) + (1-po_ind) * log(1-model_smm),rm.na = TRUE)  ] )
}

df[, model_smm := smm_model(.SD, params)]
plot_act_vs_model2(df, 'ei', bucket_count = 50)


#DEoptim --------------------------------------
      #  refi_scurve     refi_ramp
lo_lim = c(cpr2smm(0),   cpr2smm(0),   0,  10,   rep(0.0, 5))
up_lim = c(cpr2smm(10),  cpr2smm(50), 100, 50,   rep(1.0, 5))
init_params = c()
res = DEoptim(objective_function_optim, lo_lim, up_lim, control = DEoptim.control(itermax = 1000, trace = TRUE ))

objective_function_optim(init_params) #6871.019
objective_function_optim(res$optim$bestmem) #6847.991

plots = plot_model_coefs(get_smm_params(res$par) )
marrangeGrob(plots, nrow = 2, ncol = 3, top = NULL)


df[, model_smm := smm_model(.SD, get_smm_params(init_params))]
df[, model_smm := smm_model(.SD, get_smm_params(up_lim))]
df[, model_smm := smm_model(.SD, get_smm_params(res$optim$bestmem))]
plot_act_vs_model2(df, 'date', bucket_count = 50)
plot_act_vs_model2(df, 'ei', bucket_count = 50)

#optimx --------------------------------------
#optimx(init_params, objective_function_optim, lower=lo_lim, upper=up_lim, method="Nelder-Mead", itnmax=100, control  = list(trace = 1))
optimx(init_params, objective_function_optim, lower=lo_lim, upper=up_lim, method="L-BFGS-B", itnmax=10, control  = list(trace = 1))

#6936.693   -> 6847.352
res = hjkb(init_params, objective_function_optim, lower=lo_lim, upper=up_lim,  control = list(maxfeval = 10000, info = TRUE))
#res = nmkb(par=init_params, fn=objective_function_optim, lower=lo_lim, upper=up_lim,  control = list(maxfeval = 100, info = TRUE))

objective_function_optim(init_params)
objective_function_optim(res$par)
objective_function_optim(res$optim$bestmem)

df[, model_smm := smm_model(.SD, get_smm_params(res$par))]
plot_act_vs_model2(df, 'ei', bucket_count = 50)
plot_act_vs_model2(df, 'date', bucket_count = 50)
plot_act_vs_model2(df, 'date',  df$ei < 0, bucket_count = 50)
plot_act_vs_model2(df, 'season_s', bucket_count = 50)

#### PD profiles
df_pd = ldply(seq(-200, 300, length.out = 100), function(ei_in){ 
  a = df[30,]
  a[, ei:=ei_in]
  return (a) })

setDT(df_pd)

#df_pd[, model_smm := smm_model(.SD, get_smm_params(res$par))]
df_pd[, model_smm := smm_model(.SD, get_smm_params(res$optim$bestmem))]

ggplot(df_pd, aes(ei, smm2cpr(model_smm) )) + geom_line() + geom_point()  #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))

#VS date
df_pd = ldply(seq(-200, 200, by = 50), function(ei_in){ 
  df_pd = ldply(sort(unique(df$date)[1:12]), function(my_date){ 
    a = df[30,]
    a[, season:=month(my_date)]
    a[, date:=my_date]
    a[, ei:=ei_in]
    return (a) })
  return (df_pd)
})
setDT(df_pd)

df_pd[, model_smm := smm_model(.SD, get_smm_params(res$par))]
df_pd[, model_smm := smm_model(.SD, get_smm_params(res$optim$bestmem))]

ggplot(df_pd, aes(date, smm2cpr(model_smm), group = ei, color = factor(ei) )) + geom_line() + geom_point() + scale_color_custom('mixed') #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))

```

#Stacked Logistic regression
not correct because it produces multiplicative structure

```{r logistic_regression}

t_index_v = sample.int(nrow(df), 1e6)

add_splines <- function(df, vname, spline_knots, prefix = 'sp_'){
  
  nk = length(spline_knots)
  x_splined = bs(df[[vname]], knots = spline_knots, degree = 1)
  x_splined[,nk] = x_splined[,nk] + x_splined[,nk + 1]
  spline_names = make.names(stri_join(prefix, vname, '_', spline_knots[2:nk]))
  
  df[, (spline_names) := lapply(seq(2, nk), function(i) x_splined[,i])  ]
  return (TRUE)
}

get_vars <- function(all_names, pattern){
  all_names[grepl(pattern, all_names)]
}

#plot_act_vs_model2(df, 'upb', bucket_count = 100)

#create splines
#df[,(get_vars(names(df), 'sp_LOAN_AGE')):=NULL]
#df[,(get_vars(names(df), 'sp_turn_ei')):=NULL]
#df[,(get_vars(names(df), 'sp_turn_CSCORE_B')):=NULL]

df[, CSCORE:=CSCORE_B]
df[is.na(CSCORE), CSCORE:=700]

add_splines(df, 'LOAN_AGE', spline_knots = c(3,    6,   12,   24,  36), prefix = 'sp_turn_')
add_splines(df, 'ei', spline_knots = c(-100, -50,  0), prefix = 'sp_turn_')
add_splines(df, 'CSCORE', spline_knots = c(640, 760, 800), prefix = 'sp_turn_')
ggplot(df[sample.int(nrow(df), 1000)], aes(LOAN_AGE, sp_turn_LOAN_AGE_6)) + geom_line()
ggplot(df[sample.int(nrow(df), 1000)], aes(CSCORE, sp_turn_CSCORE_760)) + geom_line()
ggplot(df[sample.int(nrow(df), 1000)], aes(CSCORE, sp_turn_CSCORE_800)) + geom_line()

#create vars
turn.vars = c('season_s', 'OCC_STAT', 'no_cscore',  get_vars(names(df), 'sp_turn_LOAN_AGE'), get_vars(names(df), 'sp_turn_ei'),  get_vars(names(df), 'sp_turn_CSCORE') )
turn.formula = as.formula(stri_join('po_ind ~ ', stri_join(turn.vars, collapse = '+')))

#turnover
model.turn = glm(turn.formula, data = df[ei<0], family = binomial(link = "logit") )
summary(model.turn)
vif(model.turn)

df[, model_smm := predict(model.turn, .SD, type = 'response')]
#plot_act_vs_model2(df[ei<0], 'date', bucket_count = 100)
#plot_act_vs_model2(df[ei<0], 'LOAN_AGE', bucket_count = 100)
#plot_act_vs_model2(df, 'ei', bucket_count = 20)
plot_act_vs_model2(df[ei<0], 'CSCORE', bucket_count = 20)

my_vars = unique(c('ei', 'LOAN_AGE', 'season_s',  'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','PROP', 'CSCORE_B',  'CLTV', 'OLTV',  'cum_ei','cum_eim', 'media_ei_lin','media_ei_log', 'hpa', 'hpa_life', 'hpi_1m36','hpi_1m60', 'CURR_RATE','MI_PCT',
            'uer', 'uer_1m36', 'uer_1m60', 'uer_3m36',  'factor','DTI','no_cscore', 'sato', 'house_value', 'NO_UNITS', 'no_cscore', 'NUM_BO', 'orig_year', 'ei_ratio', 'vintage', 'ORIG_UPB'))
plots = llply(my_vars, function(my_var){
  plot_act_vs_model2(df[ei<0], my_var, bucket_count = 10) + ggtitle(my_var)
})
marrangeGrob(plots, nrow = 6, ncol = 6, top = NULL)


#df[,(get_vars(names(df), 'sp_refi_cum_ei')):=NULL]
add_splines(df, 'LOAN_AGE',spline_knots = c(3,    6,   12),     prefix = 'sp_refi_')
add_splines(df, 'ei',      spline_knots = c(0, 50, 100, 150),  prefix = 'sp_refi_')
add_splines(df, 'cum_ei',  spline_knots = c(10, 20, 60),            prefix = 'sp_refi_')
add_splines(df, 'upb',    spline_knots = c(50, 100, 200, 400),            prefix = 'sp_refi_')

#p_index = sample.int(nrow(df), 1000)
#ggplot(df[p_index], aes(cum_ei, sp_refi_cum_ei_10 )) + geom_line()
#ggplot(df[p_index][LOAN_AGE<24], aes(cum_ei, LOAN_AGE )) + geom_point()

df[, turn_logodds := log(predict(model.turn, .SD, type = 'response')) ]

refi.vars = c(get_vars(names(df), 'sp_refi_'))
refi.formula = as.formula(stri_join('po_ind ~ ', stri_join(refi.vars, collapse = '+'), "+ offset(turn_logodds)"))

#model.refi = glm(refi.formula, data = df[t_index_v], family = binomial(link = "logit"), offset =  turn.offset[t_index_v])
model.refi = glm(refi.formula, data = df, family = binomial(link = "logit"))
summary(model.refi)

df[, model_smm := predict(model.refi, .SD, type = 'response')]
#df[, model_smm := logistic(turn.offset)]

plot_act_vs_model2(df, 'date', bucket_count = 20)
plot_act_vs_model2(df, 'ei', bucket_count = 20)
plot_act_vs_model2(df[ei<0], 'LOAN_AGE', bucket_count = 20)
plot_act_vs_model2(df, 'LOAN_AGE', bucket_count = 20)
plot_act_vs_model2(df, 'cum_ei', bucket_count = 20)
plot_act_vs_model2(df, 'upb', bucket_count = 20)

plot_binmodel_percentiles(df$po_ind, df$model_smm, 10)
#plot_binmodel_roc(df$po_ind, df$model_smm)
#plot_binmodel_predictions(df$po_ind, df$model_smm)

#VS date
df_pd = ldply(seq(-200, 200, by = 50), function(ei_in){ 
  df_pd = ldply(sort(unique(df$date))[1:36], function(my_date){ 
    a = df[30,]
    a[, season_s:=sprintf('%02d', month(my_date))]
    a[, date:=my_date]
    a[, ei:=ei_in]
    return (a) })
  return (df_pd)
})
setDT(df_pd)

add_splines(df_pd, 'LOAN_AGE', spline_knots = c(3,    6,   12,   24,  36), prefix = 'sp_turn_')
add_splines(df_pd, 'ei', spline_knots = c(-100, -50,  0), prefix = 'sp_turn_')
add_splines(df_pd, 'CSCORE', spline_knots = c(640, 760, 800), prefix = 'sp_turn_')
add_splines(df_pd, 'LOAN_AGE',spline_knots = c(3,    6,   12),     prefix = 'sp_refi_')
add_splines(df_pd, 'ei',      spline_knots = c(0, 50, 100, 150),  prefix = 'sp_refi_')
add_splines(df_pd, 'cum_ei',  spline_knots = c(10, 20, 60),            prefix = 'sp_refi_')
add_splines(df_pd, 'upb',    spline_knots = c(50, 100, 200, 400),            prefix = 'sp_refi_')


df_pd[, turn_smm := predict(model.turn, .SD, type = 'response')]
df_pd[, turn_logodds := log(turn_smm/10)]
df_pd[, model_smm := predict(model.refi, newdata  = .SD, type = 'response')]

ggplot(df_pd, aes(date, smm2cpr(turn_smm),  group = ei, color = factor(ei) )) + geom_line() + geom_point() + scale_color_custom('mixed') #+ geom_line(aes(ei, model_smm * scurve(ei, 
ggplot(df_pd, aes(date, smm2cpr(model_smm), group = ei, color = factor(ei) )) + geom_line() + geom_point() + scale_color_custom('mixed') #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))


ggplot(df_grid[age %in% c(3, 6, 9, 12, 24, 36)]) + 
  geom_line(aes(ei, prob, group = age )) +
  geom_line(aes(ei, prob_model, group = age ), color = 'red') + 
  scale_color_custom('mixed') + facet_wrap(~age)

ggplot(df_grid[ei %in% c(-200, -100, 0, 50, 100, 200)]) + 
  geom_line(aes(age, prob, group = ei )) +
  geom_line(aes(age, prob_model, group = ei ), color = 'red') + 
  scale_color_custom('mixed') + facet_wrap(~ei)

```


#Additive Logistic regression

```{r additive_logistic_regression}

t_index_v = sample.int(nrow(df), 1e6)

add_splines <- function(df, vname, spline_knots, prefix = 'sp_'){
  
  nk = length(spline_knots)
  x_splined = bs(df[[vname]], knots = spline_knots, degree = 1)
  x_splined[,nk] = x_splined[,nk] + x_splined[,nk + 1]
  spline_names = make.names(stri_join(prefix, vname, '_', spline_knots[2:nk]))
  
  df[, (spline_names) := lapply(seq(2, nk), function(i) x_splined[,i])  ]
  return (TRUE)
}

get_vars <- function(all_names, pattern){
  all_names[grepl(pattern, all_names)]
}

#plot_act_vs_model2(df, 'upb', bucket_count = 100)

#create splines
#df[,(get_vars(names(df), 'sp_LOAN_AGE')):=NULL]
#df[,(get_vars(names(df), 'sp_turn_ei')):=NULL]
#df[,(get_vars(names(df), 'sp_turn_CSCORE_B')):=NULL]

df[, CSCORE:=CSCORE_B]
df[is.na(CSCORE), CSCORE:=700]

add_splines(df, 'LOAN_AGE', spline_knots = c(3,    6,   12,   24,  36), prefix = 'sp_turn_')
add_splines(df, 'ei', spline_knots = c(-100, -50,  0), prefix = 'sp_turn_')
add_splines(df, 'CSCORE', spline_knots = c(640, 760, 800), prefix = 'sp_turn_')
ggplot(df[sample.int(nrow(df), 1000)], aes(LOAN_AGE, sp_turn_LOAN_AGE_6)) + geom_line()
ggplot(df[sample.int(nrow(df), 1000)], aes(CSCORE, sp_turn_CSCORE_760)) + geom_line()
ggplot(df[sample.int(nrow(df), 1000)], aes(CSCORE, sp_turn_CSCORE_800)) + geom_line()

#create vars
turn.vars = c('season_s', 'OCC_STAT', 'no_cscore',  get_vars(names(df), 'sp_turn_LOAN_AGE'), get_vars(names(df), 'sp_turn_ei'),  get_vars(names(df), 'sp_turn_CSCORE') )
turn.formula = as.formula(stri_join('po_ind ~ ', stri_join(turn.vars, collapse = '+')))

#turnover
model.turn = glm(turn.formula, data = df[ei<0], family = binomial(link = "logit") )
summary(model.turn)

df[, model_smm := predict(model.turn, .SD, type = 'response')]
#plot_act_vs_model2(df[ei<0], 'date', bucket_count = 100)
#plot_act_vs_model2(df[ei<0], 'LOAN_AGE', bucket_count = 100)
#plot_act_vs_model2(df[ei<0], 'ei', bucket_count = 10)
plot_act_vs_model2(df[ei<0], 'CSCORE', bucket_count = 20)

my_vars = unique(c('ei', 'LOAN_AGE', 'season_s',  'upb', 'PURPOSE', 'OCC_STAT', 'CHANNEL','PROP', 'CSCORE_B',  'CLTV', 'OLTV',  'cum_ei','cum_eim', 'media_ei_lin','media_ei_log', 'hpa', 'hpa_life', 'hpi_1m36','hpi_1m60', 'CURR_RATE','MI_PCT',
            'uer', 'uer_1m36', 'uer_1m60', 'uer_3m36',  'factor','DTI','no_cscore', 'sato', 'house_value', 'NO_UNITS', 'no_cscore', 'NUM_BO', 'orig_year', 'ei_ratio', 'vintage', 'ORIG_UPB'))
plots = llply(my_vars, function(my_var){
  plot_act_vs_model2(df[ei<0], my_var, bucket_count = 10) + ggtitle(my_var)
})
marrangeGrob(plots, nrow = 6, ncol = 6, top = NULL)


#df[,(get_vars(names(df), 'sp_refi_cum_ei')):=NULL]
add_splines(df, 'LOAN_AGE',spline_knots = c(3,    6,   12),     prefix = 'sp_refi_')
add_splines(df, 'ei',      spline_knots = c(0, 50, 100, 150),  prefix = 'sp_refi_')
add_splines(df, 'cum_ei',  spline_knots = c(10, 20, 60),            prefix = 'sp_refi_')
add_splines(df, 'upb',    spline_knots = c(50, 100, 200, 400),            prefix = 'sp_refi_')

#p_index = sample.int(nrow(df), 1000)
#ggplot(df[p_index], aes(cum_ei, sp_refi_cum_ei_10 )) + geom_line()
#ggplot(df[p_index][LOAN_AGE<24], aes(cum_ei, LOAN_AGE )) + geom_point()

df[, turn_smm := predict(model.turn, .SD, type = 'response')]
df[, po_refi := po_ind * (1-turn_smm) ]

refi.vars = c(get_vars(names(df), 'sp_refi_'))
refi.formula = as.formula(stri_join('po_refi ~ ', stri_join(refi.vars, collapse = '+')))

#model.refi = glm(refi.formula, data = df[t_index_v], family = binomial(link = "logit"), offset =  turn.offset[t_index_v])
model.refi = glm(refi.formula, data = df, family = binomial(link = "logit"))
summary(model.refi)

df[, refi_smm := predict(model.refi, .SD, type = 'response')]
df[, model_smm := turn_smm + (1-turn_smm) * refi_smm ]

#df[, model_smm := logistic(turn.offset)]

plot_act_vs_model2(df, 'date', bucket_count = 20)
plot_act_vs_model2(df, 'ei', bucket_count = 20)
plot_act_vs_model2(df[ei<0], 'LOAN_AGE', bucket_count = 20)
plot_act_vs_model2(df, 'LOAN_AGE', bucket_count = 20)
plot_act_vs_model2(df, 'cum_ei', bucket_count = 20)
plot_act_vs_model2(df, 'upb', bucket_count = 20)

plot_binmodel_percentiles(df$po_ind, df$model_smm, 10)
#plot_binmodel_roc(df$po_ind, df$model_smm)
#plot_binmodel_predictions(df$po_ind, df$model_smm)

#VS date
df_pd = ldply(seq(-200, 200, by = 50), function(ei_in){ 
  df_pd = ldply(sort(unique(df$date))[1:36], function(my_date){ 
    a = df[30,]
    a[, season_s:=sprintf('%02d', month(my_date))]
    a[, date:=my_date]
    a[, ei:=ei_in]
    return (a) })
  return (df_pd)
})
setDT(df_pd)

add_splines(df_pd, 'LOAN_AGE', spline_knots = c(3,    6,   12,   24,  36), prefix = 'sp_turn_')
add_splines(df_pd, 'ei', spline_knots = c(-100, -50,  0), prefix = 'sp_turn_')
add_splines(df_pd, 'CSCORE', spline_knots = c(640, 760, 800), prefix = 'sp_turn_')
add_splines(df_pd, 'LOAN_AGE',spline_knots = c(3,    6,   12),     prefix = 'sp_refi_')
add_splines(df_pd, 'ei',      spline_knots = c(0, 50, 100, 150),  prefix = 'sp_refi_')
add_splines(df_pd, 'cum_ei',  spline_knots = c(10, 20, 60),            prefix = 'sp_refi_')
add_splines(df_pd, 'upb',    spline_knots = c(50, 100, 200, 400),            prefix = 'sp_refi_')


df_pd[, turn_logodds := predict(model.turn, .SD, type = 'link')]
df_pd[, model_smm := predict(model.refi, newdata  = .SD, type = 'response')]

ggplot(df_pd, aes(date, smm2cpr(model_smm), group = ei, color = factor(ei) )) + geom_line() + geom_point() + scale_color_custom('mixed') #+ geom_line(aes(ei, model_smm * scurve(ei, 1.0, 1.2, 100, 50)))

```


#Revelant Sampling

```{r relevant_sampling}

df_rel = df[date %in% as.Date(c('2015-01-01', '2020-01-01')) ]

ggplot(df_rel, aes(upb, group = date, color = factor(date))) + geom_density(adjust = 0.5)
ggplot(df_rel, aes(CLTV, group = date, color = factor(date))) + geom_density(adjust = 1.0)
ggplot(df_rel, aes(CSCORE_B, group = date, color = factor(date))) + geom_density(adjust = 0.5)
ggplot(df_rel, aes(DTI, group = date, color = factor(date))) + geom_density(adjust = 0.5)
ggplot(df_rel, aes(LOAN_AGE, group = date, color = factor(date))) + geom_density(adjust = 0.5)
ggplot(df_rel, aes(PURPOSE, group = date, fill = factor(date))) + geom_histogram( stat="count", position = 'dodge')
ggplot(df_rel, aes(CHANNEL, group = date, fill = factor(date))) + geom_histogram( stat="count", position = 'dodge')
ggplot(df_rel, aes(OCC_STAT, group = date, fill = factor(date))) + geom_histogram( stat="count", position = 'dodge')
ggplot(df_rel, aes(STATE, group = date, fill = factor(date))) + geom_histogram( stat="count", position = 'dodge')



# create classification model 
library(lightgbm)

set.seed(1321)

df_rel[, cp_flag:=as.numeric(date == max(date))]

t_index_v = sample.int(nrow(df_rel), 0.5*nrow(df_rel))
v_index_v = seq(nrow(df_rel)) %!in_set% t_index_v

obj_var = 'cp_flag'
lgb_vars = c('upb', 'CLTV', 'CSCORE_B', 'DTI', 'PURPOSE', 'CHANNEL', 'OCC_STAT', 'PROP') %!in_set% c('id')

my_cat_vars =  names(which(sapply(df_rel[,lgb_vars, with = FALSE], function(x) is.factor(x) | is.character(x) )))

### - logistic regression for loss > 0 -----------
dfs = df_rel[t_index_v, c(obj_var,lgb_vars), with = FALSE]

dtrain <- lgb.Dataset(                     data.matrix(dfs[, lgb_vars , with = FALSE]), label = dfs[[obj_var]], categorical_feature = my_cat_vars)
dtest  <- lgb.Dataset.create.valid(dtrain, data.matrix(df_rel[v_index_v, lgb_vars , with = FALSE]), label = df_rel$cp_flag[v_index_v])

params_bin <- list(objective = "binary")

model.lgb = lgb.train(params = params_bin, data = dtrain, learning_rate = 0.01,
                      valids = list(test = dtest),
                      num_threads = 4, nrounds = 3000,
                      eval_freq = 100, boost_from_average = TRUE, verbose = 1, force_row_wise = TRUE)

cv_error = as.numeric(model.lgb$record_evals$test$binary_logloss$eval)
ggplot(data.frame( i = seq(length(cv_error)), cv_error ), aes(i, cv_error)) + geom_line() + geom_vline(xintercept = model.lgb$best_iter, linetype = 'dashed')

lgb_importance = lgb.importance(model.lgb, percentage = TRUE)
ggplot(lgb_importance[Gain > 0.001], aes(fct_reorder(Feature,Gain), Gain)) + geom_bar(stat = 'identity') + coord_flip()
 
df_rel[, cp_flag_pred := predict(model.lgb, data.matrix(df_rel[,lgb_vars, with = F]))]
df_rel[, cp_weight := (cp_flag_pred + 0.05) / (1 - cp_flag_pred + 0.05)]
df_rel[date == max(date), cp_weight:=1] 

plot_binmodel_density(df_rel$cp_flag, df_rel$cp_flag_pred)
plot_binmodel_cdf(df_rel$cp_flag, df_rel$cp_flag_pred)
plot_binmodel_roc(df_rel$cp_flag, df_rel$cp_flag_pred)

plot_profile(df_rel$cp_flag_pred, df_rel$cp_flag, df_rel$CLTV)

ggplot(df_rel, aes(cp_weight)) + geom_density()

ggplot(df_rel) + 
  geom_density(aes(CLTV, group = date, color = factor(date), weight = NULL), color = 'black') + 
  geom_density(aes(CLTV, group = date, color = factor(date), weight = cp_weight))


res = ldply(sort(df[date>='2012-01-01' & date < '2020-01-01' & month(date) == 1, unique(date)]), function(my_date){
  
  print(my_date)
  
  set.seed(1321)
  
  df_rel = df[date %in% as.Date(c(my_date, '2020-01-01')) ]
    
  df_rel[, cp_flag:=as.numeric(date == max(date))]
  
  t_index_v = sample.int(nrow(df_rel), 0.5*nrow(df_rel))
  v_index_v = seq(nrow(df_rel)) %!in_set% t_index_v
  
  obj_var = 'cp_flag'
  lgb_vars = c('upb', 'CLTV', 'CSCORE_B', 'DTI', 'PURPOSE', 'CHANNEL', 'OCC_STAT', 'PROP') %!in_set% c('id')
  
  my_cat_vars =  names(which(sapply(df_rel[,lgb_vars, with = FALSE], function(x) is.factor(x) | is.character(x) )))
  
  ### - logistic regression for loss > 0 -----------
  dfs = df_rel[t_index_v, c(obj_var,lgb_vars), with = FALSE]
  
  dtrain <- lgb.Dataset(                     data.matrix(dfs[, lgb_vars , with = FALSE]), label = dfs[[obj_var]], categorical_feature = my_cat_vars)
  dtest  <- lgb.Dataset.create.valid(dtrain, data.matrix(df_rel[v_index_v, lgb_vars , with = FALSE]), label = df_rel$cp_flag[v_index_v])
  
  params_bin <- list(objective = "binary")
  
  model.lgb = lgb.train(params = params_bin, data = dtrain, learning_rate = 0.01,
                        valids = list(test = dtest),
                        num_threads = 4, nrounds = 3000,
                        eval_freq = 100, boost_from_average = TRUE, verbose = 0, force_row_wise = TRUE)
  
  df_rel[, cp_flag_pred := predict(model.lgb, data.matrix(df_rel[,lgb_vars, with = F]))]
  df_rel[, cp_weight := (cp_flag_pred + 0.01) / (1 - cp_flag_pred + 0.01)]
  df_rel[date == max(date), cp_weight:=1] 


  
  lgb_importance = lgb.importance(model.lgb, percentage = TRUE)
  setDT(lgb_importance)
  lgb_importance[, date:= my_date]
  lgb_importance[, ks := binmodel_ks(df_rel$cp_flag, df_rel$cp_flag_pred)]
  lgb_importance[, n1 := df_rel[date == my_date, .N]]
  lgb_importance[, n2 := df_rel[date != my_date, .N]]
  lgb_importance[, n1_eff := df_rel[date == my_date, effective_size(cp_weight) ] ]
  lgb_importance[, best_iter := model.lgb$best_iter]
  
  return (lgb_importance)
})

ggplot(res, aes(date, Gain, group = Feature, color = Feature)) + geom_line() + geom_point()
ggplot(res, aes(date, Gain, group = Feature, fill = Feature)) + geom_area() + scale_fill_custom('mixed')
ggplot(res, aes(date, n1_eff/n1, group = Feature)) + geom_line() + geom_point()

```

