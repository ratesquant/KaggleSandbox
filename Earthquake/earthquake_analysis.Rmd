---
title: "Earthquake"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE, fig.width = 8, fig.height = 5, dpi = 240)
options(warn=-1)

library(plyr)
library(data.table)
library(ggplot2)

library(WaveletComp)
#working_folder = 'C:/Dev/Kaggle/'
working_folder = 'F:/Github/KaggleSandbox/'
#working_folder = file.path(Sys.getenv("HOME"), 'source/github/KaggleSandbox/')

source(file.path(working_folder, '/Utils/common.R'))

```

## Loan Data
6'291'454 * 100
```{r loan_model}
# read the file -----------
# time_to_failure changes every 4000 observations
df = fread(file.path(working_folder,'Earthquake/data/train_100.csv'),nrows = 2^23)
df[,t:=seq(nrow(df))]
#df[,freq:=fft(acoustic_data)]

gc(reset=TRUE)

1e-6*nrow(df)

p1 = ggplot(df[1:80000,], aes(t, acoustic_data)) + geom_line()
p2 = ggplot(df[1:80000,], aes(t, time_to_failure)) + geom_line() 
gridExtra::grid.arrange(p1, p2)

p1 = ggplot(df[seq(1, nrow(df), 100),], aes(t, acoustic_data)) + geom_line()
p2 = ggplot(df[seq(1, nrow(df), 100),], aes(t, time_to_failure)) + geom_line() 
gridExtra::grid.arrange(p1, p2)

library(dplR)
wave.out <- morlet(y1 = df$acoustic_data[1:10000])#, p2 = 8, dj = 0.1, siglvl = 0.95)
# p2=6 <=> estimate out to 2^8 = 256 months dj <=> controls the frequency
# resolution hack the period estimate to be in years, not months
levs <- quantile(wave.out$Power, c(0, 0.25, 0.5, 0.75, 0.95, 1))
wavelet.plot(wave.out, wavelet.levels = levs, crn.ylim = c(22.5, 30))
```

## wavelet
```{r wavelet_analysis}
my.w <- analyze.wavelet(df_test, "acoustic_data",
loess.span = 0,
dt = 1, dj = 1/250,
lowerPeriod = 16,
upperPeriod = 128,
make.pval = TRUE, n.sim = 10)

wt.image(my.w, color.key = "quantile", n.levels = 250,
legend.params = list(lab = "wavelet power levels", mar = 4.7))
```

## Test Data 
size is 150000 (37)
```{r test_data, echo=FALSE}

test_files = list.files(file.path(working_folder,'Earthquake/data/test'), pattern = '*.csv', full.names = TRUE)

df_test = fread(test_files[1])
ggplot(df_test, aes(seq(nrow(df_test)), acoustic_data)) + geom_line()
```
