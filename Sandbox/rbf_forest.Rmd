---
title: "RBF Forest"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(data.table)
library(proxy)
library(MASS)
library(ggplot2)
library(plyr)
library(dplyr)
library(stringi)


working_folder = 'D:/Github/KaggleSandbox'

source(file.path(working_folder, 'Utils/common.R'))
source(file.path(working_folder, 'Utils/rbf_utils.R'))

rms <-function(y1, y2) sqrt( mean( (y1 - y2)^2 ))

```

## Test

```{r test}
x = seq(0, 1, by = 0.01)
y = 0.2 + 0.4 * x * x + 0.3 *x * sin(15 * x) + 0.05 * cos(50 * x)

df = data.table(x, y)

model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun = rbf_linear_kernel)
#model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun = rbf_tp_kernel)
#model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun = rbf_cauchy_kernel)
#model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun = rbf_cubic_kernel)
#model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun = function(x) rbf_imquad_kernel(x*10))
#model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun = function(x) rbf_mquad_kernel(x*10))
#model.rbf = rbf.create(df[,.(x)], df$y, as.matrix(c(0.5, 0.1, 0.7)), kernel_fun =function(x) rbf_bump_kernel(10*x))

y_pred = rbf.predict(model.rbf, df[,.(x)])

ggplot(cbind(df, y_pred), aes(x, y)) + geom_point() + geom_line(aes(x, y_pred), color = 'red')

```


## RBF Boot

```{r rbf_boot}
x = seq(0, 1, by = 0.01)
y = 0.2 + 0.4 * x * x + 0.3 *x * sin(15 * x) + 0.05 * cos(50 * x)
df = data.table(x, y)
df[, id:=seq(nrow(df))]

max_nodes = 20

models = rbf_boot.create(df[,.(x)], df$y, max_nodes, n_runs = 100, kernel_fun = rbf_linear_kernel)
#models = rbf_boot.create(df[,.(x)], df$y, max_nodes, n_runs = 100, kernel_fun = rbf_tp_kernel)
res = rbf_boot.predict(models, df[,.(x)])
setDT(res)
res_agg = res[, .(y_pred = mean(y_pred), sigma = sd(y_pred), .N ), by =.(id)]

res_agg[df, y := i.y, on=.(id) ]
res_agg[df, x := i.x, on=.(id) ]
res[df, x := i.x, on=.(id) ]

#all fits
ggplot(res, aes(x, y_pred, group = run_id)) + geom_line(color = 'blue', alpha = 0.2) 

#average
ggplot(res_agg, aes(x, y)) + geom_point() + geom_line(aes(x, y_pred), color = 'red', size = 1) + 
  geom_ribbon(aes(x, ymin = y_pred - 2*sigma, ymax = y_pred + 2*sigma), alpha = 0.2, fill = 'blue')

#convergence
res[order(run_id),y_pred_cum := cummean(y_pred), by =.(id) ]
ggplot(res, aes(x, y_pred_cum, group = run_id)) + geom_line(color = 'blue', alpha = 0.2) 

it_error = res[order(id), .(error = rms(df$y, y_pred_cum)), by =.(run_id) ] #it_error[error == min(error)]
ggplot(it_error, aes(run_id, error)) + geom_line()

```

## RBF Timing
                       Estimate Std. Error t value Pr(>|t|)    
(Intercept)              -2.664e-01  9.741e-02  -2.735   0.0153 *  
I(max_nodes * max_nodes)  9.883e-05  1.038e-05   9.520 9.50e-08 ***
runs                      3.217e-03  4.335e-04   7.423 2.14e-06 ***

```{r rbf_timing}
run_cases = expand.grid(n_nodes = c(10, 20, 30, 40, 50, 100), boot_samples = c(100, 200, 300))

timing_res = ldply(seq(nrow(run_cases)), function(i){
  
 start_time = Sys.time()
 models = rbf_boot.create(df[,.(x)], df$y, n_nodes = run_cases$n_nodes[i], n_runs = run_cases$boot_samples[i], kernel_fun =rbf_linear_kernel)
 
 data.frame(i, elapsed = as.numeric(Sys.time() - start_time), n_nodes = run_cases$n_nodes[i],  runs = run_cases$boot_samples[i])
})

ggplot(timing_res, aes(n_nodes, elapsed)) + geom_line() + facet_wrap(~runs)

summary(lm(elapsed  ~ I(n_nodes * n_nodes) + runs, timing_res))
```

## RBF Boosting

```{r rbf_boosting}
x = seq(0, 1, by = 0.01)
y = 0.2 + 0.4 * x * x + 0.3 *x * sin(15 * x) + 0.05 * cos(50 * x)
df = data.table(x, y)
df[, id:=seq(nrow(df))]

max_nodes = 65

models_boost =  rbf_boost.create(df[,.(x)],  df$y, max_nodes, n_runs = 100,  growth_rate =1.5, kernel_fun =rbf_linear_kernel)
res = rbf_boost.predict(models_boost, df[,.(x)], combine_boots = FALSE)

setDT(res)
 
#show all - curves
res[df, x := i.x, on=.(id) ]
ggplot(res, aes(x, y_pred, group = model_id2 )) + geom_line(alpha = 0.3) + facet_wrap(~model_id1 )

#boost results for each step
res_sum = res[, .(y_pred = mean(y_pred)), by =.(id, model_id1 )]
res_sum[df, x := i.x, on=.(id) ]
ggplot(res_sum, aes(x, y_pred, group = model_id1 )) + geom_line()  + facet_wrap(~model_id1 )

#boost results for each step
res_conv = res[, .(y_pred = mean(y_pred)), by =.(id, model_id1 )]
res_conv[order(model_id1), y_pred_cum := cumsum(y_pred), by =.(id)]
res_conv[df, x := i.x, on=.(id) ]
ggplot(res_conv, aes(x, y_pred_cum)) + geom_line(color = 'red', size = 1)  + geom_point(data = df, aes(x, y)) + facet_wrap(~model_id1 )

#Convergence
ggplot(res_conv[order(id), .(error = rms(y_pred_cum, df$y)), by =.(model_id1) ] , aes(model_id1, error)) + geom_line() +  geom_point()

# CV ---------
cv_res = rbf_boost.create_cv(df[,.(x)],  df$y, max_nodes = 100, n_runs = 10, max_it = 20, growth_rate =2.0, nfolds = 10, kernel_fun = rbf_linear_kernel, dist_fun = 'L1' )
df_cv_res = data.table(it = seq(nrow(cv_res)), avg = apply(cv_res, 1, mean ), sigma = apply(cv_res, 1, sd ), cv_res )
ggplot(df_cv_res, aes(it, avg)) + geom_line() + geom_ribbon(aes(it, ymin = avg - sigma, ymax = avg + sigma), alpha = 0.2, fill = 'blue')
```

## RBF with Noise

```{r rbf_boosting}
x = seq(0, 1, by = 0.001)
y = 0.2 + 0.4 * x * x + 0.3 *x * sin(15 * x) + 0.05 * cos(50 * x)
df = data.table(x, yt = y, y = y + 0.1*rnorm(length(y)))
df[, id:=seq(nrow(df))]

ggplot(df, aes(x, y)) + geom_point() + geom_line(aes(x, yt), color = 'red', size = 1)

# CV
cv_res = rbf_boost.create_cv(df[,.(x)],  df$y, max_nodes = 100, n_runs = 30, max_it = 20, growth_rate = 2.0, nfolds = 10, kernel_fun = rbf_linear_kernel, dist_fun = 'L1' )
df_cv_res = data.table(it = seq(nrow(cv_res)), avg = apply(cv_res, 1, mean ), sigma = apply(cv_res, 1, sd ), cv_res )
ggplot(df_cv_res[avg>0], aes(it, avg)) + geom_line() + geom_ribbon(aes(it, ymin = avg - sigma, ymax = avg + sigma), alpha = 0.2, fill = 'blue') + 
  geom_hline(yintercept = 0.1, color = 'red', linetype = 'dashed')

df_cv_res[avg == min(avg)]#0.102632 

# build model
models_boost =  rbf_boost.create(df[,.(x)],  df$y,  max_nodes = 20, n_runs = 30, max_it = 20, growth_rate =2, kernel_fun = rbf_linear_kernel, dist_fun = 'L1' )
res = rbf_boost.predict(models_boost, df[,.(x)], combine_boots = FALSE)
setDT(res)
 
#show all - curves
res[df, x := i.x, on=.(id) ]
ggplot(res, aes(x, y_pred, group = model_id2 )) + geom_line(alpha = 0.3) + facet_wrap(~model_id1 )

#boost results for each step
res_sum = res[, .(y_pred = mean(y_pred)), by =.(id, model_id1 )]
res_sum[df, x := i.x, on=.(id) ]
ggplot(res_sum, aes(x, y_pred, group = model_id1 )) + geom_line()  + facet_wrap(~model_id1 )

#boost results for each step
res_conv = res[, .(y_pred = mean(y_pred)), by =.(id, model_id1 )]
res_conv[order(model_id1), y_pred_cum := cumsum(y_pred), by =.(id)]
res_conv[df, x := i.x, on=.(id) ]
ggplot(res_conv, aes(x, y_pred_cum)) + geom_line(color = 'red', size = 1)  +
  geom_point(data = df, aes(x, y), alpha = 0.1, size = 0.1) + 
  geom_line(data = df, aes(x, yt))  + facet_wrap(~model_id1 )

ggplot(res_conv[model_id1 == 12], aes(x, y_pred_cum)) + geom_line(color = 'red', size = 1)  +
  geom_point(data = df, aes(x, y), alpha = 0.1, size = 0.1) + 
  geom_line(data = df, aes(x, yt))  + facet_wrap(~model_id1 )

rms(df$yt, res_conv[model_id1 == 12]$y_pred_cum)


## ------------- Boot model with the same number of nodes
models = rbf_boot.create(df[,.(x)], df$y, max_nodes = 31, n_runs = 1000, kernel_fun = rbf_linear_kernel)
res = rbf_boot.predict(models, df[,.(x)])
setDT(res)

res_agg = res[, .(y_pred = mean(y_pred), sigma = sd(y_pred), .N ), by =.(id)]
res_agg[df, x := i.x, on=.(id) ]

#average
ggplot(df, aes(x, yt)) + geom_line() + geom_line(data = res_agg, aes(x, y_pred), color = 'red', size = 1) + 
  geom_ribbon(data = res_agg, aes(x, ymin = y_pred - 2*sigma, ymax = y_pred + 2*sigma), alpha = 0.2, fill = 'blue', inherit.aes = FALSE)

rms(df$yt, res_agg$y_pred)
rms(df$y, res_agg$y_pred)

ggplot(res_agg, aes(x, y)) + geom_point() + geom_line(aes(x, y_pred), color = 'red', size = 1) + 
  geom_ribbon(aes(x, ymin = y_pred - 2*sigma, ymax = y_pred + 2*sigma), alpha = 0.2, fill = 'blue')

#convergence
res[order(run_id),y_pred_cum := cummean(y_pred), by =.(id) ]

it_error = res[order(id), .(error = rms(df$y, y_pred_cum)), by =.(run_id) ] #it_error[error == min(error)]
ggplot(it_error, aes(run_id, error)) + geom_line() + geom_hline(yintercept = 0.1, color = 'red', linetype = 'dashed')

## ------------- Boot CV
run_cases = expand.grid(nodes = seq(10, 60), runs = c(100, 200, 300, 1000), nfolds = c(2, 3, 4, 5, 6, 7, 8, 9, 10, 20))
cv_res = ldply(seq(nrow(run_cases)), function(run_id){
  cv_res = rbf_boot.create_cv(df[,.(x)], df$y, max_nodes = run_cases$nodes[run_id], boot_runs = run_cases$runs[run_id], nfolds =run_cases$nfolds[run_id],  
                              kernel_params = 1.0, kernel_fun = function(x, c) x, dist_fun = 'L1' )
  data.frame(cv_error = mean(cv_res), max_nodes = run_cases$nodes[run_id], boot_runs = run_cases$runs[run_id], nfolds =run_cases$nfolds[run_id])
})

ggplot(cv_res, aes(max_nodes, cv_error, group = nfolds, color = factor(nfolds) )) + geom_point() +  geom_line() + geom_smooth(se = FALSE, color = 'black') + facet_grid(nfolds~boot_runs) +
   geom_hline(yintercept = 0.1, color = 'red', linetype = 'dashed')
```

## RBF Boosting: Large Scale Test

```{r rbf_boosting_test}

train <- fread(file.path(working_folder,'Playground/Feb2021/data/train.csv'), check.names = TRUE)
test  <- fread(file.path(working_folder,'Playground/Feb2021/data/test.csv'),  check.names = TRUE) # 1459   80
test[, target:=NA]
df = rbind(train, test)

gc(reset=TRUE)

test_index = is.na(df$target)
train_index = !test_index

obj_var = 'target'
all_vars = names(df) %!in_set% c('id', obj_var) #14 variables
all_vars = all_vars[grep('^(cont|cat)', all_vars)]
cat_vars = all_vars[grep('^(cat)', all_vars)]
con_vars = all_vars[grep('^(cont)', all_vars)]

## ------------- Boot CV ------
convert_to_prob <-function(x, train_index){
  if(is.character(x) )x = as.numeric(as.factor(x))
  ecdf(x[train_index])(x)
}
p_vars = stri_join('p_', all_vars)
df[, (p_vars):=lapply(.SD, function(x) convert_to_prob(x, train_index)), .SDcols = all_vars]


my_index = sample( which(train_index), 1.0*sum(train_index))
run_cases = expand.grid(nodes = c(700, 800, 900), runs = c(10, 20), dist_fun = c('L1'), stringsAsFactors = FALSE )

#%% bootsrap runs ----------------
#10 runs with 500 nodes - 4 min

dfs = data.matrix(df[my_index,p_vars, with = FALSE])
target = df$target[my_index]

cv_res = ldply(seq(nrow(run_cases)), function(run_id){
  cv_res = rbf_boot.create_cv(dfs, target, n_nodes = run_cases$nodes[run_id], n_runs = run_cases$runs[run_id], nfolds = 7, kernel_fun = rbf_linear_kernel, dist_fun = run_cases$dist_fun[run_id] )
  data.frame(cv_error = mean(cv_res), cv_sigma = sd(cv_res), n_nodes = run_cases$nodes[run_id], n_runs = run_cases$runs[run_id], dist_fun = run_cases$dist_fun[run_id])
})
setDT(cv_res)

#rbf_boot.create_cv(dfs, target, n_nodes = 1000, n_runs = 10, nfolds = 5, kernel_fun = rbf_linear_kernel, dist_fun = 'L1')

#source(file.path(working_folder, 'Utils/rbf_utils.R'))
ggplot(cv_res, aes(n_nodes, cv_error, group = n_runs, color = factor(n_runs) )) + geom_point() +  geom_line() # + facet_wrap(~dist_fun)# + geom_smooth(se = FALSE, color = 'black') + 
   geom_hline(yintercept = 0.84164, color = 'red', linetype = 'dashed')


#cv error: 0.8510029
#target: 0.84309
min(cv_res$cv_error) #0.8533613


#%% boost runs ----------------
models_boost =  rbf_boost.create(dfs, target, max_nodes = 6000, n_runs = 20, max_it = 20, growth_rate = 2.0, kernel_fun = rbf_linear_kernel, dist_fun = 'L1' )
res = rbf_boost.predict(models_boost, dfs, combine_boots = TRUE)
setDT(res)
ggplot(res[order(id), .(error = rms(y_pred_cum, df$target[my_index])), by =.(model_id1) ] , aes(model_id1, error)) + geom_line() +  geom_point()

#boost results for each step, run with combine_boots = FALSE
#res_conv = res[, .(y_pred = mean(y_pred)), by =.(id, model_id1 )]
#res_conv[order(model_id1), y_pred_cum := cumsum(y_pred), by =.(id)]
#ggplot(res_conv[order(id), .(error = rms(y_pred_cum, df$target[my_index])), by =.(model_id1) ] , aes(model_id1, error)) + geom_line() +  geom_point()


# CV ---------
cv_res = rbf_boost.create_cv(dfs, target, max_nodes = 1024, n_runs = 20, max_it = 20, nfolds = 10, kernel_fun = rbf_linear_kernel, dist_fun = 'L1' )
df_cv_res = data.table(it = seq(nrow(cv_res)), avg = apply(cv_res, 1, mean ), sigma = apply(cv_res, 1, sd ), cv_res )
ggplot(df_cv_res[avg>0], aes(it, avg)) + geom_line() + geom_ribbon(aes(it, ymin = avg - sigma, ymax = avg + sigma), alpha = 0.2, fill = 'blue')
```


